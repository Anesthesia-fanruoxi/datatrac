# æ•°æ®äº¤æ¢æ¡†æ¶è®¾è®¡ (Reader-Transformer-Writer)

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£å®šä¹‰äº† DataTrac çš„æ ¸å¿ƒåº•åº§â€”â€”æ•°æ®äº¤æ¢æ¡†æ¶ã€‚é€šè¿‡æŠ½è±¡ Readerï¼ˆè¯»ï¼‰ã€Transformerï¼ˆè½¬ï¼‰ã€Writerï¼ˆå†™ï¼‰ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œå®ç°è·¨å¼‚æ„æ•°æ®æºçš„è‡ªç”±ä¼ è¾“ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-30  
**çŠ¶æ€**: åˆç¨¿å®Œæˆ

---

## ğŸ¯ è®¾è®¡ç†å¿µ

ä¸ºäº†å®ç°â€œå®Œç¾ä¸”å¼ºå¤§çš„åº•åº§â€ï¼Œæ¡†æ¶éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
1. **æ’ä»¶åŒ– (Pluggable)**: æ–°å¢æ•°æ®æºåªéœ€å®ç°å¯¹åº”çš„ Reader æˆ– Writerã€‚
2. **æ­£äº¤æ€§ (Orthogonality)**: è¯»é€»è¾‘ä¸å†™é€»è¾‘å®Œå…¨è§£è€¦ï¼Œé€šè¿‡æ ‡å‡†ä¸­é—´æ ¼å¼äº¤æ¢æ•°æ®ã€‚
3. **æµæ°´çº¿ (Pipeline)**: æ•°æ®ä»¥æµå¼ Batch çš„æ–¹å¼åœ¨ç»„ä»¶é—´ä¼ é€’ï¼Œæ”¯æŒèƒŒå‹å’Œå¹¶å‘ã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒæŠ½è±¡

### 1. æ ‡å‡†æ•°æ®è®°å½• (DataRecord)

æ‰€æœ‰æ•°æ®æºåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­éƒ½å¿…é¡»è½¬æ¢ä¸ºç»Ÿä¸€çš„ä¸­é—´æ ¼å¼ã€‚

```rust
pub enum FieldValue {
    Null,
    Boolean(bool),
    Integer(i64),
    Float(f64),
    Text(String),
    DateTime(chrono::DateTime<chrono::Utc>),
    Json(serde_json::Value), // å¤„ç†å¤æ‚å¯¹è±¡æˆ–æ•°ç»„
    Binary(Vec<u8>),
}

pub struct DataRecord {
    pub fields: HashMap<String, FieldValue>,
    pub metadata: HashMap<String, String>, // å­˜å‚¨å¦‚ä¸»é”® IDã€ç‰ˆæœ¬å·ç­‰è¾…åŠ©ä¿¡æ¯
}
```

### 2. æºè¯»å–å™¨ (SourceReader)

å®šä¹‰å¦‚ä½•ä»æºå¤´æå–æ•°æ®ã€‚

```rust
#[async_trait]
pub trait SourceReader: Send + Sync {
    /// åˆå§‹åŒ–è¿æ¥å’Œå‡†å¤‡å·¥ä½œ
    async fn open(&mut self) -> Result<()>;
    
    /// è·å–æ€»è®°å½•æ•°ï¼ˆç”¨äºè¿›åº¦æ¡ï¼‰
    async fn get_total_count(&self) -> Result<u64>;
    
    /// è¯»å–ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®
    async fn read_batch(&mut self, batch_size: usize) -> Result<Vec<DataRecord>>;
    
    /// æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
    fn has_next(&self) -> bool;
    
    /// é‡Šæ”¾èµ„æº
    async fn close(&mut self) -> Result<()>;
}
```

### 3. ç›®æ ‡å†™å…¥å™¨ (TargetWriter)

å®šä¹‰å¦‚ä½•å°†æ•°æ®å†™å…¥ç›®æ ‡ã€‚

```rust
#[async_trait]
pub trait TargetWriter: Send + Sync {
    /// åˆå§‹åŒ–è¿æ¥
    async fn open(&mut self) -> Result<()>;
    
    /// æ ¹æ®æºå…ƒæ•°æ®å‡†å¤‡ç›®æ ‡è¡¨ç»“æ„/ç´¢å¼• Mapping
    async fn prepare_target(&self, schema_info: &SchemaInfo) -> Result<()>;
    
    /// å†™å…¥ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®
    async fn write_batch(&mut self, batch: Vec<DataRecord>) -> Result<()>;
    
    /// æäº¤äº‹åŠ¡æˆ–åˆ·æ–°ç¼“å†²åŒº
    async fn commit(&mut self) -> Result<()>;
    
    /// é‡Šæ”¾èµ„æº
    async fn close(&mut self) -> Result<()>;
}
```

### 4. è½¬æ¢å™¨ (Transformer)

åœ¨è¯»å†™ä¹‹é—´å¤„ç†æ•°æ®ã€‚

```rust
pub trait Transformer: Send + Sync {
    /// è½¬æ¢å•æ¡è®°å½•ï¼ˆå­—æ®µæ”¹åã€ç±»å‹è½¬æ¢ã€è„±æ•ç­‰ï¼‰
    fn transform(&self, record: DataRecord) -> Result<DataRecord>;
}
```

---

## ğŸ”„ åŒæ­¥ç®¡é“ (SyncPipeline)

ç®¡é“æ˜¯åº•åº§çš„è¿è¡Œå®ä½“ï¼Œå®ƒè´Ÿè´£ç»„è£…å¹¶è¿è¡Œä¸Šè¿°ç»„ä»¶ã€‚

### ç®¡é“ç»“æ„
```rust
pub struct SyncPipeline {
    reader: Box<dyn SourceReader>,
    writer: Box<dyn TargetWriter>,
    transformers: Vec<Box<dyn Transformer>>,
    progress_monitor: Arc<ProgressMonitor>,
}
```

### è¿è¡Œé€»è¾‘
```
1. pipeline.open() -> Reader & Writer åˆå§‹åŒ–
2. pipeline.prepare() -> Writer æ ¹æ® Reader æä¾›çš„ Schema åˆ›å»ºç›®æ ‡ç¯å¢ƒ
3. while reader.has_next():
   a. batch = reader.read_batch(size)
   b. for t in transformers: batch = t.transform_all(batch)
   c. writer.write_batch(batch)
   d. progress_monitor.update(batch.len())
4. pipeline.close() -> é‡Šæ”¾æ‰€æœ‰èµ„æº
```

---

## ğŸš€ æ‰©å±•æ€§ç¤ºä¾‹

### å®ç° MySQL â†’ MySQL
- å®ç° `MySqlReader`: æ‰§è¡Œ `SELECT`ï¼Œå°† `sqlx::Row` è½¬ä¸º `DataRecord`ã€‚
- å®ç° `MySqlWriter`: æ‰§è¡Œ `INSERT INTO ...`ã€‚
- å¤ç”¨ `DefaultTransformer`: å¤„ç†åŸºæœ¬çš„åç§°æ˜ å°„ã€‚

### å®ç° MySQL â†’ MongoDB
- **å¤ç”¨** `MySqlReader`ã€‚
- å®ç° `MongoWriter`: å°† `DataRecord` è½¬ä¸º `BSON` å†™å…¥ã€‚
- **æ— éœ€æ”¹åŠ¨åº•åº§ä»£ç **ã€‚

### å®ç° MongoDB â†’ ES
- å®ç° `MongoReader`ã€‚
- å®ç° `ElasticWriter` (æˆ–å¤ç”¨å·²æœ‰)ã€‚
- **å³æ’å³ç”¨**ã€‚

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **å®šä¹‰æ ‡å‡† SchemaInfo ç»“æ„**: ç”¨äºåœ¨ Reader å’Œ Writer ä¹‹é—´ä¼ é€’å­—æ®µå®šä¹‰ã€‚
2. **å®ç°æ’ä»¶å·¥å‚ (PluginFactory)**: æ ¹æ®ä»»åŠ¡é…ç½®åŠ¨æ€å®ä¾‹åŒ–å¯¹åº”çš„ Reader å’Œ Writerã€‚
3. **é‡æ„ SyncEngine**: å°†ç¡¬ç¼–ç çš„åŒæ­¥å‡½æ•°æ›¿æ¢ä¸ºé€šç”¨çš„ Pipeline é©±åŠ¨ã€‚
