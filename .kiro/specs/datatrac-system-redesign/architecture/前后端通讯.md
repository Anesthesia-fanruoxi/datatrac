# å‰åç«¯é€šè®¯

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° DataTrac ç³»ç»Ÿçš„å‰åç«¯é€šè®¯æœºåˆ¶,åŸºäº Tauri IPCã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-30  
**é€šè®¯æ¡†æ¶**: Tauri 2.x IPC

---

## ğŸ¯ é€šè®¯æ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ (Vue 3 + TypeScript)                 â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API å±‚ (api/)                                        â”‚  â”‚
â”‚  â”‚  - å°è£… invoke() è°ƒç”¨                                 â”‚  â”‚
â”‚  â”‚  - å°è£… listen() ç›‘å¬                                 â”‚  â”‚
â”‚  â”‚  - ç±»å‹å®šä¹‰                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†• Tauri IPC
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
    Commands           Events            State
    (è¯·æ±‚-å“åº”)        (äº‹ä»¶æ¨é€)        (å…±äº«çŠ¶æ€)
        â”‚                  â”‚                  â”‚
        â†“                  â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯ (Rust + Tauri)                       â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Commands å±‚ (commands.rs)                            â”‚  â”‚
â”‚  â”‚  - #[tauri::command] å®                               â”‚  â”‚
â”‚  â”‚  - å‚æ•°éªŒè¯                                           â”‚  â”‚
â”‚  â”‚  - é”™è¯¯å¤„ç†                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Event Emitter (AppHandle)                            â”‚  â”‚
â”‚  â”‚  - emit() æ¨é€äº‹ä»¶                                    â”‚  â”‚
â”‚  â”‚  - è¿›åº¦æ›´æ–°                                           â”‚  â”‚
â”‚  â”‚  - æ—¥å¿—æ¨é€                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ é€šè®¯æ–¹å¼

### 1. Commands (è¯·æ±‚-å“åº”æ¨¡å¼)

**ç”¨é€”**: å‰ç«¯è°ƒç”¨åç«¯åŠŸèƒ½,ç­‰å¾…è¿”å›ç»“æœ

**æµç¨‹**:
```
å‰ç«¯ invoke(command, args) â†’ åç«¯æ‰§è¡Œ â†’ è¿”å›ç»“æœ â†’ å‰ç«¯æ¥æ”¶
```

**å‰ç«¯ç¤ºä¾‹**:
```typescript
// src/api/datasource.ts
import { invoke } from '@tauri-apps/api/core';

export const datasourceApi = {
  async list(): Promise<DataSource[]> {
    return await invoke('list_data_sources');
  },
  
  async create(data: CreateDataSourceRequest): Promise<DataSource> {
    return await invoke('create_data_source', { data });
  },
  
  async testConnection(id: string): Promise<void> {
    return await invoke('test_data_source_connection', { id });
  },
};
```

**åç«¯ç¤ºä¾‹**:
```rust
// src-tauri/src/commands.rs
#[tauri::command]
pub async fn list_data_sources(
    state: State<'_, AppState>,
) -> Result<Vec<DataSource>, String> {
    state.data_source_manager
        .list_data_sources()
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn create_data_source(
    data: CreateDataSourceRequest,
    state: State<'_, AppState>,
) -> Result<DataSource, String> {
    state.data_source_manager
        .create_data_source(data)
        .await
        .map_err(|e| e.to_string())
}
```

---

### 2. Events (äº‹ä»¶æ¨é€æ¨¡å¼)

**ç”¨é€”**: åç«¯ä¸»åŠ¨æ¨é€æ•°æ®åˆ°å‰ç«¯,ç”¨äºå®æ—¶æ›´æ–°

**æµç¨‹**:
```
åç«¯ emit(event, payload) â†’ å‰ç«¯ç›‘å¬å™¨æ¥æ”¶ â†’ æ›´æ–° UI
```

**åç«¯æ¨é€ç¤ºä¾‹**:
```rust
// src-tauri/src/progress.rs
impl ProgressMonitor {
    fn emit_progress(&self, task_id: &str) {
        if let Some(progress) = self.get_task_progress(task_id) {
            let _ = self.app_handle.emit("task-progress", progress);
        }
    }
    
    pub fn add_log(&self, task_id: &str, level: LogLevel, category: LogCategory, message: String) {
        let log_entry = LogEntry {
            timestamp: chrono::Utc::now().timestamp_millis(),
            level,
            category,
            message,
        };
        
        // æ¨é€æ—¥å¿—äº‹ä»¶
        let _ = self.app_handle.emit("task-log", TaskLogEvent {
            task_id: task_id.to_string(),
            log: log_entry,
        });
    }
}
```

**å‰ç«¯ç›‘å¬ç¤ºä¾‹**:
```typescript
// src/views/TaskMonitor/composables/useTaskMonitor.ts
import { listen } from '@tauri-apps/api/event';

export function useTaskMonitor(taskId: string) {
  const progress = ref<TaskProgress | null>(null);
  const logs = ref<LogEntry[]>([]);
  let unlistenProgress: (() => void) | null = null;
  let unlistenLog: (() => void) | null = null;
  
  async function startListening() {
    // ç›‘å¬è¿›åº¦æ›´æ–°
    unlistenProgress = await listen<TaskProgress>('task-progress', (event) => {
      if (event.payload.taskId === taskId) {
        progress.value = event.payload;
      }
    });
    
    // ç›‘å¬æ—¥å¿—æ¨é€
    unlistenLog = await listen<TaskLogEvent>('task-log', (event) => {
      if (event.payload.taskId === taskId) {
        logs.value.push(event.payload.log);
      }
    });
  }
  
  function stopListening() {
    if (unlistenProgress) {
      unlistenProgress();
      unlistenProgress = null;
    }
    if (unlistenLog) {
      unlistenLog();
      unlistenLog = null;
    }
  }
  
  onMounted(() => {
    startListening();
  });
  
  onUnmounted(() => {
    stopListening();
  });
  
  return { progress, logs };
}
```

---

### 3. State (å…±äº«çŠ¶æ€)

**ç”¨é€”**: åœ¨åç«¯ç»´æŠ¤å…¨å±€çŠ¶æ€,ä¾›å¤šä¸ª Command è®¿é—®

**åç«¯ç¤ºä¾‹**:
```rust
// src-tauri/src/lib.rs
pub struct AppState {
    pub data_source_manager: Arc<DataSourceManager>,
    pub sync_engine: Arc<SyncEngine>,
    pub progress_monitor: Arc<ProgressMonitor>,
    pub error_logger: Arc<ErrorLogger>,
}

#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run() {
    tauri::Builder::default()
        .setup(|app| {
            // åˆå§‹åŒ–çŠ¶æ€
            let storage = Arc::new(Storage::new(&db_path).await?);
            let crypto = Arc::new(Crypto::new()?);
            let data_source_manager = Arc::new(DataSourceManager::new(storage.clone(), crypto));
            let progress_monitor = Arc::new(ProgressMonitor::new(app.handle().clone()));
            let error_logger = Arc::new(ErrorLogger::new());
            let sync_engine = Arc::new(SyncEngine::new(
                data_source_manager.clone(),
                progress_monitor.clone(),
                error_logger.clone(),
            ));
            
            // æ³¨å†ŒçŠ¶æ€
            app.manage(AppState {
                data_source_manager,
                sync_engine,
                progress_monitor,
                error_logger,
            });
            
            Ok(())
        })
        .invoke_handler(tauri::generate_handler![
            list_data_sources,
            create_data_source,
            start_sync_task,
            // ... å…¶ä»– commands
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

**è®¿é—®çŠ¶æ€**:
```rust
#[tauri::command]
pub async fn some_command(
    state: State<'_, AppState>,
) -> Result<Data, String> {
    // è®¿é—®å…±äº«çŠ¶æ€
    state.data_source_manager.do_something().await?;
    state.sync_engine.do_something_else().await?;
    Ok(data)
}
```

---

## ğŸ“Š æ•°æ®åºåˆ—åŒ–

### å‘½åè§„èŒƒè½¬æ¢

**å‰ç«¯ (camelCase) â†” åç«¯ (snake_case)**

ä½¿ç”¨ serde è‡ªåŠ¨è½¬æ¢:

```rust
#[derive(Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct TaskProgress {
    pub task_id: String,           // â†’ taskId
    pub total_records: u64,        // â†’ totalRecords
    pub processed_records: u64,    // â†’ processedRecords
    pub percentage: f64,           // â†’ percentage
}
```

**å‰ç«¯æ¥æ”¶**:
```typescript
interface TaskProgress {
  taskId: string;
  totalRecords: number;
  processedRecords: number;
  percentage: number;
}
```

---

## ğŸ”§ é”™è¯¯å¤„ç†

### ç»Ÿä¸€é”™è¯¯æ ¼å¼

**åç«¯**:
```rust
#[tauri::command]
pub async fn some_command(
    state: State<'_, AppState>,
) -> Result<Data, String> {
    state.service
        .do_something()
        .await
        .map_err(|e| e.to_string())  // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
}
```

**å‰ç«¯**:
```typescript
try {
  const result = await invoke('some_command');
  // å¤„ç†æˆåŠŸ
} catch (error) {
  // error æ˜¯å­—ç¬¦ä¸²ç±»å‹
  console.error('æ“ä½œå¤±è´¥:', error);
  showError(error as string);
}
```

---

## ğŸ“¡ å®æ—¶é€šè®¯ç¤ºä¾‹

### ä»»åŠ¡è¿›åº¦ç›‘æ§

**å®Œæ•´æµç¨‹**:

1. **å‰ç«¯å¯åŠ¨ä»»åŠ¡**:
```typescript
// å¯åŠ¨ä»»åŠ¡
await invoke('start_sync_task', { taskId: 'task-123' });

// å¼€å§‹ç›‘å¬è¿›åº¦
const unlisten = await listen<TaskProgress>('task-progress', (event) => {
  if (event.payload.taskId === 'task-123') {
    updateProgress(event.payload);
  }
});
```

2. **åç«¯æ‰§è¡Œä»»åŠ¡å¹¶æ¨é€è¿›åº¦**:
```rust
// æ‰§è¡ŒåŒæ­¥
pub async fn sync_single_index(...) -> Result<()> {
    for batch in batches {
        // å¤„ç†æ•°æ®
        process_batch(batch).await?;
        
        // æ›´æ–°è¿›åº¦
        task_manager.update_unit_progress_with_sync(
            task_id,
            unit_id,
            total,
            processed,
            progress_monitor,
        ).await?;
        
        // progress_monitor å†…éƒ¨ä¼šè°ƒç”¨ emit_progress()
    }
    Ok(())
}

// ProgressMonitor æ¨é€è¿›åº¦
fn emit_progress(&self, task_id: &str) {
    if let Some(progress) = self.get_task_progress(task_id) {
        let _ = self.app_handle.emit("task-progress", progress);
    }
}
```

3. **å‰ç«¯æ¥æ”¶å¹¶æ›´æ–° UI**:
```vue
<template>
  <div class="progress-panel">
    <n-progress
      type="line"
      :percentage="progress?.percentage || 0"
      :status="getProgressStatus(progress?.status)"
    />
    <div class="stats">
      <span>å·²å¤„ç†: {{ progress?.processedRecords || 0 }}</span>
      <span>æ€»è®¡: {{ progress?.totalRecords || 0 }}</span>
    </div>
  </div>
</template>

<script setup lang="ts">
const { progress } = useTaskMonitor(taskId);
</script>
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. API å±‚å°è£…

**ä¸è¦ç›´æ¥åœ¨ç»„ä»¶ä¸­è°ƒç”¨ invoke**:
```typescript
// âŒ ä¸å¥½
const result = await invoke('list_data_sources');

// âœ… å¥½
const result = await datasourceApi.list();
```

### 2. ç±»å‹å®‰å…¨

**å®šä¹‰å®Œæ•´çš„ç±»å‹**:
```typescript
// src/types/index.ts
export interface DataSource {
  id: string;
  name: string;
  type: 'mysql' | 'elasticsearch';
  host: string;
  port: number;
  username: string;
  password: string;
  database?: string;
  createdAt: string;
  updatedAt: string;
}

export interface CreateDataSourceRequest {
  name: string;
  type: 'mysql' | 'elasticsearch';
  host: string;
  port: number;
  username: string;
  password: string;
  database?: string;
}
```

### 3. é”™è¯¯å¤„ç†

**ç»Ÿä¸€é”™è¯¯å¤„ç†**:
```typescript
// src/api/datasource.ts
export const datasourceApi = {
  async create(data: CreateDataSourceRequest): Promise<DataSource> {
    try {
      return await invoke('create_data_source', { data });
    } catch (error) {
      console.error('åˆ›å»ºæ•°æ®æºå¤±è´¥:', error);
      throw error;
    }
  },
};

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
try {
  const ds = await datasourceApi.create(formData);
  showSuccess('åˆ›å»ºæˆåŠŸ');
} catch (error) {
  showError(error as string);
}
```

### 4. äº‹ä»¶ç›‘å¬æ¸…ç†

**å§‹ç»ˆæ¸…ç†äº‹ä»¶ç›‘å¬å™¨**:
```typescript
export function useTaskMonitor(taskId: string) {
  let unlisten: (() => void) | null = null;
  
  async function startListening() {
    unlisten = await listen('task-progress', handler);
  }
  
  function stopListening() {
    if (unlisten) {
      unlisten();
      unlisten = null;
    }
  }
  
  onMounted(() => startListening());
  onUnmounted(() => stopListening());
  
  return { ... };
}
```

### 5. å¹¶å‘æ§åˆ¶

**é¿å…é‡å¤è°ƒç”¨**:
```typescript
const loading = ref(false);

async function handleStart() {
  if (loading.value) return;
  
  loading.value = true;
  try {
    await invoke('start_sync_task', { taskId });
  } finally {
    loading.value = false;
  }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‰ç«¯æ¶æ„](./å‰ç«¯æ¶æ„.md) - å‰ç«¯æ¶æ„è®¾è®¡
- [åç«¯æ¶æ„](./åç«¯æ¶æ„.md) - åç«¯æ¶æ„è®¾è®¡
- [APIæ¥å£è®¾è®¡](./APIæ¥å£è®¾è®¡.md) - å®Œæ•´çš„ API æ¥å£åˆ—è¡¨
- [æŠ€æœ¯è§„èŒƒ](./æŠ€æœ¯è§„èŒƒ.md) - å‰åç«¯ç»Ÿä¸€è§„èŒƒ

---

**æ–‡æ¡£ç»´æŠ¤**: DataTrac å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-30