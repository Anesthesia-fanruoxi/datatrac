# ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ 

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° DataTrac ç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦ç­–ç•¥å’Œæ–­ç‚¹ç»­ä¼ æœºåˆ¶ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-30  
**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ¯ æ¦‚è¿°

ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ æ˜¯ DataTrac ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç¡®ä¿æ•°æ®åŒæ­¥ä»»åŠ¡èƒ½å¤Ÿé«˜æ•ˆã€å¯é åœ°æ‰§è¡Œã€‚

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… è‡ªåŠ¨è°ƒåº¦æ‰€æœ‰æœªå®Œæˆçš„ä»»åŠ¡å•å…ƒ
- âœ… ä»¥è¡¨/ç´¢å¼•ä¸ºå•ä½çš„æ–­ç‚¹ç»­ä¼ 
- âœ… å¹¶å‘æ§åˆ¶å’Œçº¿ç¨‹æ± ç®¡ç†
- âœ… å¤±è´¥é‡è¯•æœºåˆ¶
- âŒ ~~æ‰‹åŠ¨æ¨¡å¼~~ï¼ˆå·²åºŸå¼ƒï¼‰

---

## ğŸ”„ è‡ªåŠ¨è°ƒåº¦æ¨¡å¼

### æ¦‚è¿°

è‡ªåŠ¨æ¨¡å¼æ˜¯ DataTrac çš„é»˜è®¤ä¸”å”¯ä¸€çš„è°ƒåº¦æ¨¡å¼ã€‚ä»»åŠ¡å¯åŠ¨åï¼ŒTaskManager ä¼šè‡ªåŠ¨è°ƒåº¦æ‰€æœ‰æœªå®Œæˆçš„ä»»åŠ¡å•å…ƒï¼ŒæŒ‰ç…§é…ç½®çš„çº¿ç¨‹æ•°å¹¶å‘æ‰§è¡Œã€‚

### å·¥ä½œåŸç†

```
ä»»åŠ¡å¯åŠ¨
   â†“
åŠ è½½æ‰€æœ‰ä»»åŠ¡å•å…ƒï¼ˆä»æ•°æ®åº“ï¼‰
   â†“
è¿‡æ»¤æœªå®Œæˆå•å…ƒï¼ˆstatus != completedï¼‰
   â†“
åˆ›å»ºçº¿ç¨‹æ± ï¼ˆSemaphoreï¼‰
   â†“
å¹¶å‘æ‰§è¡Œæ‰€æœ‰æœªå®Œæˆå•å…ƒ
   â”œâ”€ å•å…ƒ1: pending â†’ running â†’ completed
   â”œâ”€ å•å…ƒ2: pending â†’ running â†’ completed
   â”œâ”€ å•å…ƒ3: pending â†’ running â†’ failed
   â””â”€ ...
   â†“
æ‰€æœ‰å•å…ƒå®Œæˆ
   â†“
ä»»åŠ¡å®Œæˆ
```

### ç¤ºä¾‹åœºæ™¯

**åœºæ™¯**: 100 ä¸ªç´¢å¼•ï¼Œ10 ä¸ªçº¿ç¨‹

```
å¯åŠ¨æ—¶çŠ¶æ€:
- å·²å®Œæˆ: 20 ä¸ª
- å¾…æ‰§è¡Œ: 80 ä¸ª

æ‰§è¡Œè¿‡ç¨‹:
1. åŒæ—¶æ‰§è¡Œ 10 ä¸ªç´¢å¼•ï¼ˆçº¿ç¨‹æ± æ»¡ï¼‰
2. å®Œæˆ 1 ä¸ªåï¼Œè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€ä¸ª
3. å¾ªç¯æ‰§è¡Œç›´åˆ° 80 ä¸ªå…¨éƒ¨å®Œæˆ

æœ€ç»ˆçŠ¶æ€:
- å·²å®Œæˆ: 100 ä¸ª
- å¾…æ‰§è¡Œ: 0 ä¸ª
```

### å¹¶å‘æ§åˆ¶

ä½¿ç”¨ Tokio Semaphore å®ç°å¹¶å‘æ§åˆ¶ï¼š

```rust
// åˆ›å»ºä¿¡å·é‡ï¼Œé™åˆ¶å¹¶å‘æ•°ä¸º thread_count
let semaphore = Arc::new(Semaphore::new(thread_count));

for unit in pending_units {
    // è·å–è®¸å¯ï¼ˆå¦‚æœè¾¾åˆ°ä¸Šé™ä¼šç­‰å¾…ï¼‰
    let permit = semaphore.clone().acquire_owned().await?;
    
    // å¼‚æ­¥æ‰§è¡Œä»»åŠ¡
    tokio::spawn(async move {
        // æ‰§è¡ŒåŒæ­¥é€»è¾‘
        sync_unit(&unit).await;
        
        // é‡Šæ”¾è®¸å¯
        drop(permit);
    });
}
```

**ä¼˜åŠ¿**:
- è‡ªåŠ¨ç®¡ç†å¹¶å‘æ•°
- é¿å…èµ„æºè€—å°½
- å……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æº
- æ”¯æŒåŠ¨æ€è°ƒæ•´

---

## ğŸ’¾ æ–­ç‚¹ç»­ä¼ æœºåˆ¶

### æ¦‚è¿°

æ–­ç‚¹ç»­ä¼ åŠŸèƒ½ç¡®ä¿ä»»åŠ¡åœ¨æš‚åœã€æ–­ç½‘ã€å´©æºƒåèƒ½å¤Ÿç»§ç»­æ‰§è¡Œï¼Œé¿å…é‡å¤åŒæ­¥å·²å®Œæˆçš„æ•°æ®ã€‚

**ç²’åº¦**: ä»¥è¡¨/ç´¢å¼•ä¸ºå•ä½ï¼ˆä¸æ˜¯è®°å½•çº§åˆ«ï¼‰

### æ ¸å¿ƒåŸç†

#### 1. ä¸‰è¡¨ç»“æ„æ”¯æŒ

```
sync_tasks (ä»»åŠ¡ä¸»è¡¨)
   â†“ 1:N
task_unit_configs (é…ç½®è¡¨)
   â†“ 1:1
task_unit_runtimes (è¿è¡Œè®°å½•è¡¨)
```

**è¯´æ˜**:
- `task_unit_configs`: å­˜å‚¨è¦åŒæ­¥çš„è¡¨/ç´¢å¼•åˆ—è¡¨ï¼ˆä»ä»»åŠ¡é…ç½®æå–ï¼‰
- `task_unit_runtimes`: å­˜å‚¨æ¯ä¸ªå•å…ƒçš„æ‰§è¡ŒçŠ¶æ€å’Œè¿›åº¦

#### 2. çŠ¶æ€å®šä¹‰

```rust
pub enum TaskUnitStatus {
    Pending,    // å¾…æ‰§è¡Œ
    Running,    // æ‰§è¡Œä¸­
    Completed,  // å·²å®Œæˆ
    Failed,     // å¤±è´¥
    Paused,     // å·²æš‚åœ
}
```

#### 3. æ–­ç‚¹ç»­ä¼ é€»è¾‘

| åŸçŠ¶æ€ | ä»»åŠ¡é‡å¯å | è¯´æ˜ |
|--------|-----------|------|
| Completed | ä¿æŒ Completed | ä¸ä¼šé‡æ–°æ‰§è¡Œ |
| Pending | ä¿æŒ Pending | ç­‰å¾…æ‰§è¡Œ |
| Running | é‡ç½®ä¸º Pending | å¼‚å¸¸ä¸­æ–­ï¼Œé‡æ–°æ‰§è¡Œ |
| Failed | ä¿æŒ Failed | ç­‰å¾…æ‰‹åŠ¨é‡ç½® |
| Paused | ä¿æŒ Paused | ç­‰å¾…æ¢å¤ |

**æ³¨æ„**: æ–­ç‚¹ç»­ä¼ æ˜¯ä»¥æ•´ä¸ªè¡¨/ç´¢å¼•ä¸ºå•ä½ï¼Œä¸æ˜¯è®°å½•çº§åˆ«ã€‚å³ä½¿è¡¨/ç´¢å¼•æ‰§è¡Œåˆ°ä¸€åŠä¸­æ–­ï¼Œä¸‹æ¬¡ä¹Ÿä¼šä»å¤´å¼€å§‹ã€‚

### åˆå§‹åŒ–æµç¨‹

```
1. TaskLoader::init_task_units
   â†“
2. ä» task_unit_configs è¯»å–é…ç½®
   â†“
3. åŠ è½½ç°æœ‰çš„ task_unit_runtimes
   â†“
4. å¯¹æ¯”é…ç½®å’Œè¿è¡Œè®°å½•
   â”œâ”€ å·²æœ‰è®°å½• â†’ ä¿æŒçŠ¶æ€ï¼ˆRunning é‡ç½®ä¸º Pendingï¼‰
   â””â”€ æ— è®°å½• â†’ åˆ›å»ºæ–°è®°å½•ï¼ˆçŠ¶æ€ä¸º Pendingï¼‰
   â†“
5. æ¸…ç†å­¤ç«‹çš„è¿è¡Œè®°å½•
   â†“
6. å®Œæˆåˆå§‹åŒ–
```

### ä»£ç ç¤ºä¾‹

```rust
// åˆå§‹åŒ–ä»»åŠ¡å•å…ƒï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
pub async fn init_task_units(&self, task_id: &str) -> Result<()> {
    // 1. ä»é…ç½®è¡¨è¯»å–æ‰€æœ‰å•å…ƒ
    let configs = storage.load_unit_configs(task_id).await?;
    
    // 2. åŠ è½½ç°æœ‰çš„è¿è¡Œè®°å½•
    let existing_runtimes = storage.load_unit_runtimes(task_id).await?;
    let runtime_map: HashMap<String, _> = existing_runtimes
        .into_iter()
        .map(|r| (r.unit_name.clone(), r))
        .collect();
    
    // 3. ä¸ºæ¯ä¸ªé…ç½®å•å…ƒåˆ›å»ºæˆ–ä¿æŒè¿è¡Œè®°å½•
    for config in &configs {
        if let Some(existing) = runtime_map.get(&config.unit_name) {
            // å·²æœ‰è¿è¡Œè®°å½•
            match existing.status {
                TaskUnitStatus::Running => {
                    // è¿è¡Œä¸­çŠ¶æ€é‡ç½®ä¸º pendingï¼ˆå¼‚å¸¸ä¸­æ–­ï¼‰
                    storage.reset_runtime(task_id, &config.unit_name).await?;
                }
                TaskUnitStatus::Completed => {
                    // å·²å®Œæˆï¼Œä¿æŒä¸å˜
                }
                _ => {
                    // å…¶ä»–çŠ¶æ€ä¿æŒä¸å˜
                }
            }
        } else {
            // æ²¡æœ‰è¿è¡Œè®°å½•ï¼Œåˆ›å»ºæ–°çš„
            let runtime = TaskUnitRuntime {
                id: uuid::Uuid::new_v4().to_string(),
                task_id: task_id.to_string(),
                unit_name: config.unit_name.clone(),
                status: TaskUnitStatus::Pending,
                total_records: 0,
                processed_records: 0,
                error_message: None,
                started_at: None,
                updated_at: now,
                last_processed_batch: None,
            };
            storage.save_unit_runtime(&runtime).await?;
        }
    }
    
    // 4. æ¸…ç†é…ç½®è¡¨ä¸­ä¸å­˜åœ¨çš„è¿è¡Œè®°å½•
    storage.cleanup_orphan_runtimes(task_id).await?;
    
    Ok(())
}
```

### ä½¿ç”¨åœºæ™¯

#### åœºæ™¯ 1: æ­£å¸¸æš‚åœæ¢å¤

```
åˆå§‹çŠ¶æ€:
- ç´¢å¼•A: Completed
- ç´¢å¼•B: Running (50%)
- ç´¢å¼•C: Pending

ç”¨æˆ·æš‚åœä»»åŠ¡
   â†“
çŠ¶æ€å˜åŒ–:
- ç´¢å¼•A: Completed
- ç´¢å¼•B: Paused (50%)
- ç´¢å¼•C: Pending

ç”¨æˆ·æ¢å¤ä»»åŠ¡
   â†“
åˆå§‹åŒ–å:
- ç´¢å¼•A: Completed (è·³è¿‡)
- ç´¢å¼•B: Pending (é‡æ–°æ‰§è¡Œ)
- ç´¢å¼•C: Pending

æ‰§è¡Œç»“æœ:
- ç´¢å¼•A: ä¸æ‰§è¡Œ
- ç´¢å¼•B: ä»å¤´å¼€å§‹
- ç´¢å¼•C: ä»å¤´å¼€å§‹
```

#### åœºæ™¯ 2: å¼‚å¸¸ä¸­æ–­æ¢å¤

```
åˆå§‹çŠ¶æ€:
- ç´¢å¼•A: Completed
- ç´¢å¼•B: Running (80%)
- ç´¢å¼•C: Running (30%)

ç¨‹åºå´©æºƒ
   â†“
é‡æ–°å¯åŠ¨ä»»åŠ¡
   â†“
åˆå§‹åŒ–å:
- ç´¢å¼•A: Completed (è·³è¿‡)
- ç´¢å¼•B: Pending (é‡æ–°æ‰§è¡Œ)
- ç´¢å¼•C: Pending (é‡æ–°æ‰§è¡Œ)

æ‰§è¡Œç»“æœ:
- ç´¢å¼•A: ä¸æ‰§è¡Œ
- ç´¢å¼•B: ä»å¤´å¼€å§‹
- ç´¢å¼•C: ä»å¤´å¼€å§‹
```

#### åœºæ™¯ 3: å¤±è´¥é‡è¯•

```
åˆå§‹çŠ¶æ€:
- ç´¢å¼•A: Completed
- ç´¢å¼•B: Failed (ç½‘ç»œé”™è¯¯)
- ç´¢å¼•C: Pending

ç”¨æˆ·é‡ç½®å¤±è´¥å•å…ƒ
   â†“
çŠ¶æ€å˜åŒ–:
- ç´¢å¼•A: Completed
- ç´¢å¼•B: Pending
- ç´¢å¼•C: Pending

é‡æ–°å¯åŠ¨ä»»åŠ¡
   â†“
æ‰§è¡Œç»“æœ:
- ç´¢å¼•A: ä¸æ‰§è¡Œ
- ç´¢å¼•B: é‡æ–°æ‰§è¡Œ
- ç´¢å¼•C: æ‰§è¡Œ
```

---

## ğŸ”§ å¤±è´¥å¤„ç†

### å¤±è´¥ç­–ç•¥

å½“ä»»åŠ¡å•å…ƒæ‰§è¡Œå¤±è´¥æ—¶ï¼š

1. **æ ‡è®°å¤±è´¥çŠ¶æ€**
   ```rust
   task_manager.fail_unit_with_sync(
       task_id,
       unit_id,
       error_message,
       &progress_monitor
   ).await?;
   ```

2. **è®°å½•é”™è¯¯ä¿¡æ¯**
   - å­˜å‚¨åˆ° `task_unit_runtimes.error_message`
   - æ¨é€åˆ°å‰ç«¯æ˜¾ç¤º

3. **ç»§ç»­æ‰§è¡Œå…¶ä»–å•å…ƒ**
   - å¤±è´¥çš„å•å…ƒä¸å½±å“å…¶ä»–å•å…ƒ
   - å…¶ä»–å•å…ƒç»§ç»­å¹¶å‘æ‰§è¡Œ

4. **æ”¯æŒæ‰‹åŠ¨é‡è¯•**
   - ç”¨æˆ·å¯ä»¥é‡ç½®å¤±è´¥çš„å•å…ƒ
   - é‡ç½®åçŠ¶æ€å˜ä¸º Pending
   - é‡æ–°å¯åŠ¨ä»»åŠ¡æ—¶ä¼šæ‰§è¡Œ

### é‡ç½®å¤±è´¥å•å…ƒ

```rust
// åç«¯ API
#[tauri::command]
pub async fn reset_failed_units(task_id: String) -> Result<u64> {
    let storage = get_storage();
    let count = storage.reset_failed_units(&task_id).await?;
    Ok(count)
}

// å‰ç«¯è°ƒç”¨
const resetCount = await invoke('reset_failed_units', { taskId });
console.log(`é‡ç½®äº† ${resetCount} ä¸ªå¤±è´¥å•å…ƒ`);
```

---

## ğŸ“Š è¿›åº¦è·Ÿè¸ª

### å®æ—¶è¿›åº¦æ›´æ–°

```rust
// åœ¨åŒæ­¥è¿‡ç¨‹ä¸­æ›´æ–°è¿›åº¦
for batch_num in 1..=total_batches {
    // å¤„ç†æ‰¹æ¬¡æ•°æ®
    let records = fetch_batch(batch_num).await?;
    write_batch(records).await?;
    
    // æ›´æ–°è¿›åº¦
    let processed = batch_num * batch_size;
    task_manager.update_unit_progress_with_sync(
        task_id,
        unit_id,
        total_records,
        processed,
        &progress_monitor
    ).await?;
}
```

### è¿›åº¦è®¡ç®—

```rust
// å•ä¸ªå•å…ƒè¿›åº¦
unit_percentage = (processed_records / total_records) * 100.0

// ä»»åŠ¡æ€»ä½“è¿›åº¦
task_percentage = (completed_units / total_units) * 100.0
```

### è¿›åº¦æ¨é€

```
TaskManager
   â†“ update_unit_progress_with_sync
æ•°æ®åº“æŒä¹…åŒ–
   â†“
ProgressMonitor
   â†“ èšåˆæ‰€æœ‰å•å…ƒè¿›åº¦
Tauri Event
   â†“ task-progress
å‰ç«¯å®æ—¶æ›´æ–°
```

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### 1. å¯é æ€§
- æ•°æ®åº“æŒä¹…åŒ–ä¿è¯çŠ¶æ€ä¸ä¸¢å¤±
- æ”¯æŒå¼‚å¸¸ä¸­æ–­æ¢å¤
- å¤±è´¥å•å…ƒä¸å½±å“å…¶ä»–å•å…ƒ

### 2. é«˜æ•ˆæ€§
- å¹¶å‘æ‰§è¡Œå……åˆ†åˆ©ç”¨èµ„æº
- å·²å®Œæˆå•å…ƒä¸é‡å¤æ‰§è¡Œ
- è‡ªåŠ¨è°ƒåº¦æ— éœ€äººå·¥å¹²é¢„

### 3. çµæ´»æ€§
- æ”¯æŒæš‚åœ/æ¢å¤
- æ”¯æŒå¤±è´¥é‡è¯•
- å¯é…ç½®å¹¶å‘æ•°

### 4. å¯è§‚æµ‹æ€§
- å®æ—¶è¿›åº¦åé¦ˆ
- è¯¦ç»†é”™è¯¯ä¿¡æ¯
- å®Œæ•´æ‰§è¡Œæ—¥å¿—

---

## ğŸš« å·²åºŸå¼ƒåŠŸèƒ½

### æ‰‹åŠ¨æ¨¡å¼ï¼ˆå·²åºŸå¼ƒï¼‰

**åŸè®¾è®¡**: ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©è¦æ‰§è¡Œçš„è¡¨/ç´¢å¼•ï¼Œæ”¯æŒé˜Ÿåˆ—æ’åº

**åºŸå¼ƒåŸå› **:
- å¢åŠ ç³»ç»Ÿå¤æ‚åº¦
- ç”¨æˆ·æ“ä½œç¹ç
- è‡ªåŠ¨æ¨¡å¼å·²æ»¡è¶³éœ€æ±‚

**ç›¸å…³ä»£ç **: 
- `task_execution_queue` è¡¨ï¼ˆå·²ä¸ä½¿ç”¨ï¼‰
- `execute_manual_mode` æ–¹æ³•ï¼ˆå·²ä¸ä½¿ç”¨ï¼‰
- é˜Ÿåˆ—ç®¡ç† APIï¼ˆå·²ä¸ä½¿ç”¨ï¼‰

**æ³¨æ„**: è™½ç„¶ä»£ç ä¸­å¯èƒ½è¿˜å­˜åœ¨ç›¸å…³å®ç°ï¼Œä½†å·²ä¸å†ç»´æŠ¤å’Œä½¿ç”¨ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä»»åŠ¡ç®¡ç†å™¨](./ä»»åŠ¡ç®¡ç†å™¨.md) - TaskManager è¯¦ç»†è®¾è®¡
- [è‡ªåŠ¨æ¨¡å¼å®ç°](../implementation/è‡ªåŠ¨æ¨¡å¼å®ç°.md) - è‡ªåŠ¨æ¨¡å¼æ‰§è¡Œæµç¨‹
- [æ–­ç‚¹ç»­ä¼ å®ç°](../implementation/æ–­ç‚¹ç»­ä¼ å®ç°.md) - æ–­ç‚¹ç»­ä¼ å®ç°ç»†èŠ‚
- [æ•°æ®åº“è®¾è®¡](../architecture/æ•°æ®åº“è®¾è®¡.md) - ä¸‰è¡¨ç»“æ„è®¾è®¡

---

**æ–‡æ¡£ç»´æŠ¤**: DataTrac å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-30
