# 日志分类系统

## 📋 文档说明

本文档详细描述 DataTrac 系统的日志分类系统设计，包括日志类型、打标签机制和前端过滤。

**文档版本**: v1.0  
**最后更新**: 2026-01-30  
**实现状态**: ✅ 已完成（ES→ES）

---

## 🎯 概述

日志分类系统将同步任务的日志分为 4 个类别，满足不同场景的查看需求。

**设计原则**:
- 后端打标签：日志分类在后端完成
- 前端过滤：前端根据 category 字段过滤
- 统一接口：所有同步实现使用统一的日志接口
- 清晰分类：每条日志只属于一个分类

---

## 📊 日志类型

### 1. 实时日志 (Realtime)

**用途**: 显示所有详细的同步过程信息

**内容**:
- 批次读取信息
- 批次写入信息
- 实时进度信息
- 详细操作步骤

**示例**:
```
[2026-01-30 15:30:01] 第 1 批：读取到 2500 条记录
[2026-01-30 15:30:02] 第 1 批：开始写入 2500 条记录到目标索引
[2026-01-30 15:30:03] 已同步 2500 / 10000 条记录 (25%)
[2026-01-30 15:30:04] 第 2 批：读取到 2500 条记录
```

**适用场景**:
- 开发调试
- 问题排查
- 详细监控

---

### 2. 明细日志 (Summary)

**用途**: 显示批次级别的摘要信息

**内容**:
- 批次开始信息
- 批次完成信息
- 批次统计数据

**示例**:
```
[2026-01-30 15:30:01] 批次 1/4 开始处理，本批 2500 条记录
[2026-01-30 15:30:03] 批次 1 完成，已同步: 2500 条，剩余: 3 批次
[2026-01-30 15:30:04] 批次 2/4 开始处理，本批 2500 条记录
[2026-01-30 15:30:06] 批次 2 完成，已同步: 5000 条，剩余: 2 批次
```

**适用场景**:
- 日常监控
- 进度跟踪
- 性能分析

---

### 3. 校验日志 (Verify)

**用途**: 显示数据校验结果

**内容**:
- 单个索引/表完成信息
- 数据校验结果
- 总体统计信息

**示例**:
```
[2026-01-30 15:30:10] 索引 index-a 同步完成，共同步 10000 条记录
[2026-01-30 15:30:11] ✓ 索引 index-a 数据校验通过：源 10000 条 = 目标 10000 条
[2026-01-30 15:35:20] ✓ 所有索引同步完成：成功 5/5 个索引
```

**适用场景**:
- 数据验证
- 质量检查
- 完成确认

---

### 4. 错误日志 (Error)

**用途**: 显示错误和警告信息

**内容**:
- 连接错误
- 写入失败
- 数据异常
- 警告信息

**示例**:
```
[2026-01-30 15:30:05] ⚠ 第 2 批：bulk 写入部分失败，失败 3 条
[2026-01-30 15:30:15] ✗ 索引 index-b 同步失败：连接超时
[2026-01-30 15:30:16] ⚠ 警告：目标索引已存在，将覆盖数据
```

**适用场景**:
- 错误排查
- 异常监控
- 问题定位

---

## 🏗️ 技术实现

### 后端数据结构

#### LogCategory 枚举

```rust
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
#[serde(rename_all = "lowercase")]
pub enum LogCategory {
    Realtime,  // 实时日志
    Summary,   // 明细日志
    Verify,    // 校验日志
    Error,     // 错误日志
}
```

#### LogEntry 结构

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct LogEntry {
    pub timestamp: String,
    pub level: LogLevel,
    pub category: LogCategory,  // 日志分类标签
    pub message: String,
}
```

### 统一日志接口

```rust
// ProgressMonitor 提供统一的日志接口
pub fn add_log(
    &self, 
    task_id: &str, 
    level: LogLevel, 
    category: LogCategory, 
    message: String
) {
    self.logger.add_log(task_id, level, category, message);
}
```

### 使用示例

```rust
// 实时日志
progress_monitor.add_log(
    task_id,
    LogLevel::Info,
    LogCategory::Realtime,
    format!("第 {} 批：读取到 {} 条记录", batch_num, records.len())
);

// 明细日志
progress_monitor.add_log(
    task_id,
    LogLevel::Info,
    LogCategory::Summary,
    format!("批次 {}/{} 开始处理，本批 {} 条记录", 
        batch_num, total_batches, batch_size)
);

// 校验日志
progress_monitor.add_log(
    task_id,
    LogLevel::Info,
    LogCategory::Verify,
    format!("✓ 索引 {} 数据校验通过：源 {} 条 = 目标 {} 条", 
        index_name, source_count, target_count)
);

// 错误日志
progress_monitor.add_log(
    task_id,
    LogLevel::Error,
    LogCategory::Error,
    format!("✗ 索引 {} 同步失败：{}", index_name, error)
);
```

---

## 🎨 前端实现

### 日志过滤

```typescript
// 所有日志（实时日志）
const allLogs = ref<LogEntry[]>([])

// 明细日志：根据 category 字段过滤
const summaryLogs = computed(() => {
  return allLogs.value.filter(log => log.category === 'summary')
})

// 校验日志：根据 category 字段过滤
const verifyLogs = computed(() => {
  return allLogs.value.filter(log => log.category === 'verify')
})

// 错误日志：根据 category 字段过滤
const errorLogs = computed(() => {
  return allLogs.value.filter(log => log.category === 'error')
})
```

### UI 展示

```vue
<template>
  <n-tabs>
    <!-- 实时日志 -->
    <n-tab-pane name="realtime" tab="实时日志">
      <LogList :logs="allLogs" />
    </n-tab-pane>
    
    <!-- 明细日志 -->
    <n-tab-pane name="summary" tab="明细日志">
      <LogList :logs="summaryLogs" />
    </n-tab-pane>
    
    <!-- 校验日志 -->
    <n-tab-pane name="verify" tab="校验日志">
      <LogList :logs="verifyLogs" />
    </n-tab-pane>
    
    <!-- 错误日志 -->
    <n-tab-pane name="error" tab="错误日志">
      <LogList :logs="errorLogs" />
    </n-tab-pane>
  </n-tabs>
</template>
```

---

## 📝 日志规范

### ES→ES 同步日志规范

#### 批次处理

```rust
// 批次开始（明细日志）
progress_monitor.add_log(
    task_id,
    LogLevel::Info,
    LogCategory::Summary,
    format!("批次 {}/{} 开始处理，本批 {} 条记录", 
        batch_num, total_batches, batch_size)
);

// 批次读取（实时日志）
progress_monitor.add_log(
    task_id,
    LogLevel::Info,
    LogCategory::Realtime,
    format!("第 {} 批：读取到 {} 条记录", batch_num, records.len())
);

// 批次写入（实时日志）
progress_monitor.add_log(
    task_id,
    LogLevel::Info,
    LogCategory::Realtime,
    format!("第 {} 批：开始写入 {} 条记录到目标索引", batch_num, records.len())
);

// 批次完成（明细日志）
progress_monitor.add_log(
    task_id,
    LogLevel::Info,
    LogCategory::Summary,
    format!("批次 {} 完成，已同步: {} 条，剩余: {} 批次", 
        batch_num, processed, remaining_batches)
);
```

#### 索引完成

```rust
// 索引完成（校验日志）
progress_monitor.add_log(
    task_id,
    LogLevel::Info,
    LogCategory::Verify,
    format!("索引 {} 同步完成，共同步 {} 条记录", index_name, total_synced)
);

// 数据校验（校验日志）
progress_monitor.add_log(
    task_id,
    LogLevel::Info,
    LogCategory::Verify,
    format!("✓ 索引 {} 数据校验通过：源 {} 条 = 目标 {} 条", 
        index_name, source_count, target_count)
);
```

#### 错误处理

```rust
// 写入失败（错误日志）
progress_monitor.add_log(
    task_id,
    LogLevel::Error,
    LogCategory::Error,
    format!("第 {} 批：bulk 写入部分失败，失败 {} 条", batch_num, failed_count)
);

// 索引失败（错误日志）
progress_monitor.add_log(
    task_id,
    LogLevel::Error,
    LogCategory::Error,
    format!("✗ 索引 {} 同步失败：{}", index_name, error)
);
```

---

## 🎯 设计优势

### 1. 后端打标签
- 分类逻辑在后端统一管理
- 避免前端通过消息内容判断
- 更加可靠和一致

### 2. 前端过滤
- 简单高效的过滤逻辑
- 支持多种查看模式
- 用户体验友好

### 3. 统一接口
- 所有同步实现使用相同接口
- 便于维护和扩展
- 代码风格一致

### 4. 清晰分类
- 每条日志只属于一个分类
- 避免重复和混乱
- 易于理解和使用

---

## 📊 实现状态

### 已完成 ✅
- [x] 日志分类枚举定义
- [x] 日志条目结构
- [x] 统一日志接口
- [x] ES→ES 同步日志分类
- [x] 前端过滤和展示

### 待完成 🚧
- [ ] MySQL→MySQL 同步日志分类
- [ ] MySQL→ES 同步日志分类
- [ ] ES→MySQL 同步日志分类

### 实现指南

其他同步实现需要参考 ES→ES 的实现方式，在关键节点添加对应分类的日志：

1. **批次处理**: 使用 Summary 和 Realtime
2. **数据校验**: 使用 Verify
3. **错误处理**: 使用 Error

---

## 💡 最佳实践

### 1. 日志级别选择

| 分类 | 推荐级别 | 说明 |
|------|---------|------|
| Realtime | Info | 正常信息 |
| Summary | Info | 摘要信息 |
| Verify | Info | 校验通过 |
| Error | Error/Warn | 错误和警告 |

### 2. 消息格式

- 使用清晰的描述性文字
- 包含关键数据（数量、百分比等）
- 使用符号增强可读性（✓、✗、⚠）
- 保持格式一致

### 3. 日志频率

- Realtime: 每批次
- Summary: 每批次
- Verify: 每个索引/表
- Error: 发生错误时

---

## 📚 相关文档

- [任务管理器](./任务管理器.md) - TaskManager 详细设计
- [同步引擎](./同步引擎.md) - 同步引擎设计
- [后端同步引擎重构记录](../../../docs/后端同步引擎重构记录.md) - 日志系统实现记录

---

**文档维护**: DataTrac 开发团队  
**最后更新**: 2026-01-30
