# å·¥å…·æ¨¡å—

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° DataTrac ç³»ç»Ÿä¸­çš„å·¥å…·æ¨¡å—,åŒ…æ‹¬åŠ å¯†æœåŠ¡ã€ç±»å‹æ˜ å°„å™¨ç­‰è¾…åŠ©åŠŸèƒ½ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-30

---

## ğŸ¯ æ¦‚è¿°

å·¥å…·æ¨¡å—æä¾›äº†ç³»ç»Ÿè¿è¡Œæ‰€éœ€çš„å„ç§è¾…åŠ©åŠŸèƒ½,åŒ…æ‹¬æ•°æ®åŠ å¯†ã€ç±»å‹è½¬æ¢ã€æ—¥å¿—ç®¡ç†ç­‰ã€‚

---

## ğŸ” åŠ å¯†æœåŠ¡ (CryptoService)

### åŠŸèƒ½è¯´æ˜

åŠ å¯†æœåŠ¡è´Ÿè´£ä¿æŠ¤æ•æ„Ÿä¿¡æ¯(å¦‚æ•°æ®æºå¯†ç ),ä½¿ç”¨ AES-256-GCM åŠ å¯†ç®—æ³•ã€‚

**æ–‡ä»¶**: `src-tauri/src/crypto.rs`

### æ ¸å¿ƒç‰¹æ€§

- **åŠ å¯†ç®—æ³•**: AES-256-GCM (é«˜å¼ºåº¦å¯¹ç§°åŠ å¯†)
- **å¯†é’¥ç®¡ç†**: è‡ªåŠ¨ç”Ÿæˆå¹¶æŒä¹…åŒ–åˆ°æœ¬åœ°æ–‡ä»¶
- **å¯†é’¥å­˜å‚¨**: `~/.datasync/encryption.key` (ç”¨æˆ·ç›®å½•)
- **Nonce**: æ¯æ¬¡åŠ å¯†ä½¿ç”¨éšæœº nonce,ç¡®ä¿ç›¸åŒæ˜æ–‡äº§ç”Ÿä¸åŒå¯†æ–‡

### æ ¸å¿ƒæ–¹æ³•

```rust
pub struct CryptoService {
    cipher: Aes256Gcm,
}

impl CryptoService {
    /// åˆ›å»ºæ–°çš„åŠ å¯†æœåŠ¡å®ä¾‹
    /// é¦–æ¬¡è¿è¡Œæ—¶ç”Ÿæˆéšæœºå¯†é’¥å¹¶ä¿å­˜
    /// åç»­è¿è¡Œä»æ–‡ä»¶åŠ è½½å·²æœ‰å¯†é’¥
    pub fn new() -> Result<Self>;
    
    /// åŠ å¯†æ˜æ–‡å­—ç¬¦ä¸²
    /// è¿”å› Base64 ç¼–ç çš„å¯†æ–‡,æ ¼å¼ä¸º "nonce:ciphertext"
    pub fn encrypt(&self, plaintext: &str) -> Result<String>;
    
    /// è§£å¯†å¯†æ–‡å­—ç¬¦ä¸²
    /// å‚æ•°ä¸º Base64 ç¼–ç çš„å¯†æ–‡,æ ¼å¼ä¸º "nonce:ciphertext"
    pub fn decrypt(&self, ciphertext: &str) -> Result<String>;
}
```

### åŠ å¯†æµç¨‹

```
1. ç”Ÿæˆéšæœº nonce (12 å­—èŠ‚)
   â†“
2. ä½¿ç”¨ AES-256-GCM åŠ å¯†æ˜æ–‡
   â†“
3. å°† nonce å’Œå¯†æ–‡åˆ†åˆ«è¿›è¡Œ Base64 ç¼–ç 
   â†“
4. æ‹¼æ¥ä¸º "nonce:ciphertext" æ ¼å¼
   â†“
5. è¿”å›åŠ å¯†ç»“æœ
```

### è§£å¯†æµç¨‹

```
1. è§£æ "nonce:ciphertext" æ ¼å¼
   â†“
2. åˆ†åˆ«å¯¹ nonce å’Œå¯†æ–‡è¿›è¡Œ Base64 è§£ç 
   â†“
3. ä½¿ç”¨ AES-256-GCM è§£å¯†
   â†“
4. è¿”å›æ˜æ–‡
```

### ä½¿ç”¨ç¤ºä¾‹

```rust
// åˆ›å»ºåŠ å¯†æœåŠ¡
let crypto = CryptoService::new()?;

// åŠ å¯†å¯†ç 
let password = "my_secret_password";
let encrypted = crypto.encrypt(password)?;
// ç»“æœ: "SGVsbG8gV29ybGQ=:YWJjZGVmZ2hpamtsbW5vcA=="

// è§£å¯†å¯†ç 
let decrypted = crypto.decrypt(&encrypted)?;
// ç»“æœ: "my_secret_password"
```

### å®‰å…¨ç‰¹æ€§

1. **å¯†é’¥å®‰å…¨**:
   - å¯†é’¥å­˜å‚¨åœ¨ç”¨æˆ·ç›®å½•,æƒé™å—æ“ä½œç³»ç»Ÿä¿æŠ¤
   - å¯†é’¥é•¿åº¦ 256 ä½,ç¬¦åˆé«˜å¼ºåº¦åŠ å¯†æ ‡å‡†

2. **éšæœºæ€§**:
   - æ¯æ¬¡åŠ å¯†ä½¿ç”¨éšæœº nonce
   - ç›¸åŒæ˜æ–‡äº§ç”Ÿä¸åŒå¯†æ–‡,é˜²æ­¢æ¨¡å¼åˆ†æ

3. **å®Œæ•´æ€§**:
   - GCM æ¨¡å¼æä¾›è®¤è¯åŠ å¯†
   - è‡ªåŠ¨æ£€æµ‹å¯†æ–‡æ˜¯å¦è¢«ç¯¡æ”¹

---

## ğŸ”„ ç±»å‹æ˜ å°„å™¨ (TypeMapper)

### åŠŸèƒ½è¯´æ˜

ç±»å‹æ˜ å°„å™¨è´Ÿè´£åœ¨ MySQL å’Œ Elasticsearch ä¹‹é—´è¿›è¡Œæ•°æ®ç±»å‹è½¬æ¢ã€‚

**æ–‡ä»¶**: `src-tauri/src/type_mapper.rs`

### æ ¸å¿ƒæ–¹æ³•

```rust
pub struct TypeMapper;

impl TypeMapper {
    /// å°† MySQL æ•°æ®ç±»å‹æ˜ å°„åˆ° Elasticsearch ç±»å‹
    pub fn mysql_to_es(mysql_type: &str) -> String;
    
    /// å°† Elasticsearch æ•°æ®ç±»å‹æ˜ å°„åˆ° MySQL ç±»å‹
    pub fn es_to_mysql(es_type: &str) -> String;
    
    /// å°†ä¸»é”®å€¼æ˜ å°„ä¸ºå­—ç¬¦ä¸²(ç”¨äº ES çš„ _id å­—æ®µ)
    pub fn map_primary_key(pk_value: &Value) -> String;
}
```

### MySQL â†’ Elasticsearch ç±»å‹æ˜ å°„

| MySQL ç±»å‹ | ES ç±»å‹ | è¯´æ˜ |
|-----------|---------|------|
| INT, BIGINT, SMALLINT, TINYINT, MEDIUMINT | long | æ•´æ•°ç±»å‹ |
| TINYINT(1) | boolean | å¸ƒå°”å€¼(ç‰¹æ®Šå¤„ç†) |
| VARCHAR, CHAR, ENUM, SET | keyword | çŸ­å­—ç¬¦ä¸² |
| TEXT, MEDIUMTEXT, LONGTEXT | text | é•¿æ–‡æœ¬ |
| DATETIME, TIMESTAMP, DATE | date | æ—¥æœŸæ—¶é—´ |
| TIME, YEAR | keyword | æ—¶é—´ç±»å‹ |
| BOOLEAN, BOOL | boolean | å¸ƒå°”å€¼ |
| FLOAT, DOUBLE, DECIMAL | double | æµ®ç‚¹æ•° |
| JSON | object | JSON å¯¹è±¡ |
| BLOB, BINARY | binary | äºŒè¿›åˆ¶æ•°æ® |
| GEOMETRY, POINT ç­‰ | geo_shape | ç©ºé—´ç±»å‹ |
| å…¶ä»– | keyword | é»˜è®¤ç±»å‹ |

### Elasticsearch â†’ MySQL ç±»å‹æ˜ å°„

| ES ç±»å‹ | MySQL ç±»å‹ | è¯´æ˜ |
|---------|-----------|------|
| long, integer, short, byte | BIGINT | æ•´æ•°ç±»å‹ |
| text | TEXT | é•¿æ–‡æœ¬ |
| keyword | VARCHAR(255) | çŸ­å­—ç¬¦ä¸² |
| date | DATETIME | æ—¥æœŸæ—¶é—´ |
| boolean | BOOLEAN | å¸ƒå°”å€¼ |
| double, float | DOUBLE | æµ®ç‚¹æ•° |
| object, nested | JSON | JSON å¯¹è±¡ |
| binary | BLOB | äºŒè¿›åˆ¶æ•°æ® |
| å…¶ä»– | VARCHAR(255) | é»˜è®¤ç±»å‹ |

### ä½¿ç”¨ç¤ºä¾‹

```rust
// MySQL â†’ ES
let es_type = TypeMapper::mysql_to_es("VARCHAR(255)");
// ç»“æœ: "keyword"

let es_type = TypeMapper::mysql_to_es("DATETIME");
// ç»“æœ: "date"

let es_type = TypeMapper::mysql_to_es("TINYINT(1)");
// ç»“æœ: "boolean"

// ES â†’ MySQL
let mysql_type = TypeMapper::es_to_mysql("text");
// ç»“æœ: "TEXT"

let mysql_type = TypeMapper::es_to_mysql("long");
// ç»“æœ: "BIGINT"

// ä¸»é”®æ˜ å°„
let pk_value = json!(12345);
let pk_str = TypeMapper::map_primary_key(&pk_value);
// ç»“æœ: "12345"
```

### ç‰¹æ®Šå¤„ç†

1. **TINYINT(1) â†’ boolean**:
   - MySQL ä¸­ TINYINT(1) é€šå¸¸ç”¨ä½œå¸ƒå°”å€¼
   - è‡ªåŠ¨è¯†åˆ«å¹¶æ˜ å°„ä¸º ES çš„ boolean ç±»å‹

2. **å¸¦æ‹¬å·çš„ç±»å‹**:
   - è‡ªåŠ¨æå–åŸºç¡€ç±»å‹: `VARCHAR(255)` â†’ `VARCHAR`
   - å¿½ç•¥é•¿åº¦å’Œç²¾åº¦å‚æ•°

3. **ä¸»é”®å€¼è½¬æ¢**:
   - å­—ç¬¦ä¸²: ç›´æ¥è¿”å›
   - æ•°å­—: è½¬æ¢ä¸ºå­—ç¬¦ä¸²
   - å¸ƒå°”å€¼: è½¬æ¢ä¸º "true" æˆ– "false"
   - null: è¿”å›ç©ºå­—ç¬¦ä¸²

---

## ğŸ“ è¿›åº¦æ—¥å¿—ç³»ç»Ÿ (TaskLogger)

### åŠŸèƒ½è¯´æ˜

è¿›åº¦æ—¥å¿—ç³»ç»Ÿè´Ÿè´£ç®¡ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ—¥å¿—ä¿¡æ¯,æ”¯æŒå®æ—¶æ¨é€åˆ°å‰ç«¯ã€‚

**æ–‡ä»¶**: `src-tauri/src/progress_logger.rs`

### æ ¸å¿ƒç‰¹æ€§

- **å†…å­˜ç¼“å­˜**: æ¯ä¸ªä»»åŠ¡ä¿ç•™æœ€è¿‘ 1000 æ¡æ—¥å¿—
- **å®æ—¶æ¨é€**: é€šè¿‡ Tauri Event æ¨é€åˆ°å‰ç«¯
- **æ—¥å¿—åˆ†ç±»**: æ”¯æŒ 4 ç§æ—¥å¿—åˆ†ç±»
- **æ—¥å¿—çº§åˆ«**: æ”¯æŒ Info, Warn, Error ä¸‰ä¸ªçº§åˆ«

### æ•°æ®ç»“æ„

```rust
/// æ—¥å¿—æ¡ç›®
pub struct LogEntry {
    pub timestamp: String,      // æ—¶é—´æˆ³
    pub level: LogLevel,        // æ—¥å¿—çº§åˆ«
    pub category: LogCategory,  // æ—¥å¿—åˆ†ç±»
    pub message: String,        // æ—¥å¿—æ¶ˆæ¯
}

/// æ—¥å¿—çº§åˆ«
pub enum LogLevel {
    Info,    // ä¿¡æ¯
    Warn,    // è­¦å‘Š
    Error,   // é”™è¯¯
}

/// æ—¥å¿—åˆ†ç±»
pub enum LogCategory {
    Realtime,  // å®æ—¶æ—¥å¿—(æ‰€æœ‰è¯¦ç»†ä¿¡æ¯)
    Summary,   // æ˜ç»†æ—¥å¿—(æ‰¹æ¬¡æ‘˜è¦)
    Verify,    // æ ¡éªŒæ—¥å¿—(æ•°æ®æ ¡éªŒç»“æœ)
    Error,     // é”™è¯¯æ—¥å¿—(é”™è¯¯ä¿¡æ¯)
}
```

### æ ¸å¿ƒæ–¹æ³•

```rust
pub struct TaskLogger {
    task_logs: Arc<RwLock<HashMap<String, Vec<LogEntry>>>>,
    app_handle: Arc<RwLock<Option<AppHandle>>>,
}

impl TaskLogger {
    /// åˆ›å»ºæ–°çš„ä»»åŠ¡æ—¥å¿—ç®¡ç†å™¨
    pub fn new() -> Self;
    
    /// è®¾ç½®åº”ç”¨å¥æŸ„(ç”¨äºå‘é€äº‹ä»¶)
    pub fn set_app_handle(&self, handle: AppHandle);
    
    /// æ·»åŠ æ—¥å¿—
    pub fn add_log(&self, task_id: &str, level: LogLevel, category: LogCategory, message: String);
    
    /// è·å–ä»»åŠ¡æ—¥å¿—(ä»å†…å­˜è¯»å–æœ€è¿‘ 1000 æ¡)
    pub fn get_logs(&self, task_id: &str) -> Vec<LogEntry>;
    
    /// æ¸…é™¤ä»»åŠ¡æ—¥å¿—(ä»å†…å­˜ä¸­åˆ é™¤)
    pub fn clear_logs(&self, task_id: &str);
}
```

### ä½¿ç”¨ç¤ºä¾‹

```rust
// åˆ›å»ºæ—¥å¿—ç®¡ç†å™¨
let logger = TaskLogger::new();
logger.set_app_handle(app_handle);

// æ·»åŠ å®æ—¶æ—¥å¿—
logger.add_log(
    "task-123",
    LogLevel::Info,
    LogCategory::Realtime,
    "å¼€å§‹åŒæ­¥ç´¢å¼• logs-2024-01".to_string()
);

// æ·»åŠ æ˜ç»†æ—¥å¿—
logger.add_log(
    "task-123",
    LogLevel::Info,
    LogCategory::Summary,
    "æ‰¹æ¬¡ 1/10 å®Œæˆ,å·²å¤„ç† 1000 æ¡è®°å½•".to_string()
);

// æ·»åŠ æ ¡éªŒæ—¥å¿—
logger.add_log(
    "task-123",
    LogLevel::Info,
    LogCategory::Verify,
    "âœ“ æ•°æ®æ ¡éªŒé€šè¿‡: æº 10000 æ¡ = ç›®æ ‡ 10000 æ¡".to_string()
);

// æ·»åŠ é”™è¯¯æ—¥å¿—
logger.add_log(
    "task-123",
    LogLevel::Error,
    LogCategory::Error,
    "è¿æ¥è¶…æ—¶: æ— æ³•è¿æ¥åˆ°ç›®æ ‡æ•°æ®æº".to_string()
);

// è·å–æ—¥å¿—
let logs = logger.get_logs("task-123");
```

### äº‹ä»¶æ¨é€

æ—¥å¿—æ·»åŠ åä¼šè‡ªåŠ¨æ¨é€åˆ°å‰ç«¯:

```typescript
// å‰ç«¯ç›‘å¬æ—¥å¿—äº‹ä»¶
import { listen } from '@tauri-apps/api/event';

const unlisten = await listen<LogEvent>('task-log', (event) => {
  const { taskId, log } = event.payload;
  console.log(`[${log.timestamp}] [${log.level}] [${log.category}] ${log.message}`);
});
```

### æ—¥å¿—é™åˆ¶

- æ¯ä¸ªä»»åŠ¡æœ€å¤šä¿ç•™ **1000 æ¡**æ—¥å¿—
- è¶…è¿‡é™åˆ¶æ—¶,è‡ªåŠ¨åˆ é™¤æœ€æ—©çš„æ—¥å¿—
- é¿å…å†…å­˜å ç”¨è¿‡å¤§

---

## ğŸ”§ æ‰¹é‡æµ‹è¯•è¿æ¥åŠŸèƒ½

### åŠŸèƒ½è¯´æ˜

æ‰¹é‡æµ‹è¯•æ‰€æœ‰æ•°æ®æºçš„è¿æ¥çŠ¶æ€,åˆ†ä¸¤æ­¥è¿›è¡Œæµ‹è¯•ã€‚

**ä½ç½®**: `DataSourceManager::batch_test_connections()`

### æµ‹è¯•æ­¥éª¤

**æ­¥éª¤ 1: ç«¯å£è¿é€šæ€§æµ‹è¯•**
- æµ‹è¯•ç›®æ ‡: æ£€æŸ¥ä¸»æœºå’Œç«¯å£æ˜¯å¦å¯è¾¾
- æµ‹è¯•æ–¹æ³•: TCP è¿æ¥æµ‹è¯•
- è¶…æ—¶æ—¶é—´: 5 ç§’

**æ­¥éª¤ 2: è´¦å·å¯†ç éªŒè¯**
- æµ‹è¯•ç›®æ ‡: éªŒè¯ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
- æµ‹è¯•æ–¹æ³•: å®é™…è¿æ¥æ•°æ®åº“/ES
- å‰ææ¡ä»¶: æ­¥éª¤ 1 æˆåŠŸ

### å‚æ•°è¯´æ˜

```rust
pub async fn batch_test_connections(
    &self,
    window: Option<tauri::Window>,  // å¯é€‰,ç”¨äºå‘é€è¿›åº¦äº‹ä»¶
    skip_failed_step1: bool,        // æ˜¯å¦è·³è¿‡æ­¥éª¤1å¤±è´¥çš„æ•°æ®æº
) -> Result<BatchTestResult>
```

### è¿”å›ç»“æœ

```rust
pub struct BatchTestResult {
    pub total: usize,           // æ€»æ•°
    pub step1_success: usize,   // æ­¥éª¤1æˆåŠŸæ•°
    pub step1_failed: usize,    // æ­¥éª¤1å¤±è´¥æ•°
    pub step2_success: usize,   // æ­¥éª¤2æˆåŠŸæ•°
    pub step2_failed: usize,    // æ­¥éª¤2å¤±è´¥æ•°
    pub results: Vec<ConnectionResult>,  // è¯¦ç»†ç»“æœ
}
```

### ä½¿ç”¨åœºæ™¯

1. **ç³»ç»Ÿåˆå§‹åŒ–**: æ£€æŸ¥æ‰€æœ‰æ•°æ®æºé…ç½®æ˜¯å¦æ­£ç¡®
2. **æ•…éšœæ’æŸ¥**: å¿«é€Ÿå®šä½è¿æ¥é—®é¢˜
3. **æ‰¹é‡éªŒè¯**: ä¿®æ”¹ç½‘ç»œé…ç½®åæ‰¹é‡éªŒè¯

---

## ğŸ” ç´¢å¼•é€šé…ç¬¦åŒ¹é…åŠŸèƒ½

### åŠŸèƒ½è¯´æ˜

æ”¯æŒä½¿ç”¨é€šé…ç¬¦æ¨¡å¼åŒ¹é… Elasticsearch ç´¢å¼•ã€‚

**ä½ç½®**: `DataSourceManager::match_indices()`

### é€šé…ç¬¦è§„åˆ™

- `*`: åŒ¹é…ä»»æ„å¤šä¸ªå­—ç¬¦
- `?`: åŒ¹é…å•ä¸ªå­—ç¬¦

### è¿”å›ç»“æœ

```rust
pub struct IndexMatchResult {
    pub pattern: String,           // æœç´¢æ¨¡å¼
    pub matched_indices: Vec<String>,  // åŒ¹é…çš„ç´¢å¼•åˆ—è¡¨
    pub total_count: usize,        // åŒ¹é…æ€»æ•°
}
```

### ä½¿ç”¨ç¤ºä¾‹

```rust
// åŒ¹é…æ‰€æœ‰ä»¥ logs- å¼€å¤´çš„ç´¢å¼•
let result = data_source_manager.match_indices("es-source-id", "logs-*").await?;
// ç»“æœ: ["logs-2024-01", "logs-2024-02", "logs-2024-03"]

// åŒ¹é…ç‰¹å®šæ ¼å¼çš„ç´¢å¼•
let result = data_source_manager.match_indices("es-source-id", "app-?-prod").await?;
// ç»“æœ: ["app-a-prod", "app-b-prod", "app-c-prod"]
```

### åº”ç”¨åœºæ™¯

1. **æ‰¹é‡é€‰æ‹©**: åœ¨ä»»åŠ¡é…ç½®æ—¶å¿«é€Ÿé€‰æ‹©å¤šä¸ªç´¢å¼•
2. **æ¨¡å¼åŒ¹é…**: æŒ‰å‘½åè§„åˆ™æ‰¹é‡å¤„ç†ç´¢å¼•
3. **åŠ¨æ€å‘ç°**: è‡ªåŠ¨å‘ç°æ–°å¢çš„ç´¢å¼•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åç«¯æ¶æ„](../architecture/åç«¯æ¶æ„.md) - åç«¯æ•´ä½“æ¶æ„
- [æ•°æ®æºç®¡ç†](./æ•°æ®æºç®¡ç†.md) - æ•°æ®æºç®¡ç†åŠŸèƒ½
- [æ—¥å¿—åˆ†ç±»ç³»ç»Ÿ](./æ—¥å¿—åˆ†ç±»ç³»ç»Ÿ.md) - æ—¥å¿—ç³»ç»Ÿè¯¦ç»†è®¾è®¡
- [APIæ¥å£è®¾è®¡](../architecture/APIæ¥å£è®¾è®¡.md) - API æ¥å£æ–‡æ¡£

---

**æ–‡æ¡£ç»´æŠ¤**: DataTrac å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-30
