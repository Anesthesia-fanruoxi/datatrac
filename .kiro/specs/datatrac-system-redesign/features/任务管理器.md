# ä»»åŠ¡ç®¡ç†å™¨ (TaskManager)

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° DataTrac ç³»ç»Ÿçš„ä»»åŠ¡ç®¡ç†å™¨è®¾è®¡ï¼ŒåŒ…æ‹¬èŒè´£ã€åŠŸèƒ½ã€æ¥å£å’Œå·¥ä½œæµç¨‹ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-30  
**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ¯ æ¦‚è¿°

TaskManager æ˜¯ DataTrac ç³»ç»Ÿçš„æ ¸å¿ƒè°ƒåº¦æ¨¡å—ï¼Œè´Ÿè´£ç»Ÿä¸€ç®¡ç†å’Œè°ƒåº¦æ‰€æœ‰åŒæ­¥ä»»åŠ¡çš„æ‰§è¡Œã€‚

**æ ¸å¿ƒèŒè´£**:
- ğŸ“¦ ä»»åŠ¡å•å…ƒç®¡ç†ï¼ˆè¡¨/ç´¢å¼•çº§åˆ«ï¼‰
- ğŸ”„ å¹¶å‘æ§åˆ¶ï¼ˆçº¿ç¨‹æ± ç®¡ç†ï¼‰
- ğŸ“Š çŠ¶æ€è·Ÿè¸ªå’ŒåŒæ­¥
- ğŸ’¾ æ•°æ®åº“æŒä¹…åŒ–
- ğŸ”Œ ä¸å‰ç«¯å®æ—¶é€šä¿¡

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ä½ç½®

```
åç«¯å±‚
  â””â”€ æ ¸å¿ƒæ¨¡å—
      â”œâ”€ TaskManager      â† æœ¬æ¨¡å—
      â”œâ”€ SyncEngine
      â”œâ”€ ProgressMonitor
      â””â”€ LogSystem
```

### ä¾èµ–å…³ç³»

```
TaskManager
  â”œâ”€ ä¾èµ– Storage (æ•°æ®åº“è®¿é—®)
  â”œâ”€ ä¾èµ– ProgressMonitor (è¿›åº¦æ¨é€)
  â””â”€ è¢« SyncEngine è°ƒç”¨
```

---

## ğŸ“¦ æ•°æ®ç»“æ„

### TaskUnit - ä»»åŠ¡å•å…ƒ

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct TaskUnit {
    /// å•å…ƒ ID (è¡¨åæˆ–ç´¢å¼•å)
    pub id: String,
    
    /// å•å…ƒåç§°
    pub name: String,
    
    /// çŠ¶æ€
    pub status: TaskUnitStatus,
    
    /// æ€»è®°å½•æ•°
    pub total_records: u64,
    
    /// å·²å¤„ç†è®°å½•æ•°
    pub processed_records: u64,
    
    /// è¿›åº¦ç™¾åˆ†æ¯”
    pub percentage: f64,
    
    /// é”™è¯¯ä¿¡æ¯ (å¦‚æœå¤±è´¥)
    pub error_message: Option<String>,
}
```

### TaskUnitStatus - ä»»åŠ¡å•å…ƒçŠ¶æ€

```rust
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
#[serde(rename_all = "lowercase")]
pub enum TaskUnitStatus {
    Pending,    // ç­‰å¾…æ‰§è¡Œ
    Running,    // æ‰§è¡Œä¸­
    Completed,  // å·²å®Œæˆ
    Failed,     // å¤±è´¥
}
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. ä»»åŠ¡å•å…ƒç®¡ç†

#### 1.1 ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡å•å…ƒ

```rust
pub async fn load_task_units_from_db(&self, task_id: &str) -> Result<Vec<TaskUnit>>
```

**åŠŸèƒ½**: ä» `task_unit_runtimes` è¡¨åŠ è½½ä»»åŠ¡å•å…ƒï¼Œè½¬æ¢ä¸ºå†…å­˜æ ¼å¼

**æµç¨‹**:
1. è°ƒç”¨ Storage çš„ `load_unit_runtimes` æ–¹æ³•
2. å°†æ•°æ®åº“è®°å½•è½¬æ¢ä¸º TaskUnit ç»“æ„
3. è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
4. æ›´æ–°å†…å­˜ç¼“å­˜
5. è¿”å›ä»»åŠ¡å•å…ƒåˆ—è¡¨

**ç¤ºä¾‹**:
```rust
let units = task_manager.load_task_units_from_db("task-123").await?;
println!("åŠ è½½äº† {} ä¸ªä»»åŠ¡å•å…ƒ", units.len());
```

#### 1.2 åˆå§‹åŒ–ä»»åŠ¡å•å…ƒåˆ—è¡¨

```rust
pub fn init_task_units(&self, task_id: &str, unit_names: Vec<String>)
```

**åŠŸèƒ½**: åœ¨å†…å­˜ä¸­åˆå§‹åŒ–ä»»åŠ¡å•å…ƒåˆ—è¡¨ï¼ˆç”¨äºæ–°ä»»åŠ¡ï¼‰

**æµç¨‹**:
1. ä¸ºæ¯ä¸ªå•å…ƒåç§°åˆ›å»º TaskUnit å¯¹è±¡
2. åˆå§‹çŠ¶æ€ä¸º Pending
3. å­˜å‚¨åˆ°å†…å­˜ç¼“å­˜

#### 1.3 è·å–ä»»åŠ¡å•å…ƒåˆ—è¡¨

```rust
pub fn get_task_units(&self, task_id: &str) -> Vec<TaskUnit>
```

**åŠŸèƒ½**: ä»å†…å­˜ç¼“å­˜è·å–ä»»åŠ¡å•å…ƒåˆ—è¡¨

---

### 2. çŠ¶æ€ç®¡ç†

#### 2.1 æ›´æ–°ä»»åŠ¡å•å…ƒçŠ¶æ€

```rust
pub fn update_unit_status(&self, task_id: &str, unit_id: &str, status: TaskUnitStatus)
```

**åŠŸèƒ½**: æ›´æ–°å†…å­˜ä¸­çš„ä»»åŠ¡å•å…ƒçŠ¶æ€

#### 2.2 æ›´æ–°çŠ¶æ€å¹¶åŒæ­¥

```rust
pub async fn update_unit_status_with_sync(
    &self,
    task_id: &str,
    unit_id: &str,
    status: TaskUnitStatus,
    progress_monitor: &Arc<ProgressMonitor>,
) -> Result<()>
```

**åŠŸèƒ½**: æ›´æ–°çŠ¶æ€å¹¶åŒæ­¥åˆ°æ•°æ®åº“å’Œå‰ç«¯

**åŒæ­¥æµç¨‹**:
```
å†…å­˜ç¼“å­˜
   â†“ update_unit_status
æ•°æ®åº“
   â†“ Storage::update_runtime_status
ProgressMonitor
   â†“ update_task_units
å‰ç«¯
   â†“ Tauri Event
```

**ç¤ºä¾‹**:
```rust
task_manager.update_unit_status_with_sync(
    "task-123",
    "index-a",
    TaskUnitStatus::Running,
    &progress_monitor
).await?;
```

---

### 3. è¿›åº¦ç®¡ç†

#### 3.1 æ›´æ–°ä»»åŠ¡å•å…ƒè¿›åº¦

```rust
pub fn update_unit_progress(&self, task_id: &str, unit_id: &str, total: u64, processed: u64)
```

**åŠŸèƒ½**: æ›´æ–°å†…å­˜ä¸­çš„ä»»åŠ¡å•å…ƒè¿›åº¦

**è®¡ç®—**:
```rust
percentage = (processed / total) * 100.0
```

#### 3.2 æ›´æ–°è¿›åº¦å¹¶åŒæ­¥

```rust
pub async fn update_unit_progress_with_sync(
    &self,
    task_id: &str,
    unit_id: &str,
    total: u64,
    processed: u64,
    progress_monitor: &Arc<ProgressMonitor>,
) -> Result<()>
```

**åŠŸèƒ½**: æ›´æ–°è¿›åº¦å¹¶åŒæ­¥åˆ°æ•°æ®åº“å’Œå‰ç«¯

**ç¤ºä¾‹**:
```rust
// æ¯æ‰¹æ¬¡å¤„ç†å®Œæˆåæ›´æ–°è¿›åº¦
task_manager.update_unit_progress_with_sync(
    "task-123",
    "index-a",
    10000,  // æ€»è®°å½•æ•°
    2500,   // å·²å¤„ç†è®°å½•æ•°
    &progress_monitor
).await?;
```

---

### 4. é”™è¯¯å¤„ç†

#### 4.1 æ ‡è®°ä»»åŠ¡å•å…ƒå¤±è´¥

```rust
pub fn fail_unit(&self, task_id: &str, unit_id: &str, error: String)
```

**åŠŸèƒ½**: æ ‡è®°ä»»åŠ¡å•å…ƒä¸ºå¤±è´¥çŠ¶æ€ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯

#### 4.2 æ ‡è®°å¤±è´¥å¹¶åŒæ­¥

```rust
pub async fn fail_unit_with_sync(
    &self,
    task_id: &str,
    unit_id: &str,
    error: String,
    progress_monitor: &Arc<ProgressMonitor>,
) -> Result<()>
```

**åŠŸèƒ½**: æ ‡è®°å¤±è´¥å¹¶åŒæ­¥åˆ°æ•°æ®åº“å’Œå‰ç«¯

**ç¤ºä¾‹**:
```rust
if let Err(e) = sync_result {
    task_manager.fail_unit_with_sync(
        "task-123",
        "index-a",
        e.to_string(),
        &progress_monitor
    ).await?;
}
```

---

### 5. å¹¶å‘æ§åˆ¶ â­ æ ¸å¿ƒ

#### 5.1 è‡ªåŠ¨æ¨¡å¼æ‰§è¡Œ

```rust
pub async fn execute_auto_mode<F, Fut>(
    &self,
    task_id: &str,
    concurrency: usize,
    progress_monitor: Arc<ProgressMonitor>,
    process_fn: F,
) -> Result<usize>
where
    F: Fn(String, String) -> Fut + Send + Sync + 'static,
    Fut: std::future::Future<Output = Result<()>> + Send,
```

**åŠŸèƒ½**: è‡ªåŠ¨æ¨¡å¼æ‰§è¡Œæ‰€æœ‰æœªå®Œæˆçš„ä»»åŠ¡å•å…ƒ

**å‚æ•°**:
- `task_id`: ä»»åŠ¡ ID
- `concurrency`: å¹¶å‘æ•°ï¼ˆçº¿ç¨‹æ•°ï¼‰
- `progress_monitor`: è¿›åº¦ç›‘æ§å™¨
- `process_fn`: å¤„ç†å•ä¸ªå•å…ƒçš„å¼‚æ­¥å‡½æ•°

**è¿”å›**: æˆåŠŸæ‰§è¡Œçš„å•å…ƒæ•°é‡

**æ‰§è¡Œæµç¨‹**:
```
1. ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡å•å…ƒ
   â†“
2. è¿‡æ»¤å‡ºæœªå®Œæˆçš„å•å…ƒ (status != Completed)
   â†“
3. åˆ›å»º Semaphore (å¹¶å‘æ§åˆ¶)
   â†“
4. ä¸ºæ¯ä¸ªå•å…ƒåˆ›å»ºå¼‚æ­¥ä»»åŠ¡
   â”œâ”€ è·å– Semaphore è®¸å¯
   â”œâ”€ æ ‡è®°ä¸º Running
   â”œâ”€ è°ƒç”¨ process_fn æ‰§è¡Œ
   â”œâ”€ æˆåŠŸ â†’ æ ‡è®°ä¸º Completed
   â”œâ”€ å¤±è´¥ â†’ æ ‡è®°ä¸º Failed
   â””â”€ é‡Šæ”¾ Semaphore è®¸å¯
   â†“
5. ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
   â†“
6. è¿”å›æˆåŠŸæ•°é‡
```

**å¹¶å‘æ§åˆ¶åŸç†**:
```rust
// åˆ›å»ºä¿¡å·é‡ï¼Œé™åˆ¶å¹¶å‘æ•°
let semaphore = Arc::new(Semaphore::new(concurrency));

for unit in pending_units {
    // è·å–è®¸å¯ï¼ˆå¦‚æœè¾¾åˆ°å¹¶å‘ä¸Šé™ä¼šç­‰å¾…ï¼‰
    let permit = semaphore.clone().acquire_owned().await?;
    
    // å¼‚æ­¥æ‰§è¡Œä»»åŠ¡
    tokio::spawn(async move {
        // æ‰§è¡ŒåŒæ­¥é€»è¾‘
        let result = process_fn(unit_id, unit_name).await;
        
        // é‡Šæ”¾è®¸å¯
        drop(permit);
    });
}
```

**ç¤ºä¾‹**:
```rust
// åœ¨ SyncEngine ä¸­è°ƒç”¨
let success_count = task_manager.execute_auto_mode(
    task_id,
    thread_count,
    progress_monitor.clone(),
    |unit_id, unit_name| async move {
        // æ‰§è¡Œå…·ä½“çš„åŒæ­¥é€»è¾‘
        sync_single_index(&unit_name).await
    }
).await?;

println!("æˆåŠŸæ‰§è¡Œ {} ä¸ªå•å…ƒ", success_count);
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### å®Œæ•´æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. SyncEngine å¯åŠ¨ä»»åŠ¡                                   â”‚
â”‚    â””â”€ è°ƒç”¨ TaskManager::execute_auto_mode               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. TaskManager åŠ è½½ä»»åŠ¡å•å…ƒ                              â”‚
â”‚    â”œâ”€ ä»æ•°æ®åº“åŠ è½½ (load_task_units_from_db)            â”‚
â”‚    â”œâ”€ è¿‡æ»¤æœªå®Œæˆå•å…ƒ (status != Completed)              â”‚
â”‚    â””â”€ æ›´æ–°å†…å­˜ç¼“å­˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. TaskManager åˆ›å»ºå¹¶å‘æ§åˆ¶                              â”‚
â”‚    â”œâ”€ åˆ›å»º Semaphore (concurrency)                      â”‚
â”‚    â””â”€ åˆå§‹åŒ–æˆåŠŸè®¡æ•°å™¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. TaskManager å¹¶å‘æ‰§è¡Œä»»åŠ¡å•å…ƒ                          â”‚
â”‚    â”œâ”€ ä¸ºæ¯ä¸ªå•å…ƒåˆ›å»ºå¼‚æ­¥ä»»åŠ¡                             â”‚
â”‚    â”œâ”€ è·å– Semaphore è®¸å¯                               â”‚
â”‚    â”œâ”€ æ ‡è®°ä¸º Running                                    â”‚
â”‚    â”œâ”€ è°ƒç”¨ process_fn æ‰§è¡ŒåŒæ­¥                          â”‚
â”‚    â”œâ”€ æˆåŠŸ â†’ Completed / å¤±è´¥ â†’ Failed                  â”‚
â”‚    â””â”€ é‡Šæ”¾ Semaphore è®¸å¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. çŠ¶æ€åŒæ­¥                                              â”‚
â”‚    â”œâ”€ å†…å­˜ç¼“å­˜æ›´æ–°                                       â”‚
â”‚    â”œâ”€ æ•°æ®åº“æŒä¹…åŒ–                                       â”‚
â”‚    â”œâ”€ ProgressMonitor èšåˆ                              â”‚
â”‚    â””â”€ å‰ç«¯å®æ—¶æ›´æ–°                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ                                      â”‚
â”‚    â””â”€ è¿”å›æˆåŠŸæ‰§è¡Œçš„å•å…ƒæ•°é‡                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š çŠ¶æ€åŒæ­¥æœºåˆ¶

### ä¸‰å±‚åŒæ­¥æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸€å±‚: å†…å­˜ç¼“å­˜ (HashMap<String, Vec<TaskUnit>>)        â”‚
â”‚  - å¿«é€Ÿè¯»å†™                                               â”‚
â”‚  - å®æ—¶çŠ¶æ€                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ update_unit_status_with_sync
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬äºŒå±‚: æ•°æ®åº“æŒä¹…åŒ– (task_unit_runtimes)                â”‚
â”‚  - æ–­ç‚¹ç»­ä¼                                                â”‚
â”‚  - æ•°æ®ä¸€è‡´æ€§                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ ProgressMonitor::update_task_units
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸‰å±‚: å‰ç«¯å®æ—¶æ˜¾ç¤º (Tauri Event)                        â”‚
â”‚  - ç”¨æˆ·ç•Œé¢                                               â”‚
â”‚  - å®æ—¶åé¦ˆ                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒæ­¥æ—¶æœº

| æ“ä½œ | å†…å­˜ | æ•°æ®åº“ | å‰ç«¯ |
|------|------|--------|------|
| å¯åŠ¨ä»»åŠ¡ | âœ… | âœ… | âœ… |
| å•å…ƒå¼€å§‹ | âœ… | âœ… | âœ… |
| è¿›åº¦æ›´æ–° | âœ… | âœ… | âœ… |
| å•å…ƒå®Œæˆ | âœ… | âœ… | âœ… |
| å•å…ƒå¤±è´¥ | âœ… | âœ… | âœ… |

---

## ğŸ”Œ API æ¥å£

### å…¬å…±æ–¹æ³•

| æ–¹æ³• | è¯´æ˜ | åŒæ­¥ |
|------|------|------|
| `load_task_units_from_db` | ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡å•å…ƒ | å¼‚æ­¥ |
| `init_task_units` | åˆå§‹åŒ–ä»»åŠ¡å•å…ƒåˆ—è¡¨ | åŒæ­¥ |
| `get_task_units` | è·å–ä»»åŠ¡å•å…ƒåˆ—è¡¨ | åŒæ­¥ |
| `update_unit_status` | æ›´æ–°å•å…ƒçŠ¶æ€ï¼ˆä»…å†…å­˜ï¼‰ | åŒæ­¥ |
| `update_unit_status_with_sync` | æ›´æ–°å•å…ƒçŠ¶æ€ï¼ˆå«åŒæ­¥ï¼‰ | å¼‚æ­¥ |
| `update_unit_progress` | æ›´æ–°å•å…ƒè¿›åº¦ï¼ˆä»…å†…å­˜ï¼‰ | åŒæ­¥ |
| `update_unit_progress_with_sync` | æ›´æ–°å•å…ƒè¿›åº¦ï¼ˆå«åŒæ­¥ï¼‰ | å¼‚æ­¥ |
| `fail_unit` | æ ‡è®°å•å…ƒå¤±è´¥ï¼ˆä»…å†…å­˜ï¼‰ | åŒæ­¥ |
| `fail_unit_with_sync` | æ ‡è®°å•å…ƒå¤±è´¥ï¼ˆå«åŒæ­¥ï¼‰ | å¼‚æ­¥ |
| `execute_auto_mode` | è‡ªåŠ¨æ¨¡å¼æ‰§è¡Œ | å¼‚æ­¥ |
| `clear_task_units` | æ¸…é™¤ä»»åŠ¡å•å…ƒ | åŒæ­¥ |

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åœ¨ SyncEngine ä¸­ä½¿ç”¨

```rust
// åœ¨ SyncEngine çš„ start_sync æ–¹æ³•ä¸­
pub async fn start_sync(&self, task_id: &str) -> Result<()> {
    // 1. åŠ è½½ä»»åŠ¡é…ç½®
    let config = self.task_loader.load_and_parse_task(task_id).await?;
    
    // 2. åˆå§‹åŒ–ä»»åŠ¡å•å…ƒ
    self.task_loader.init_task_units(task_id).await?;
    
    // 3. ä½¿ç”¨ TaskManager è‡ªåŠ¨æ¨¡å¼æ‰§è¡Œ
    let success_count = self.task_manager.execute_auto_mode(
        task_id,
        config.sync_config.thread_count as usize,
        self.progress_monitor.clone(),
        |unit_id, unit_name| {
            let engine = self.clone();
            async move {
                // æ‰§è¡Œå…·ä½“çš„åŒæ­¥é€»è¾‘
                engine.sync_single_unit(&unit_name).await
            }
        }
    ).await?;
    
    log::info!("ä»»åŠ¡å®Œæˆï¼ŒæˆåŠŸ: {}", success_count);
    Ok(())
}
```

### ç¤ºä¾‹ 2: æ›´æ–°è¿›åº¦

```rust
// åœ¨åŒæ­¥è¿‡ç¨‹ä¸­æ›´æ–°è¿›åº¦
for batch in batches {
    // å¤„ç†æ‰¹æ¬¡æ•°æ®
    process_batch(batch).await?;
    
    // æ›´æ–°è¿›åº¦
    processed += batch.len();
    task_manager.update_unit_progress_with_sync(
        task_id,
        unit_id,
        total_records,
        processed,
        &progress_monitor
    ).await?;
}
```

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### 1. èŒè´£å•ä¸€
TaskManager åªè´Ÿè´£ä»»åŠ¡è°ƒåº¦å’ŒçŠ¶æ€ç®¡ç†ï¼Œä¸æ¶‰åŠå…·ä½“çš„åŒæ­¥é€»è¾‘ã€‚

### 2. é«˜å¹¶å‘
ä½¿ç”¨ Tokio Semaphore å®ç°é«˜æ•ˆçš„å¹¶å‘æ§åˆ¶ï¼Œå……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºã€‚

### 3. çŠ¶æ€ä¸€è‡´
ä¸‰å±‚åŒæ­¥æœºåˆ¶ä¿è¯å†…å­˜ã€æ•°æ®åº“ã€å‰ç«¯çš„çŠ¶æ€ä¸€è‡´æ€§ã€‚

### 4. æ–­ç‚¹ç»­ä¼ 
ä¸æ•°æ®åº“ç´§å¯†é›†æˆï¼Œæ”¯æŒä»»åŠ¡æš‚åœã€æ¢å¤ã€å¤±è´¥é‡è¯•ã€‚

### 5. æ˜“äºæ‰©å±•
é€šè¿‡ `process_fn` å›è°ƒå‡½æ•°ï¼Œæ”¯æŒä¸åŒç±»å‹çš„åŒæ­¥é€»è¾‘ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ ](./ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ .md) - è°ƒåº¦ç­–ç•¥å’Œæ–­ç‚¹ç»­ä¼ è®¾è®¡
- [ä»»åŠ¡ç®¡ç†å™¨å®ç°](../implementation/ä»»åŠ¡ç®¡ç†å™¨å®ç°.md) - è¯¦ç»†å®ç°ä»£ç 
- [è‡ªåŠ¨æ¨¡å¼å®ç°](../implementation/è‡ªåŠ¨æ¨¡å¼å®ç°.md) - è‡ªåŠ¨æ¨¡å¼æ‰§è¡Œæµç¨‹
- [æ•°æ®åº“è®¾è®¡](../architecture/æ•°æ®åº“è®¾è®¡.md) - ä¸‰è¡¨ç»“æ„è®¾è®¡

---

**æ–‡æ¡£ç»´æŠ¤**: DataTrac å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-30
