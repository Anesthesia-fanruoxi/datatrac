# å¢é‡åŒæ­¥è®¾è®¡

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° DataTrac ç³»ç»Ÿçš„å¢é‡åŒæ­¥æœºåˆ¶ï¼Œæ”¯æŒå¤šç§åŒæ­¥æ¨¡å¼å’Œå¢é‡ç­–ç•¥ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-30  
**å®ç°çŠ¶æ€**: ğŸš§ è®¾è®¡ä¸­

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

### æ ¸å¿ƒéœ€æ±‚

1. **é¿å…é‡å¤åŒæ­¥**: å·²åŒæ­¥çš„æ•°æ®ä¸å†é‡å¤åŒæ­¥
2. **çµæ´»é…ç½®**: ç”¨æˆ·å¯ä»¥é€‰æ‹©åŒæ­¥æ¨¡å¼ï¼ˆå…¨é‡/å¢é‡/è·³è¿‡å·²å®Œæˆï¼‰
3. **å¤šç§ç­–ç•¥**: æ”¯æŒåŸºäºæ—¶é—´æˆ³ã€è‡ªå¢IDã€ç‰ˆæœ¬å·çš„å¢é‡åŒæ­¥
4. **æ–­ç‚¹ç»­ä¼ **: è®°å½•ä¸Šæ¬¡åŒæ­¥ä½ç½®ï¼Œæ”¯æŒä¸­æ–­åç»§ç»­
5. **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘æ•°æ®ä¼ è¾“é‡ï¼Œæé«˜åŒæ­¥æ•ˆç‡

---

## ğŸ—ï¸ åŒæ­¥æ¨¡å¼è®¾è®¡

### ä¸‰ç§åŒæ­¥æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Full Mode (å…¨é‡åŒæ­¥)                                  â”‚
â”‚  - æ¯æ¬¡éƒ½åŒæ­¥æ‰€æœ‰æ•°æ®                                     â”‚
â”‚  - é€‚ç”¨åœºæ™¯: æ•°æ®é‡å°ã€éœ€è¦å®Œå…¨ä¸€è‡´                       â”‚
â”‚  - ä¼˜ç‚¹: ç®€å•å¯é                                         â”‚
â”‚  - ç¼ºç‚¹: æ•°æ®é‡å¤§æ—¶æ•ˆç‡ä½                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Skip Completed Mode (è·³è¿‡å·²å®Œæˆ)                     â”‚
â”‚  - ä»»åŠ¡å•å…ƒçº§åˆ«ï¼Œå·²å®Œæˆçš„å•å…ƒä¸å†æ‰§è¡Œ                     â”‚
â”‚  - é€‚ç”¨åœºæ™¯: å¤šè¡¨åŒæ­¥ï¼Œéƒ¨åˆ†è¡¨å·²å®Œæˆ                       â”‚
â”‚  - ä¼˜ç‚¹: æ”¯æŒæ–­ç‚¹ç»­ä¼                                     â”‚
â”‚  - ç¼ºç‚¹: å•ä¸ªè¡¨å†…çš„æ•°æ®ä»æ˜¯å…¨é‡                          â”‚
â”‚  - çŠ¶æ€: âœ… å·²å®ç°                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Incremental Mode (å¢é‡åŒæ­¥)                           â”‚
â”‚  - è®°å½•çº§åˆ«ï¼ŒåªåŒæ­¥æ–°å¢/ä¿®æ”¹çš„æ•°æ®                        â”‚
â”‚  - é€‚ç”¨åœºæ™¯: æ•°æ®é‡å¤§ã€é¢‘ç¹åŒæ­¥                          â”‚
â”‚  - ä¼˜ç‚¹: æ•ˆç‡é«˜ã€èŠ‚çœèµ„æº                                â”‚
â”‚  - ç¼ºç‚¹: éœ€è¦æ•°æ®æºæ”¯æŒå¢é‡å­—æ®µ                          â”‚
â”‚  - çŠ¶æ€: ğŸš§ å¾…å®ç°                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å¢é‡åŒæ­¥ç­–ç•¥

### ç­–ç•¥ 1: åŸºäºæ—¶é—´æˆ³ (Timestamp)

**åŸç†**: ä½¿ç”¨æ—¶é—´æˆ³å­—æ®µï¼ˆå¦‚ `updated_at`ï¼‰è¿‡æ»¤æ•°æ®

**SQL ç¤ºä¾‹**:
```sql
-- é¦–æ¬¡åŒæ­¥
SELECT * FROM users WHERE updated_at >= '1970-01-01 00:00:00';

-- å¢é‡åŒæ­¥
SELECT * FROM users WHERE updated_at > '2026-01-30 10:00:00';
```

**é€‚ç”¨åœºæ™¯**:
- âœ… è¡¨æœ‰ `created_at` æˆ– `updated_at` å­—æ®µ
- âœ… æ•°æ®æœ‰æ˜ç¡®çš„ä¿®æ”¹æ—¶é—´
- âœ… æ—¶é—´æˆ³å­—æ®µæœ‰ç´¢å¼•

**é…ç½®ç¤ºä¾‹**:
```json
{
  "syncMode": "incremental",
  "incrementalConfig": {
    "strategy": "timestamp",
    "field": "updated_at",
    "initialValue": "1970-01-01 00:00:00"
  }
}
```

### ç­–ç•¥ 2: åŸºäºè‡ªå¢ ID (Auto Increment)

**åŸç†**: ä½¿ç”¨è‡ªå¢ä¸»é”®è¿‡æ»¤æ•°æ®

**SQL ç¤ºä¾‹**:
```sql
-- é¦–æ¬¡åŒæ­¥
SELECT * FROM users WHERE id >= 0;

-- å¢é‡åŒæ­¥
SELECT * FROM users WHERE id > 12345;
```

**é€‚ç”¨åœºæ™¯**:
- âœ… è¡¨æœ‰è‡ªå¢ä¸»é”®
- âœ… åªéœ€è¦åŒæ­¥æ–°å¢æ•°æ®ï¼ˆä¸å…³å¿ƒä¿®æ”¹ï¼‰
- âœ… æ•°æ®ä¸ä¼šè¢«åˆ é™¤

**é…ç½®ç¤ºä¾‹**:
```json
{
  "syncMode": "incremental",
  "incrementalConfig": {
    "strategy": "autoIncrement",
    "field": "id",
    "initialValue": 0
  }
}
```

### ç­–ç•¥ 3: åŸºäºç‰ˆæœ¬å· (Version)

**åŸç†**: ä½¿ç”¨ç‰ˆæœ¬å·å­—æ®µè¿‡æ»¤æ•°æ®

**SQL ç¤ºä¾‹**:
```sql
-- é¦–æ¬¡åŒæ­¥
SELECT * FROM users WHERE version >= 0;

-- å¢é‡åŒæ­¥
SELECT * FROM users WHERE version > 100;
```

**é€‚ç”¨åœºæ™¯**:
- âœ… è¡¨æœ‰ç‰ˆæœ¬å·å­—æ®µ
- âœ… æ¯æ¬¡ä¿®æ”¹éƒ½ä¼šæ›´æ–°ç‰ˆæœ¬å·
- âœ… éœ€è¦è¿½è¸ªæ•°æ®å˜æ›´å†å²

**é…ç½®ç¤ºä¾‹**:
```json
{
  "syncMode": "incremental",
  "incrementalConfig": {
    "strategy": "version",
    "field": "version",
    "initialValue": 0
  }
}
```

---

## ğŸ”§ æ•°æ®æ¨¡å‹è®¾è®¡

### ä»»åŠ¡é…ç½®æ‰©å±•

```rust
/// åŒæ­¥é…ç½®
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct SyncConfig {
    pub thread_count: usize,
    pub batch_size: usize,
    pub error_strategy: String,
    
    // æ–°å¢ï¼šåŒæ­¥æ¨¡å¼
    #[serde(default = "default_sync_mode")]
    pub sync_mode: SyncMode,
    
    // æ–°å¢ï¼šå¢é‡åŒæ­¥é…ç½®ï¼ˆå¯é€‰ï¼‰
    #[serde(skip_serializing_if = "Option::is_none")]
    pub incremental_config: Option<IncrementalConfig>,
}

/// åŒæ­¥æ¨¡å¼
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
#[serde(rename_all = "camelCase")]
pub enum SyncMode {
    Full,           // å…¨é‡åŒæ­¥
    SkipCompleted,  // è·³è¿‡å·²å®Œæˆï¼ˆé»˜è®¤ï¼‰
    Incremental,    // å¢é‡åŒæ­¥
}

fn default_sync_mode() -> SyncMode {
    SyncMode::SkipCompleted
}

/// å¢é‡åŒæ­¥é…ç½®
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct IncrementalConfig {
    pub strategy: IncrementalStrategy,
    pub field: String,           // å¢é‡å­—æ®µå
    pub initial_value: String,   // åˆå§‹å€¼
}

/// å¢é‡åŒæ­¥ç­–ç•¥
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
#[serde(rename_all = "camelCase")]
pub enum IncrementalStrategy {
    Timestamp,      // åŸºäºæ—¶é—´æˆ³
    AutoIncrement,  // åŸºäºè‡ªå¢ID
    Version,        // åŸºäºç‰ˆæœ¬å·
}
```

### ä»»åŠ¡å•å…ƒçŠ¶æ€æ‰©å±•

```rust
/// ä»»åŠ¡å•å…ƒ
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct TaskUnit {
    pub id: String,
    pub task_id: String,
    pub unit_name: String,
    pub unit_type: TaskUnitType,
    pub status: String,
    pub total_records: i64,
    pub processed_records: i64,
    pub error_message: Option<String>,
    
    // æ–°å¢ï¼šå¢é‡åŒæ­¥çŠ¶æ€
    pub last_sync_value: Option<String>,  // ä¸Šæ¬¡åŒæ­¥çš„æœ€å¤§å€¼
    pub last_sync_time: Option<DateTime<Utc>>,  // ä¸Šæ¬¡åŒæ­¥æ—¶é—´
    
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}
```

### æ•°æ®åº“è¡¨æ‰©å±•

```sql
-- æ·»åŠ å¢é‡åŒæ­¥å­—æ®µ
ALTER TABLE task_units ADD COLUMN last_sync_value TEXT;
ALTER TABLE task_units ADD COLUMN last_sync_time INTEGER;
```

---

## ğŸ”„ æ‰§è¡Œæµç¨‹

### å…¨é‡åŒæ­¥æµç¨‹

```
ç”¨æˆ·é…ç½®: syncMode = "full"
   â†“
SyncEngine è§£æé…ç½®
   â†“
TaskManager è°ƒåº¦
   â†“
æ¯ä¸ªä»»åŠ¡å•å…ƒ:
   â”œâ”€ Reader.read_batch() - è¯»å–æ‰€æœ‰æ•°æ®
   â”œâ”€ Writer.write_batch() - å†™å…¥æ‰€æœ‰æ•°æ®
   â””â”€ å®Œæˆ
```

### è·³è¿‡å·²å®Œæˆæµç¨‹ï¼ˆå½“å‰å®ç°ï¼‰

```
ç”¨æˆ·é…ç½®: syncMode = "skipCompleted"
   â†“
SyncEngine è§£æé…ç½®
   â†“
TaskManager è°ƒåº¦
   â”œâ”€ è¿‡æ»¤: status != 'completed'
   â””â”€ åªæ‰§è¡Œæœªå®Œæˆçš„å•å…ƒ
   â†“
æ¯ä¸ªä»»åŠ¡å•å…ƒ:
   â”œâ”€ Reader.read_batch() - è¯»å–æ‰€æœ‰æ•°æ®
   â”œâ”€ Writer.write_batch() - å†™å…¥æ‰€æœ‰æ•°æ®
   â””â”€ æ ‡è®°ä¸º completed
```

### å¢é‡åŒæ­¥æµç¨‹ï¼ˆå¾…å®ç°ï¼‰

```
ç”¨æˆ·é…ç½®: 
  syncMode = "incremental"
  incrementalConfig = {
    strategy: "timestamp",
    field: "updated_at",
    initialValue: "1970-01-01 00:00:00"
  }
   â†“
SyncEngine è§£æé…ç½®
   â†“
TaskManager è°ƒåº¦
   â†“
æ¯ä¸ªä»»åŠ¡å•å…ƒ:
   â”œâ”€ ä»æ•°æ®åº“è¯»å– last_sync_value
   â”‚   â””â”€ å¦‚æœä¸ºç©ºï¼Œä½¿ç”¨ initialValue
   â†“
   â”œâ”€ Reader.read_incremental(field, last_sync_value)
   â”‚   â””â”€ SQL: WHERE updated_at > '2026-01-30 10:00:00'
   â†“
   â”œâ”€ Writer.write_batch() - å†™å…¥å¢é‡æ•°æ®
   â†“
   â”œâ”€ è®°å½•æœ¬æ¬¡åŒæ­¥çš„æœ€å¤§å€¼
   â”‚   â””â”€ last_sync_value = MAX(updated_at)
   â†“
   â””â”€ æ›´æ–°æ•°æ®åº“: UPDATE task_units SET last_sync_value = ?
```

---

## ğŸ“ é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹ 1: å…¨é‡åŒæ­¥

```json
{
  "units": ["users", "orders"],
  "syncConfig": {
    "threadCount": 2,
    "batchSize": 5000,
    "syncMode": "full"
  }
}
```

**è¡Œä¸º**: æ¯æ¬¡éƒ½åŒæ­¥æ‰€æœ‰æ•°æ®ï¼Œä¸ç®¡ä¹‹å‰æ˜¯å¦åŒæ­¥è¿‡

### ç¤ºä¾‹ 2: è·³è¿‡å·²å®Œæˆï¼ˆé»˜è®¤ï¼‰

```json
{
  "units": ["users", "orders", "products"],
  "syncConfig": {
    "threadCount": 3,
    "batchSize": 5000,
    "syncMode": "skipCompleted"
  }
}
```

**è¡Œä¸º**: 
- ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼šåŒæ­¥ usersã€ordersã€products
- ç¬¬äºŒæ¬¡æ‰§è¡Œï¼šå¦‚æœ users å·²å®Œæˆï¼ŒåªåŒæ­¥ ordersã€products

### ç¤ºä¾‹ 3: åŸºäºæ—¶é—´æˆ³çš„å¢é‡åŒæ­¥

```json
{
  "units": ["users", "orders"],
  "syncConfig": {
    "threadCount": 2,
    "batchSize": 5000,
    "syncMode": "incremental",
    "incrementalConfig": {
      "strategy": "timestamp",
      "field": "updated_at",
      "initialValue": "2026-01-01 00:00:00"
    }
  }
}
```

**è¡Œä¸º**:
- ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼šåŒæ­¥ `updated_at >= '2026-01-01 00:00:00'` çš„æ•°æ®
- ç¬¬äºŒæ¬¡æ‰§è¡Œï¼šåŒæ­¥ `updated_at > 'ä¸Šæ¬¡æœ€å¤§å€¼'` çš„æ•°æ®

### ç¤ºä¾‹ 4: åŸºäºè‡ªå¢IDçš„å¢é‡åŒæ­¥

```json
{
  "units": ["users"],
  "syncConfig": {
    "threadCount": 1,
    "batchSize": 5000,
    "syncMode": "incremental",
    "incrementalConfig": {
      "strategy": "autoIncrement",
      "field": "id",
      "initialValue": "0"
    }
  }
}
```

**è¡Œä¸º**:
- ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼šåŒæ­¥ `id >= 0` çš„æ•°æ®
- ç¬¬äºŒæ¬¡æ‰§è¡Œï¼šåŒæ­¥ `id > ä¸Šæ¬¡æœ€å¤§ID` çš„æ•°æ®

---

## ğŸ¯ å®ç°ä¼˜å…ˆçº§

### Phase 1: åŸºç¡€å¢é‡åŒæ­¥ âœ… å·²å®Œæˆ

- âœ… è·³è¿‡å·²å®Œæˆçš„ä»»åŠ¡å•å…ƒï¼ˆ`skipCompleted` æ¨¡å¼ï¼‰
- âœ… ä»»åŠ¡å•å…ƒçº§åˆ«çš„æ–­ç‚¹ç»­ä¼ 

### Phase 2: æ•°æ®çº§å¢é‡åŒæ­¥ ğŸš§ å¾…å®ç°

- â¬œ æ‰©å±•æ•°æ®æ¨¡å‹ï¼ˆ`SyncMode`ã€`IncrementalConfig`ï¼‰
- â¬œ æ‰©å±•æ•°æ®åº“è¡¨ï¼ˆ`last_sync_value`ã€`last_sync_time`ï¼‰
- â¬œ å®ç° Reader å¢é‡è¯»å–æ¥å£
- â¬œ å®ç° MySQL å¢é‡è¯»å–
- â¬œ å®ç° Elasticsearch å¢é‡è¯»å–
- â¬œ æ›´æ–° SyncEngine è§£æå¢é‡é…ç½®
- â¬œ æ›´æ–° TaskManager è®°å½•å¢é‡çŠ¶æ€

### Phase 3: é«˜çº§åŠŸèƒ½ ğŸ“… æœªæ¥

- â¬œ æ”¯æŒè‡ªå®šä¹‰å¢é‡æ¡ä»¶
- â¬œ æ”¯æŒå¤šå­—æ®µç»„åˆå¢é‡
- â¬œ æ”¯æŒåˆ é™¤æ•°æ®çš„åŒæ­¥
- â¬œ æ”¯æŒå†²çªè§£å†³ç­–ç•¥

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### MySQL å¢é‡è¯»å–å®ç°

```rust
impl MySqlReader {
    /// å¢é‡è¯»å–æ•°æ®
    pub async fn read_incremental(
        &mut self,
        field: &str,
        last_value: &str,
        batch_size: usize,
    ) -> Result<Vec<DataRecord>> {
        let query = format!(
            "SELECT * FROM {} WHERE {} > ? ORDER BY {} LIMIT ?",
            self.table_name, field, field
        );
        
        let rows = sqlx::query(&query)
            .bind(last_value)
            .bind(batch_size as i64)
            .fetch_all(&self.pool)
            .await?;
        
        // è½¬æ¢ä¸º DataRecord
        // ...
    }
    
    /// è·å–æœ€å¤§å€¼
    pub async fn get_max_value(&self, field: &str) -> Result<String> {
        let query = format!(
            "SELECT MAX({}) as max_value FROM {}",
            field, self.table_name
        );
        
        let row = sqlx::query(&query)
            .fetch_one(&self.pool)
            .await?;
        
        Ok(row.get("max_value"))
    }
}
```

### Elasticsearch å¢é‡è¯»å–å®ç°

```rust
impl ElasticsearchReader {
    /// å¢é‡è¯»å–æ•°æ®
    pub async fn read_incremental(
        &mut self,
        field: &str,
        last_value: &str,
        batch_size: usize,
    ) -> Result<Vec<DataRecord>> {
        let query = json!({
            "query": {
                "range": {
                    field: {
                        "gt": last_value
                    }
                }
            },
            "sort": [
                { field: "asc" }
            ],
            "size": batch_size
        });
        
        // æ‰§è¡ŒæŸ¥è¯¢
        // ...
    }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ ](./ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ .md) - ä»»åŠ¡è°ƒåº¦æœºåˆ¶
- [åŒæ­¥å¼•æ“å®ç°](../implementation/åŒæ­¥å¼•æ“å®ç°.md) - åŒæ­¥å¼•æ“è¯¦è§£
- [æ•°æ®äº¤æ¢æ¡†æ¶è®¾è®¡](../architecture/æ•°æ®äº¤æ¢æ¡†æ¶è®¾è®¡.md) - Exchange Framework

---

**æ–‡æ¡£ç»´æŠ¤**: DataTrac å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-30
