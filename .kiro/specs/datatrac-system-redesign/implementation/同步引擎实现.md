# åŒæ­¥å¼•æ“å®ç°è¯¦è§£

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° SyncEngine çš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬é…ç½®è¯»å–ã€ä»»åŠ¡è°ƒåº¦ã€è¿›åº¦æ›´æ–°ç­‰æ ¸å¿ƒé€»è¾‘ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-30  
**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### SyncEngine èŒè´£

1. **é…ç½®è§£æ**: ä»ä»»åŠ¡é…ç½®ä¸­è¯»å– `threadCount` å’Œ `batchSize`
2. **èµ„æºåŠ è½½**: åŠ è½½æ•°æ®æºä¿¡æ¯å’Œä»»åŠ¡å•å…ƒåˆ—è¡¨
3. **ä»»åŠ¡è°ƒåº¦**: è°ƒç”¨ TaskManager çš„å¹¶å‘æ‰§è¡Œå¼•æ“
4. **Pipeline åˆ›å»º**: ä½¿ç”¨ Exchange Framework åˆ›å»ºæ•°æ®ç®¡é“
5. **è¿›åº¦ç›‘æ§**: å®æ—¶æ›´æ–°å’Œæ¨é€ä»»åŠ¡è¿›åº¦

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¨¡å—ä¾èµ–

```
SyncEngine
  â”œâ”€ DataSourceManager (åŠ è½½æ•°æ®æº)
  â”œâ”€ TaskManager (ä»»åŠ¡è°ƒåº¦)
  â”œâ”€ ProgressMonitor (è¿›åº¦æ¨é€)
  â”œâ”€ TaskLogger (æ—¥å¿—è®°å½•)
  â””â”€ Exchange Framework
      â”œâ”€ ReaderFactory (åˆ›å»º Reader)
      â”œâ”€ WriterFactory (åˆ›å»º Writer)
      â””â”€ SyncPipeline (æ•°æ®ç®¡é“)
```

---

## ğŸ“Š å®Œæ•´æ‰§è¡Œæµç¨‹

### æµç¨‹å›¾

```
ç”¨æˆ·è°ƒç”¨ start_sync(task_id)
   â†“
1. åŠ è½½ä»»åŠ¡ä¿¡æ¯
   â”œâ”€ TaskManager.get_task(task_id)
   â””â”€ è·å– task.config JSON
   â†“
2. è§£æä»»åŠ¡é…ç½®
   â”œâ”€ serde_json::from_str(&task.config)
   â”œâ”€ æå– threadCount
   â”œâ”€ æå– batchSize
   â””â”€ æå– units åˆ—è¡¨
   â†“
3. åŠ è½½æ•°æ®æºä¿¡æ¯
   â”œâ”€ DataSourceManager.get_datasource(source_id)
   â”œâ”€ DataSourceManager.get_datasource(target_id)
   â””â”€ è·å–è¿æ¥ä¿¡æ¯
   â†“
4. åŠ è½½ä»»åŠ¡å•å…ƒ
   â”œâ”€ TaskManager.load_task_units_from_db(task_id)
   â””â”€ åŠ è½½åˆ°å†…å­˜ç¼“å­˜
   â†“
5. å¹¶å‘æ‰§è¡Œä»»åŠ¡å•å…ƒ
   â”œâ”€ TaskManager.execute_auto_mode()
   â”œâ”€ å¹¶å‘æ•° = threadCount
   â””â”€ æ¯ä¸ªå•å…ƒæ‰§è¡Œ process_fn
       â†“
       â”œâ”€ åˆ›å»º Reader (ReaderFactory)
       â”œâ”€ åˆ›å»º Writer (WriterFactory)
       â”œâ”€ åˆ›å»º Pipeline (batchSize)
       â”œâ”€ Pipeline.open()
       â”œâ”€ Pipeline.prepare()
       â”œâ”€ Pipeline.execute() - å¾ªç¯å¤„ç†æ‰¹æ¬¡
       â”‚   â””â”€ æ¯æ‰¹æ¬¡å®Œæˆ â†’ æ›´æ–°è¿›åº¦ â†’ æ¨é€äº‹ä»¶
       â””â”€ Pipeline.close()
   â†“
6. è¿”å›æ‰§è¡Œç»“æœ
   â””â”€ æˆåŠŸæ‰§è¡Œçš„å•å…ƒæ•°é‡
```

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. start_sync æ–¹æ³•

```rust
pub async fn start_sync(&self, task_id: &str) -> Result<()> {
    log::info!("å¯åŠ¨åŒæ­¥ä»»åŠ¡: {}", task_id);

    // 1. åŠ è½½ä»»åŠ¡ä¿¡æ¯
    let task = self
        .task_manager
        .get_task(task_id)
        .await?
        .ok_or_else(|| anyhow!("ä»»åŠ¡ä¸å­˜åœ¨: {}", task_id))?;

    // 2. è§£æä»»åŠ¡é…ç½®
    let config: TaskConfig = serde_json::from_str(&task.config)
        .map_err(|e| anyhow!("è§£æä»»åŠ¡é…ç½®å¤±è´¥: {}", e))?;

    log::info!(
        "ä»»åŠ¡é…ç½® - çº¿ç¨‹æ•°: {}, æ‰¹æ¬¡å¤§å°: {}",
        config.sync_config.thread_count,
        config.sync_config.batch_size
    );

    // 3. åŠ è½½æ•°æ®æºä¿¡æ¯
    let source_ds = self
        .datasource_manager
        .get_datasource(&task.source_id)
        .await?
        .ok_or_else(|| anyhow!("æºæ•°æ®æºä¸å­˜åœ¨: {}", task.source_id))?;

    let target_ds = self
        .datasource_manager
        .get_datasource(&task.target_id)
        .await?
        .ok_or_else(|| anyhow!("ç›®æ ‡æ•°æ®æºä¸å­˜åœ¨: {}", task.target_id))?;

    // 4. ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡å•å…ƒ
    self.task_manager
        .load_task_units_from_db(task_id)
        .await?;

    // 5. ä½¿ç”¨ TaskManager çš„è‡ªåŠ¨æ¨¡å¼æ‰§è¡Œ
    // ... (è§ä¸‹æ–‡)

    Ok(())
}
```

### 2. é…ç½®ç»“æ„

```rust
/// åŒæ­¥é…ç½®
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct SyncConfig {
    pub thread_count: usize,    // å¹¶å‘çº¿ç¨‹æ•°
    pub batch_size: usize,      // æ¯æ‰¹æ¬¡è®°å½•æ•°
    pub error_strategy: String, // é”™è¯¯å¤„ç†ç­–ç•¥
}

/// ä»»åŠ¡é…ç½®
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct TaskConfig {
    pub units: Vec<String>,     // ä»»åŠ¡å•å…ƒåˆ—è¡¨ (è¡¨å/ç´¢å¼•å)
    pub sync_config: SyncConfig, // åŒæ­¥é…ç½®
}
```

**JSON ç¤ºä¾‹**ï¼š
```json
{
  "units": ["users", "orders", "products"],
  "syncConfig": {
    "threadCount": 4,
    "batchSize": 2500,
    "errorStrategy": "skip"
  }
}
```

### 3. å¹¶å‘æ‰§è¡Œé€»è¾‘

```rust
let batch_size = config.sync_config.batch_size;
let source_ds_clone = source_ds.clone();
let target_ds_clone = target_ds.clone();
let task_id_str = task_id.to_string();
let task_manager_clone = self.task_manager.clone();
let progress_monitor_clone = self.progress_monitor.clone();

let success_count = self
    .task_manager
    .execute_auto_mode(
        task_id,
        config.sync_config.thread_count,  // â† ä»é…ç½®è¯»å–å¹¶å‘æ•°
        self.progress_monitor.clone(),
        move |_unit_id, unit_name| {
            // ä¸ºæ¯ä¸ªä»»åŠ¡å•å…ƒåˆ›å»ºç‹¬ç«‹çš„æ‰§è¡Œé€»è¾‘
            let source_ds = source_ds_clone.clone();
            let target_ds = target_ds_clone.clone();
            let task_id = task_id_str.clone();
            let task_manager = task_manager_clone.clone();
            let progress_monitor = progress_monitor_clone.clone();

            async move {
                // æ‰§è¡Œå•ä¸ªä»»åŠ¡å•å…ƒçš„åŒæ­¥
                // ... (è§ä¸‹æ–‡)
            }
        },
    )
    .await?;
```

**å…³é”®ç‚¹**ï¼š
- `thread_count` æ§åˆ¶å¹¶å‘æ•°
- æ¯ä¸ªä»»åŠ¡å•å…ƒç‹¬ç«‹æ‰§è¡Œ
- ä½¿ç”¨é—­åŒ…ä¼ é€’æ‰§è¡Œé€»è¾‘

### 4. å•ä¸ªä»»åŠ¡å•å…ƒæ‰§è¡Œ

```rust
async move {
    log::info!("å¼€å§‹åŒæ­¥å•å…ƒ: {}", unit_name);

    // åˆ›å»º Reader å’Œ Writer
    let reader = ReaderFactory::create(&source_ds, &unit_name)?;
    let writer = WriterFactory::create(&target_ds, &unit_name)?;

    // åˆ›å»º Pipeline
    let pipeline = SyncPipeline::new(
        reader, 
        writer, 
        batch_size  // â† ä»é…ç½®è¯»å–æ‰¹æ¬¡å¤§å°
    );

    // åˆå§‹åŒ– Pipeline
    pipeline.open().await?;
    pipeline.prepare().await?;

    // æ‰§è¡ŒåŒæ­¥ï¼Œå¸¦è¿›åº¦å›è°ƒ
    let unit_name_for_progress = unit_name.clone();
    let task_id_for_progress = task_id.clone();
    
    let total_processed = pipeline
        .execute(move |processed, total| {
            // æ¯æ‰¹æ¬¡å¤„ç†å®Œæˆåï¼Œæ›´æ–°è¿›åº¦
            let unit_name = unit_name_for_progress.clone();
            let task_id = task_id_for_progress.clone();
            let task_manager = task_manager.clone();
            let progress_monitor = progress_monitor.clone();

            // å¼‚æ­¥æ›´æ–°è¿›åº¦ï¼Œä¸é˜»å¡æ•°æ®å¤„ç†
            tokio::spawn(async move {
                if let Err(e) = task_manager
                    .update_unit_progress_with_sync(
                        &task_id,
                        &unit_name,
                        total as i64,
                        processed as i64,
                        &progress_monitor,
                    )
                    .await
                {
                    log::error!("æ›´æ–°è¿›åº¦å¤±è´¥: {}", e);
                }
            });
        })
        .await?;

    // å…³é—­ Pipeline
    pipeline.close().await?;

    log::info!(
        "å•å…ƒ {} åŒæ­¥å®Œæˆï¼Œå…±å¤„ç† {} æ¡è®°å½•",
        unit_name,
        total_processed
    );

    Ok(())
}
```

**å…³é”®ç‚¹**ï¼š
- `batch_size` æ§åˆ¶æ¯æ‰¹æ¬¡è®°å½•æ•°
- è¿›åº¦å›è°ƒä½¿ç”¨ `tokio::spawn` å¼‚æ­¥æ‰§è¡Œ
- ä¸é˜»å¡æ•°æ®å¤„ç†æµç¨‹

---

## ğŸ“Š é…ç½®å‚æ•°è¯´æ˜

### threadCount (çº¿ç¨‹æ•°)

**ä½œç”¨**: æ§åˆ¶å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡å•å…ƒæ•°é‡

**å–å€¼èŒƒå›´**: 1 - 20

**å½±å“**:
- å€¼è¶Šå¤§ï¼Œå¹¶å‘åº¦è¶Šé«˜ï¼Œé€Ÿåº¦è¶Šå¿«
- ä½†ä¼šå¢åŠ ç³»ç»Ÿèµ„æºå ç”¨ï¼ˆCPUã€å†…å­˜ã€æ•°æ®åº“è¿æ¥ï¼‰
- å»ºè®®æ ¹æ®ç³»ç»Ÿé…ç½®å’Œæ•°æ®æºæ€§èƒ½è°ƒæ•´

**ç¤ºä¾‹**:
```json
{
  "syncConfig": {
    "threadCount": 4  // åŒæ—¶æ‰§è¡Œ4ä¸ªè¡¨çš„åŒæ­¥
  }
}
```

**æ‰§è¡Œæ•ˆæœ**:
- å¦‚æœæœ‰ 10 ä¸ªè¡¨éœ€è¦åŒæ­¥
- å‰ 4 ä¸ªè¡¨å¹¶å‘æ‰§è¡Œ
- å®Œæˆä¸€ä¸ªåï¼Œå¯åŠ¨ä¸‹ä¸€ä¸ª
- ç›´åˆ°æ‰€æœ‰è¡¨å®Œæˆ

### batchSize (æ‰¹æ¬¡å¤§å°)

**ä½œç”¨**: æ§åˆ¶æ¯æ‰¹æ¬¡è¯»å–å’Œå†™å…¥çš„è®°å½•æ•°

**å–å€¼èŒƒå›´**: 100 - 10000

**å½±å“**:
- å€¼è¶Šå¤§ï¼Œæ‰¹æ¬¡è¶Šå°‘ï¼Œé€Ÿåº¦è¶Šå¿«
- ä½†ä¼šå¢åŠ å†…å­˜å ç”¨
- å»ºè®®æ ¹æ®è®°å½•å¤§å°å’Œå†…å­˜å®¹é‡è°ƒæ•´

**ç¤ºä¾‹**:
```json
{
  "syncConfig": {
    "batchSize": 2500  // æ¯æ‰¹æ¬¡å¤„ç†2500æ¡è®°å½•
  }
}
```

**æ‰§è¡Œæ•ˆæœ**:
- å¦‚æœè¡¨æœ‰ 10000 æ¡è®°å½•
- åˆ† 4 ä¸ªæ‰¹æ¬¡æ‰§è¡Œ
- æ¯æ‰¹æ¬¡æ¨é€ä¸€æ¬¡è¿›åº¦äº‹ä»¶
- å‰ç«¯çœ‹åˆ° 4 æ¬¡è¿›åº¦æ›´æ–°

---

## ğŸ”„ æ•°æ®æµè½¬

### å®Œæ•´æ•°æ®æµ

```
é…ç½® JSON
   â†“
SyncEngine è§£æ
   â”œâ”€ threadCount = 4
   â””â”€ batchSize = 2500
   â†“
TaskManager è°ƒåº¦
   â”œâ”€ åˆ›å»º 4 ä¸ªå¹¶å‘ä»»åŠ¡
   â””â”€ æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹æ‰§è¡Œ
   â†“
æ¯ä¸ªä»»åŠ¡å•å…ƒ:
   â”œâ”€ ReaderFactory.create()
   â”‚   â””â”€ æ ¹æ®æ•°æ®æºç±»å‹åˆ›å»º Reader
   â”‚       â”œâ”€ MySQL â†’ MySqlReader
   â”‚       â””â”€ ES â†’ ElasticsearchReader
   â†“
   â”œâ”€ WriterFactory.create()
   â”‚   â””â”€ æ ¹æ®æ•°æ®æºç±»å‹åˆ›å»º Writer
   â”‚       â”œâ”€ MySQL â†’ MySqlWriter
   â”‚       â””â”€ ES â†’ ElasticsearchWriter
   â†“
   â”œâ”€ SyncPipeline.new(reader, writer, batchSize)
   â”‚   â””â”€ åˆ›å»ºæ•°æ®ç®¡é“
   â†“
   â”œâ”€ Pipeline.execute()
   â”‚   â””â”€ å¾ªç¯å¤„ç†æ‰¹æ¬¡
   â”‚       â”œâ”€ reader.read_batch(batchSize)  â† è¯»å– 2500 æ¡
   â”‚       â”œâ”€ transformer.transform()
   â”‚       â”œâ”€ writer.write_batch()          â† å†™å…¥ 2500 æ¡
   â”‚       â””â”€ è¿›åº¦å›è°ƒ
   â”‚           â”œâ”€ update_unit_progress_with_sync()
   â”‚           â”œâ”€ æ›´æ–°æ•°æ®åº“
   â”‚           â””â”€ æ¨é€å‰ç«¯äº‹ä»¶
   â†“
   â””â”€ è¿”å›å¤„ç†çš„æ€»è®°å½•æ•°
```

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘æ§åˆ¶

```rust
// ä½¿ç”¨ Semaphore æ§åˆ¶å¹¶å‘æ•°
let semaphore = Arc::new(Semaphore::new(concurrency));

for unit in pending_units {
    let _permit = semaphore.acquire().await.unwrap();
    // æ‰§è¡Œä»»åŠ¡
    // è®¸å¯ä¼šåœ¨ä»»åŠ¡å®Œæˆåè‡ªåŠ¨é‡Šæ”¾
}
```

**ä¼˜åŠ¿**:
- ç²¾ç¡®æ§åˆ¶å¹¶å‘æ•°
- é¿å…èµ„æºè€—å°½
- è‡ªåŠ¨æ’é˜Ÿç­‰å¾…

### 2. å¼‚æ­¥è¿›åº¦æ›´æ–°

```rust
// ä½¿ç”¨ tokio::spawn å¼‚æ­¥æ›´æ–°è¿›åº¦
tokio::spawn(async move {
    task_manager.update_unit_progress_with_sync(...).await
});
```

**ä¼˜åŠ¿**:
- ä¸é˜»å¡æ•°æ®å¤„ç†
- æé«˜ååé‡
- å³ä½¿æ›´æ–°å¤±è´¥ä¹Ÿä¸å½±å“åŒæ­¥

### 3. æ‰¹é‡å¤„ç†

```rust
// æ¯æ‰¹æ¬¡å¤„ç† batchSize æ¡è®°å½•
let batch = reader.read_batch(batch_size).await?;
writer.write_batch(batch).await?;
```

**ä¼˜åŠ¿**:
- å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
- æé«˜æ•°æ®åº“å†™å…¥æ•ˆç‡
- é™ä½ç³»ç»Ÿè°ƒç”¨å¼€é”€

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: MySQL â†’ MySQL

**é…ç½®**:
```json
{
  "units": ["users", "orders", "products"],
  "syncConfig": {
    "threadCount": 3,
    "batchSize": 5000
  }
}
```

**æ‰§è¡Œè¿‡ç¨‹**:
1. 3 ä¸ªè¡¨å¹¶å‘æ‰§è¡Œ
2. æ¯ä¸ªè¡¨æ¯æ‰¹æ¬¡å¤„ç† 5000 æ¡è®°å½•
3. å‡è®¾æ¯ä¸ªè¡¨ 20000 æ¡è®°å½•
4. æ¯ä¸ªè¡¨åˆ† 4 ä¸ªæ‰¹æ¬¡
5. æ€»å…±æ¨é€ 3 Ã— (1 + 4 + 1) = 18 æ¬¡äº‹ä»¶

### ç¤ºä¾‹ 2: ES â†’ MySQL

**é…ç½®**:
```json
{
  "units": ["index-a", "index-b"],
  "syncConfig": {
    "threadCount": 2,
    "batchSize": 1000
  }
}
```

**æ‰§è¡Œè¿‡ç¨‹**:
1. 2 ä¸ªç´¢å¼•å¹¶å‘æ‰§è¡Œ
2. æ¯ä¸ªç´¢å¼•æ¯æ‰¹æ¬¡å¤„ç† 1000 æ¡è®°å½•
3. ä½¿ç”¨ ES Scroll API è¯»å–
4. å†™å…¥ MySQL è¡¨

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: é…ç½®è§£æå¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `è§£æä»»åŠ¡é…ç½®å¤±è´¥`

**å¯èƒ½åŸå› **:
1. JSON æ ¼å¼é”™è¯¯
2. å­—æ®µåä¸åŒ¹é… (camelCase)
3. æ•°æ®ç±»å‹é”™è¯¯

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥ JSON æ ¼å¼
2. ç¡®è®¤å­—æ®µå: `threadCount`, `batchSize`
3. ç¡®è®¤æ•°æ®ç±»å‹: éƒ½æ˜¯æ•°å­—

### é—®é¢˜ 2: æ•°æ®æºä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**: `æºæ•°æ®æºä¸å­˜åœ¨` æˆ– `ç›®æ ‡æ•°æ®æºä¸å­˜åœ¨`

**å¯èƒ½åŸå› **:
1. æ•°æ®æº ID é”™è¯¯
2. æ•°æ®æºå·²è¢«åˆ é™¤

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥ä»»åŠ¡é…ç½®ä¸­çš„ `source_id` å’Œ `target_id`
2. ç¡®è®¤æ•°æ®æºå­˜åœ¨äºæ•°æ®åº“ä¸­

### é—®é¢˜ 3: ä»»åŠ¡å•å…ƒæ‰§è¡Œå¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `ä»»åŠ¡å•å…ƒæ‰§è¡Œå¤±è´¥`

**å¯èƒ½åŸå› **:
1. Reader åˆ›å»ºå¤±è´¥ (è¿æ¥å¤±è´¥)
2. Writer åˆ›å»ºå¤±è´¥ (æƒé™ä¸è¶³)
3. Pipeline æ‰§è¡Œå¤±è´¥ (æ•°æ®æ ¼å¼é”™è¯¯)

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥æ•°æ®æºè¿æ¥
2. æ£€æŸ¥æ•°æ®æºæƒé™
3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [äº‹ä»¶æ¨é€ä¸çŠ¶æ€åŒæ­¥](./äº‹ä»¶æ¨é€ä¸çŠ¶æ€åŒæ­¥.md) - è¿›åº¦æ¨é€æœºåˆ¶
- [ä»»åŠ¡ç®¡ç†å™¨è®¾è®¡](../features/ä»»åŠ¡ç®¡ç†å™¨.md) - ä»»åŠ¡è°ƒåº¦å¼•æ“
- [æ•°æ®äº¤æ¢æ¡†æ¶è®¾è®¡](../architecture/æ•°æ®äº¤æ¢æ¡†æ¶è®¾è®¡.md) - Exchange Framework
- [ä»»åŠ¡é…ç½®](../features/ä»»åŠ¡é…ç½®.md) - é…ç½®é¡¹è¯´æ˜

---

**æ–‡æ¡£ç»´æŠ¤**: DataTrac å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-30
