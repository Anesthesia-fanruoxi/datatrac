# DataTrac 系统设计概览

## 📋 文档说明

本文档是 DataTrac 数据同步系统的设计概览，提供系统的整体架构和功能模块的简要说明。详细设计请参考各子文档。

**文档版本**: v2.0  
**最后更新**: 2026-01-30  
**状态**: 进行中

---

## 🎯 系统简介

DataTrac 是一个基于 Tauri 2.x + Vue 3 的桌面数据同步工具，支持 MySQL 和 Elasticsearch 之间的双向数据同步。

**核心特性**:
- ✅ 支持 4 种同步方向（MySQL↔ES, MySQL↔MySQL, ES↔ES）
- ✅ 可视化任务配置向导
- ✅ 实时任务监控和进度展示
- ✅ 断点续传（以表/索引为单位）
- ✅ 并发控制和任务调度
- ✅ 分类日志系统
- ✅ 数据源加密存储

---

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    前端层 (Vue 3 + TypeScript)               │
│  ┌──────────────┬──────────────┬──────────────────────────┐ │
│  │  Views       │  Components  │  Stores (Pinia)          │ │
│  │  页面视图     │  UI组件      │  状态管理                 │ │
│  └──────────────┴──────────────┴──────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                    ↕ Tauri IPC (Command + Event)
┌─────────────────────────────────────────────────────────────┐
│                    后端层 (Rust + Tauri 2.x)                 │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  核心底座 (The Base)                                   │  │
│  │  ├─ Exchange Framework (Reader/Writer/Transformer)    │  │
│  │  ├─ TaskManager (调度器 & 并发控制)                   │  │
│  │  └─ ProgressMonitor (监控 & 日志)                     │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  应用逻辑 (App Logic)                                  │  │
│  │  ├─ SyncEngine (管道组装工厂)                         │  │
│  │  └─ DataSourceManager (连接管理)                      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

**详细架构设计**:
- [前端架构](./architecture/前端架构.md) ✅
- [后端架构](./architecture/后端架构.md) ✅
- [数据交换框架](./architecture/数据交换框架设计.md) ⭐新底座
- [数据库设计](./architecture/数据库设计.md) ✅

---

## 🎨 核心功能模块

### 1. 数据交换框架 (Exchange Framework) ⭐ 完美底座
通过抽象 Reader 和 Writer 接口，实现“一套代码支持所有组合”。
- **Reader**: 负责数据提取（MySQL, ES, Mongo...）
- **Writer**: 负责数据装载
- **Transformer**: 负责中间数据处理
- **DataRecord**: 统一的中间数据格式

### 2. 任务管理器 (TaskManager)
统一调度中心，负责将数据管道（Pipeline）并行化运行，处理断点续传。

### 3. 同步引擎 (SyncEngine)
不再直接编写同步逻辑，而是作为“工厂”根据任务配置（如 MySQL -> Mongo）动态生产 Pipeline。

### 6. 日志分类系统 ⭐ 新增
提供四种分类日志，满足不同场景的查看需求。

**详细设计**: [日志分类系统](./features/日志分类系统.md)

**日志类型**:
- **实时日志 (Realtime)**: 所有详细信息
- **明细日志 (Summary)**: 批次级别摘要
- **校验日志 (Verify)**: 数据校验结果
- **错误日志 (Error)**: 错误和警告信息

### 7. 任务监控
实时展示任务执行进度、任务单元状态、日志信息。

**详细设计**: 参考现有 design.md 第2章

---

## 🗄️ 数据库设计

### 核心表结构

**1. sync_tasks - 任务主表**
- 存储任务基本信息
- 扩展字段：sync_mode（同步模式，目前仅支持 auto）

**2. task_unit_configs - 任务单元配置表**
- 存储要同步的表/索引列表
- 从任务配置中提取

**3. task_unit_runtimes - 任务单元运行记录表**
- 存储任务单元的执行状态和进度
- 支持断点续传

**详细设计**: [数据库设计](./architecture/数据库设计.md)

---

## 🔄 核心工作流程

### 任务执行流程

```
1. 用户启动任务
   ↓
2. TaskLoader 加载任务配置
   ↓
3. TaskLoader 初始化任务单元
   - 从配置表读取单元列表
   - 创建/更新运行记录表
   - 支持断点续传（已完成的保持状态）
   ↓
4. TaskManager 加载任务单元
   - 从运行记录表加载
   - 过滤出未完成的单元
   ↓
5. TaskManager 自动模式执行
   - 使用 Semaphore 控制并发
   - 并发执行所有未完成单元
   - 实时更新状态到数据库
   ↓
6. SyncEngine 执行同步
   - 读取源数据
   - 转换数据格式
   - 写入目标数据源
   - 更新进度
   ↓
7. ProgressMonitor 推送进度
   - 聚合任务单元状态
   - 计算总体进度
   - 推送到前端
   ↓
8. 任务完成/失败
```

---

## 📊 技术栈

### 前端
- **框架**: Vue 3 + TypeScript
- **UI库**: Naive UI
- **状态管理**: Pinia
- **构建工具**: Vite

### 后端
- **框架**: Tauri 2.x
- **语言**: Rust
- **异步运行时**: Tokio
- **数据库**: SQLite (rusqlite)
- **HTTP客户端**: reqwest
- **MySQL客户端**: sqlx
- **ES客户端**: elasticsearch-rs

### 数据库
- **元数据**: SQLite
- **数据源**: MySQL, Elasticsearch

---

## 📝 命名规范

### 统一使用 camelCase

**前端 (TypeScript)**:
```typescript
interface TaskProgress {
  taskId: string;
  totalRecords: number;
  processedRecords: number;
}
```

**后端 (Rust)**:
```rust
#[derive(Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct TaskProgress {
    pub task_id: String,
    pub total_records: u64,
    pub processed_records: u64,
}
```

**数据库 (SQLite)**:
```sql
-- 表名和字段名使用 snake_case
CREATE TABLE task_unit_runtimes (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    unit_name TEXT NOT NULL
);
```

**说明**: 
- 前端和后端通信使用 camelCase
- Rust 内部使用 snake_case，通过 serde 自动转换
- 数据库使用 snake_case

---

## 🚀 开发状态

### 已完成 ✅
- [x] 数据源管理
- [x] 任务配置向导
- [x] 任务管理器（自动模式）
- [x] 断点续传（三表结构）
- [x] 日志分类系统
- [x] ES→ES 同步实现
- [x] 实时进度监控

### 进行中 🚧
- [ ] MySQL→MySQL 同步实现
- [ ] MySQL→ES 同步实现
- [ ] ES→MySQL 同步实现
- [ ] 前端队列管理界面（已废弃手动模式）

### 待规划 📋
- [ ] 数据校验功能增强
- [ ] 任务调度策略（定时任务）
- [ ] 性能优化和监控

---

## 📚 相关文档

### 架构设计
- [前端架构](./architecture/前端架构.md) ✅
- [后端架构](./architecture/后端架构.md) ✅
- [前后端通讯](./architecture/前后端通讯.md) ✅
- [数据库设计](./architecture/数据库设计.md) ✅
- [技术规范](./architecture/技术规范.md) ✅
- [API接口设计](./architecture/API接口设计.md) ✅

### 功能设计
- [任务管理器](./features/任务管理器.md) ⭐ ✅
- [任务调度与断点续传](./features/任务调度与断点续传.md) ⭐ ✅
- [日志分类系统](./features/日志分类系统.md) ⭐ ✅
- [同步引擎](./features/同步引擎.md) ✅
- [数据源管理](./features/数据源管理.md) ✅
- [任务配置](./features/任务配置.md) ✅
- [工具模块](./features/工具模块.md) ✅

### 设计规范
- [UI设计](./design/UI设计.md) ✅
- [交互设计](./design/交互设计.md) ✅

### 实现细节
- [任务管理器实现](./implementation/任务管理器实现.md) ⭐
- [自动模式实现](./implementation/自动模式实现.md) ⭐
- [断点续传实现](./implementation/断点续传实现.md) ⭐

### 其他文档
- [需求文档](./requirements.md)
- [任务清单](./tasks.md)
- [原设计文档](./design.md)（保留作为参考）

---

## 📞 联系方式

如有问题或建议，请联系开发团队。

**文档维护**: DataTrac 开发团队  
**最后更新**: 2026-01-30
