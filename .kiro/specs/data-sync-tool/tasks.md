# 实现计划：数据同步工具

## 概述

本实现计划将数据同步工具的开发分解为一系列增量式的编码任务。每个任务都基于前面的任务构建，最终完成一个功能完整的桌面应用。

## 任务列表

- [x] 1. 初始化项目结构
  - 使用 Tauri CLI 创建项目骨架
  - 配置 Vue3 + TypeScript + Vite
  - 安装 Naive UI 和 Pinia
  - 配置 Rust 依赖（sqlx, elasticsearch, tokio, serde, aes-gcm）
  - 设置项目目录结构
  - _需求: 9.1_

- [x] 2. 实现加密服务模块
  - [x] 2.1 创建 CryptoService 结构体
    - 实现 AES-256-GCM 加密和解密方法
    - 实现密钥生成和加载逻辑
    - _需求: 8.1, 8.2, 8.3_
  
  - [ ]* 2.2 编写加密服务的属性测试
    - **属性 3: 密码加解密往返**
    - **验证: 需求 8.1, 8.2, 8.3**

- [x] 3. 实现存储层（SQLite）
  - [x] 3.1 创建 Storage 结构体和数据库 schema
    - 定义数据源表、同步任务表、加密密钥表
    - 实现数据库初始化方法
    - _需求: 12.4_
  
  - [x] 3.2 实现数据源的 CRUD 操作
    - save_data_source, load_data_sources, delete_data_source
    - _需求: 1.1, 1.4, 1.5, 12.1_
  
  - [x] 3.3 实现同步任务的 CRUD 操作
    - save_task, load_tasks, delete_task
    - _需求: 3.9, 12.2_
  
  - [ ]* 3.4 编写存储层的属性测试
    - **属性 1: 数据源持久化往返一致性**
    - **验证: 需求 1.1, 1.3, 12.1**
    - **属性 6: 同步任务持久化往返一致性**
    - **验证: 需求 3.9, 12.2**


- [x] 4. 实现数据源管理器
  - [x] 4.1 创建 DataSourceManager 结构体
    - 集成 Storage 和 CryptoService
    - 实现数据源的增删改查方法
    - 密码字段自动加密/解密
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_
  
  - [x] 4.2 实现 MySQL 连接测试
    - 使用 sqlx 连接 MySQL
    - 验证连接参数
    - 返回连接结果
    - _需求: 1.6, 2.1, 2.2, 2.3, 2.4_
  
  - [x] 4.3 实现 Elasticsearch 连接测试
    - 使用 elasticsearch crate 连接 ES
    - 验证连接参数
    - 返回连接结果
    - _需求: 1.6, 2.1, 2.2, 2.3, 2.5_
  
  - [x] 4.4 实现数据库元数据查询
    - get_databases: 获取 MySQL 数据库列表
    - get_tables: 获取指定数据库的表列表
    - get_indices: 获取 ES 索引列表
    - match_indices: 通配符匹配 ES 索引
    - _需求: 3.2, 3.3, 3.4, 3.5, 3.6_
  
  - [ ]* 4.5 编写数据源管理器的属性测试
    - **属性 2: 密码加密存储**
    - **验证: 需求 1.3, 8.1**
    - **属性 4: 数据源更新保持 ID 不变**
    - **验证: 需求 1.4**
    - **属性 5: 数据源删除后不可访问**
    - **验证: 需求 1.5**
    - **属性 7: 通配符索引匹配正确性**
    - **验证: 需求 3.5, 3.6**

- [-] 5. 实现类型映射器
  - [x] 5.1 创建 TypeMapper 结构体
    - 实现 mysql_to_es 方法（MySQL 类型 → ES 类型）
    - 实现 es_to_mysql 方法（ES 类型 → MySQL 类型）
    - 实现 map_primary_key 方法（主键映射）
    - _需求: 3.7, 3.8, 10.1, 10.2, 10.3, 10.4, 10.5_
  
  - [ ]* 5.2 编写类型映射器的单元测试
    - 测试常见类型映射（INT, VARCHAR, TEXT, DATE 等）
    - 测试边界情况和未知类型
    - _需求: 10.3, 10.4_
  
  - [ ]* 5.3 编写类型映射器的属性测试
    - **属性 8: MySQL 到 ES 类型映射一致性**
    - **验证: 需求 3.7, 10.1, 10.3**
    - **属性 9: ES 到 MySQL 类型映射一致性**
    - **验证: 需求 3.8, 10.2, 10.3**
    - **属性 10: 主键映射为 _id**
    - **验证: 需求 10.5**


- [x] 6. 实现进度监控器
  - [x] 6.1 创建 ProgressMonitor 结构体
    - 使用 Arc<RwLock<HashMap>> 存储任务进度
    - 实现进度跟踪方法（start_task, update_progress, complete_task, fail_task）
    - 实现进度计算逻辑（百分比、速度、预估时间）
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_
  
  - [x] 6.2 实现进度事件发送
    - 使用 Tauri 的 emit 方法发送进度更新到前端
    - 定义进度事件的数据结构
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_
  
  - [ ]* 6.3 编写进度监控器的属性测试
    - **属性 16: 进度百分比计算正确性**
    - **验证: 需求 6.1, 6.2**
    - **属性 17: 同步速度计算正确性**
    - **验证: 需求 6.3**


- [x] 7. 实现错误日志器
  - [x] 7.1 创建 ErrorLogger 结构体
    - 使用 Arc<RwLock<HashMap>> 存储任务错误日志
    - 实现错误记录方法（log_error, get_errors, clear_errors, get_error_count）
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [x] 7.2 实现错误事件发送
    - 使用 Tauri 的 emit 方法发送错误事件到前端
    - 定义错误日志的数据结构（时间戳、错误类型、消息、相关数据）
    - _需求: 7.2_
  
  - [ ]* 7.3 编写错误日志器的属性测试
    - **属性 18: 错误日志包含必要信息**
    - **验证: 需求 7.2**
    - **属性 19: 错误日志不持久化**
    - **验证: 需求 7.5**


- [x] 8. 实现同步引擎（核心模块）
  - [x] 8.1 创建 SyncEngine 结构体
    - 集成 DataSourceManager, ProgressMonitor, ErrorLogger
    - 定义同步任务状态管理（使用 Arc<RwLock<HashMap>>）
    - _需求: 4.1_
  
  - [x] 8.2 实现任务控制方法
    - start_sync: 启动同步任务
    - pause_sync: 暂停同步任务
    - resume_sync: 恢复同步任务
    - _需求: 4.1, 5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [x] 8.3 实现目标表/索引删除和重建
    - drop_and_create_mysql_table: 删除并重建 MySQL 表
    - drop_and_create_es_index: 删除并重建 ES 索引
    - 根据源表结构自动生成目标表结构（使用 TypeMapper）
    - _需求: 4.2, 4.3, 4.4, 4.5, 4.6_
  
  - [x] 8.4 实现 MySQL 到 ES 同步
    - 读取 MySQL 表数据（分批读取）
    - 类型转换（使用 TypeMapper）
    - 主键映射为 _id
    - 使用 ES bulk API 批量插入
    - _需求: 3.7, 4.7, 4.8, 10.1, 10.5, 11.4_
  
  - [x] 8.5 实现 ES 到 MySQL 同步
    - 读取 ES 索引数据（使用 scroll API 分批读取）
    - 类型转换（使用 TypeMapper）
    - _id 映射为主键
    - 使用 MySQL batch insert 批量插入
    - _需求: 3.8, 4.7, 4.8, 10.2, 11.3_
  
  - [x] 8.6 实现 MySQL 到 MySQL 同步
    - 读取源 MySQL 表数据
    - 批量插入到目标 MySQL
    - _需求: 4.7, 4.8, 11.3_
  
  - [x] 8.7 实现 ES 到 ES 同步
    - 读取源 ES 索引数据
    - 批量插入到目标 ES
    - _需求: 4.7, 4.8, 11.4_
  
  - [x] 8.8 实现并发处理和批量优化
    - 使用 Tokio 的 spawn 创建并发任务
    - 根据配置的线程数控制并发度
    - 根据目标类型自适应批量大小
    - _需求: 4.7, 4.8, 11.1, 11.2, 11.3, 11.4, 11.5_
  
  - [x] 8.9 实现错误处理策略
    - "跳过错误"：记录错误并继续
    - "遇错暂停"：暂停任务并更新状态
    - _需求: 3.12, 4.9, 4.10_
  
  - [x] 8.10 集成进度监控和错误日志
    - 在同步过程中实时更新进度
    - 记录错误到 ErrorLogger
    - 发送事件到前端
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 7.1, 7.2_
  
  - [ ]* 8.11 编写同步引擎的属性测试
    - **属性 11: 目标表/索引删除重建**
    - **验证: 需求 4.2, 4.3, 4.4, 4.5, 4.6**
    - **属性 12: 批量大小自适应**
    - **验证: 需求 4.8, 11.3, 11.4**
    - **属性 13: 错误跳过策略**
    - **验证: 需求 4.9**
    - **属性 14: 错误暂停策略**
    - **验证: 需求 4.10**
    - **属性 15: 任务状态转换正确性**
    - **验证: 需求 5.1, 5.2, 5.3, 5.4, 5.5**
    - **属性 20: 线程数配置范围**
    - **验证: 需求 11.1**


- [x] 9. 实现 Tauri Commands（前后端通信层）
  - [ ] 9.1 实现数据源管理相关 Commands
    - list_data_sources: 获取所有数据源
    - get_data_source: 获取单个数据源
    - create_data_source: 创建数据源
    - update_data_source: 更新数据源
    - delete_data_source: 删除数据源
    - test_connection: 测试连接
    - _需求: 1.1, 1.4, 1.5, 1.6, 9.2_
  
  - [ ] 9.2 实现元数据查询相关 Commands
    - get_databases: 获取 MySQL 数据库列表
    - get_tables: 获取 MySQL 表列表
    - get_indices: 获取 ES 索引列表
    - match_indices: 通配符匹配 ES 索引
    - _需求: 3.2, 3.3, 3.4, 3.5, 3.6_
  
  - [ ] 9.3 实现同步任务管理相关 Commands
    - list_tasks: 获取所有任务
    - get_task: 获取单个任务
    - create_task: 创建任务
    - update_task: 更新任务
    - delete_task: 删除任务
    - _需求: 3.9, 9.3_
  
  - [ ] 9.4 实现任务执行控制相关 Commands
    - start_sync: 启动同步任务
    - pause_sync: 暂停同步任务
    - resume_sync: 恢复同步任务
    - get_progress: 获取任务进度
    - get_errors: 获取错误日志
    - _需求: 4.1, 5.1, 5.2, 5.3, 5.4, 6.1, 7.3, 9.4_
  
  - [ ] 9.5 配置 Tauri 应用
    - 在 main.rs 中注册所有 Commands
    - 配置应用窗口和权限
    - 初始化后端服务（Storage, CryptoService, DataSourceManager, SyncEngine）
    - _需求: 9.1_


- [x] 10. 实现前端状态管理（Pinia Stores）
  - [x] 10.1 创建 DataSource Store
    - 定义 DataSource 接口和状态
    - 实现数据源的增删改查方法
    - 调用 Tauri Commands
    - _需求: 1.1, 1.4, 1.5, 1.6, 9.2_
  
  - [x] 10.2 创建 SyncTask Store
    - 定义 SyncTask 接口和状态
    - 实现任务的增删改查方法
    - 实现元数据查询方法（数据库、表、索引）
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.9, 9.3_
  
  - [x] 10.3 创建 TaskMonitor Store
    - 定义 TaskProgress 和 ErrorLog 接口
    - 实现任务控制方法（启动、暂停、恢复）
    - 监听后端进度和错误事件（使用 Tauri 的 listen API）
    - _需求: 5.1, 5.2, 5.3, 6.1, 6.2, 6.3, 6.4, 6.5, 7.3, 9.4_

- [x] 11. 实现前端 UI 组件（Vue3 + Naive UI）
  - [x] 11.1 创建数据源管理页面
    - 数据源列表展示（使用 n-data-table）
    - 添加/编辑数据源对话框（使用 n-modal, n-form）
    - 密码显示/隐藏切换（使用 n-input type="password"）
    - 测试连接按钮和结果提示
    - 删除确认对话框
    - _需求: 1.1, 1.2, 1.4, 1.5, 1.6, 9.2, 9.5, 9.6_
  
  - [x] 11.2 创建同步任务配置页面
    - 任务列表展示
    - 创建/编辑任务对话框
    - 源和目标数据源选择（使用 n-select）
    - MySQL 数据库和表选择（使用 n-tree 或 n-checkbox-group）
    - ES 索引选择和通配符匹配（显示匹配数量和预览）
    - 同步参数配置（线程数、批量大小、错误策略）
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.9, 3.11, 3.12, 9.3_
  
  - [x] 11.3 创建任务执行监控页面
    - 任务状态展示
    - 进度条和百分比显示（使用 n-progress）
    - 实时数据展示（已同步/总记录数、速度、预估时间）
    - 任务控制按钮（启动、暂停、恢复）
    - 错误日志列表（使用 n-log 或 n-data-table）
    - _需求: 5.1, 5.2, 5.3, 6.1, 6.2, 6.3, 6.4, 6.5, 7.3, 7.4, 9.4_
  
  - [x] 11.4 创建路由和布局
    - 配置 Vue Router（数据源管理、任务配置、任务监控）
    - 创建主布局组件（使用 n-layout, n-menu）
    - 实现页面导航
    - _需求: 9.2, 9.3, 9.4_
  
  - [x] 11.5 实现全局提示和错误处理
    - 配置 Naive UI 的 message 和 notification
    - 统一处理 API 调用的成功和失败提示
    - _需求: 9.5, 9.6_

- [x] 12. 编写集成测试
  - [ ] 12.1 搭建测试环境
    - 使用 Docker Compose 启动 MySQL 和 ES 测试容器
    - 准备测试数据（创建测试数据库、表、索引）
    - 编写测试辅助函数
  
  - [ ] 12.2 测试 MySQL 到 MySQL 同步
    - 创建源和目标数据源
    - 配置同步任务
    - 执行同步并验证数据一致性
    - 验证目标表被删除重建
  
  - [ ] 12.3 测试 MySQL 到 ES 同步
    - 验证类型映射正确性
    - 验证主键映射为 _id
    - 验证数据完整性
    - 验证目标索引被删除重建
  
  - [ ] 12.4 测试 ES 到 MySQL 同步
    - 验证类型映射正确性
    - 验证 _id 映射为主键
    - 验证数据完整性
  
  - [ ] 12.5 测试 ES 到 ES 同步
    - 验证索引通配符匹配
    - 验证数据完整性
  
  - [ ] 12.6 测试任务控制功能
    - 测试暂停和恢复功能
    - 验证暂停后从断点继续
  
  - [ ] 12.7 测试错误处理策略
    - 测试"跳过错误"策略
    - 测试"遇错暂停"策略
    - 验证错误日志记录
  
  - [ ] 12.8 测试并发和性能
    - 测试不同线程数配置
    - 测试批量大小自适应
    - 验证大数据量同步性能

- [ ] 13. 编写端到端测试
  - [ ] 13.1 搭建 E2E 测试环境
    - 配置 Playwright 或 Tauri 测试工具
    - 准备测试数据库环境
  
  - [ ] 13.2 测试完整用户工作流
    - 测试添加数据源流程
    - 测试连接测试功能
    - 测试创建同步任务流程
    - 测试执行同步并查看进度
    - 测试查看错误日志
  
  - [ ] 13.3 测试 UI 交互
    - 测试表单验证
    - 测试密码显示/隐藏
    - 测试通配符索引匹配预览
    - 测试任务控制按钮状态

- [ ] 14. 文档和部署
  - [ ] 14.1 编写用户文档
    - README.md（项目介绍、安装、使用）
    - 用户手册（功能说明、操作指南）
    - 常见问题 FAQ
  
  - [ ] 14.2 编写开发者文档
    - 架构设计说明
    - API 文档
    - 贡献指南
  
  - [ ] 14.3 配置打包和发布
    - 配置 Tauri 打包选项
    - 生成不同平台的安装包（Windows MSI, macOS DMG, Linux DEB/AppImage）
    - 测试安装包
  
  - [ ] 14.4 性能优化和最终测试
    - 性能分析和优化
    - 内存泄漏检查
    - 全面回归测试

## 任务依赖关系

```
1 (项目初始化)
├── 2 (加密服务)
│   └── 3 (存储层)
│       └── 4 (数据源管理器)
│           ├── 5 (类型映射器)
│           ├── 6 (进度监控器)
│           └── 7 (错误日志器)
│               └── 8 (同步引擎)
│                   └── 9 (Tauri Commands)
│                       └── 10 (Pinia Stores)
│                           └── 11 (UI 组件)
│                               ├── 12 (集成测试)
│                               ├── 13 (E2E 测试)
│                               └── 14 (文档和部署)
```


## 开发建议

### 开发顺序
1. **后端优先**：先完成任务 1-8，确保核心同步逻辑正确
2. **前后端联调**：完成任务 9-10，打通前后端通信
3. **UI 实现**：完成任务 11，实现用户界面
4. **测试验证**：完成任务 12-13，确保质量
5. **文档发布**：完成任务 14，准备发布

### 代码组织
- **后端代码**：`src-tauri/src/` 目录
  - `crypto.rs` - 加密服务
  - `storage.rs` - 存储层
  - `datasource.rs` - 数据源管理器
  - `type_mapper.rs` - 类型映射器
  - `progress.rs` - 进度监控器
  - `error_logger.rs` - 错误日志器
  - `sync_engine.rs` - 同步引擎（可能需要拆分为多个文件）
  - `commands.rs` - Tauri Commands
  - `main.rs` - 应用入口

- **前端代码**：`src/` 目录
  - `stores/` - Pinia Stores
  - `views/` - 页面组件
  - `components/` - 可复用组件
  - `router/` - 路由配置
  - `types/` - TypeScript 类型定义
  - `utils/` - 工具函数

### 测试组织
- **单元测试**：与源代码同目录，使用 `#[cfg(test)]` 模块
- **属性测试**：`src-tauri/tests/properties/` 目录
- **集成测试**：`src-tauri/tests/integration/` 目录
- **E2E 测试**：`tests/e2e/` 目录

### 注意事项
1. **代码文件大小**：单个文件不超过 300 行，及时拆分
2. **错误处理**：使用 `Result<T, E>` 和 `?` 操作符
3. **异步编程**：使用 `async/await` 和 Tokio
4. **类型安全**：充分利用 Rust 和 TypeScript 的类型系统
5. **测试覆盖**：每个模块都要有对应的测试
6. **文档注释**：为公共 API 添加文档注释

## 预估工作量

| 任务 | 预估时间 | 优先级 |
|------|---------|--------|
| 1. 项目初始化 | 0.5 天 | P0 |
| 2. 加密服务 | 1 天 | P0 |
| 3. 存储层 | 2 天 | P0 |
| 4. 数据源管理器 | 3 天 | P0 |
| 5. 类型映射器 | 2 天 | P0 |
| 6. 进度监控器 | 1 天 | P1 |
| 7. 错误日志器 | 1 天 | P1 |
| 8. 同步引擎 | 5 天 | P0 |
| 9. Tauri Commands | 2 天 | P0 |
| 10. Pinia Stores | 2 天 | P1 |
| 11. UI 组件 | 5 天 | P1 |
| 12. 集成测试 | 3 天 | P1 |
| 13. E2E 测试 | 2 天 | P2 |
| 14. 文档和部署 | 2 天 | P2 |
| **总计** | **约 31.5 天** | |

**说明**：
- P0：核心功能，必须完成
- P1：重要功能，应该完成
- P2：辅助功能，可以后续完善

## 里程碑

### 里程碑 1：后端核心功能（任务 1-8）
- **目标**：完成数据同步的核心逻辑
- **验收标准**：能够通过单元测试和属性测试

### 里程碑 2：前后端集成（任务 9-10）
- **目标**：打通前后端通信
- **验收标准**：前端能够调用后端 API

### 里程碑 3：完整 UI（任务 11）
- **目标**：实现完整的用户界面
- **验收标准**：用户可以通过 UI 完成所有操作

### 里程碑 4：测试和发布（任务 12-14）
- **目标**：确保质量并准备发布
- **验收标准**：通过所有测试，生成安装包

## 总结

本实现计划将数据同步工具的开发分解为 14 个主要任务，共 80+ 个子任务。通过增量式开发，每个任务都基于前面的任务构建，确保项目稳步推进。

关键特点：
- **模块化设计**：每个模块职责清晰，便于开发和测试
- **测试驱动**：每个模块都有对应的单元测试和属性测试
- **增量交付**：按照后端 → 前端 → 测试的顺序，逐步完成功能
- **质量保证**：通过单元测试、属性测试、集成测试、E2E 测试确保质量

预计总开发时间约 **31.5 天**（1 人月），可根据实际情况调整。
