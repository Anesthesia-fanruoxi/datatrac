# æ•°æ®åº“è®¾è®¡

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° DataTrac ç³»ç»Ÿçš„æ•°æ®åº“è®¾è®¡ï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ã€å…³ç³»å’Œç´¢å¼•ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-30  
**æ•°æ®åº“**: SQLite

---

## ğŸ¯ æ¦‚è¿°

DataTrac ä½¿ç”¨ SQLite ä½œä¸ºå…ƒæ•°æ®å­˜å‚¨ï¼Œç®¡ç†æ•°æ®æºã€ä»»åŠ¡é…ç½®å’Œä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚

**æ ¸å¿ƒè¡¨**:
- `data_sources` - æ•°æ®æºè¡¨
- `sync_tasks` - ä»»åŠ¡ä¸»è¡¨
- `task_unit_configs` - ä»»åŠ¡å•å…ƒé…ç½®è¡¨
- `task_unit_runtimes` - ä»»åŠ¡å•å…ƒè¿è¡Œè®°å½•è¡¨

---

## ğŸ“Š è¡¨ç»“æ„è®¾è®¡

### 1. data_sources - æ•°æ®æºè¡¨

**ç”¨é€”**: å­˜å‚¨ MySQL å’Œ Elasticsearch æ•°æ®æºä¿¡æ¯

```sql
CREATE TABLE data_sources (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT NOT NULL,              -- 'mysql' æˆ– 'elasticsearch'
    host TEXT NOT NULL,
    port INTEGER NOT NULL,
    username TEXT NOT NULL,
    password TEXT NOT NULL,          -- AES-256-GCM åŠ å¯†
    database_name TEXT,              -- MySQL ä¸“ç”¨
    created_at INTEGER NOT NULL,     -- æ¯«ç§’æ—¶é—´æˆ³
    updated_at INTEGER NOT NULL      -- æ¯«ç§’æ—¶é—´æˆ³
);

CREATE INDEX idx_data_sources_type ON data_sources(type);
CREATE INDEX idx_data_sources_name ON data_sources(name);
```

**å­—æ®µè¯´æ˜**:
- `id`: UUID ä¸»é”®
- `type`: æ•°æ®æºç±»å‹ï¼ˆmysql/elasticsearchï¼‰
- `password`: ä½¿ç”¨ AES-256-GCM åŠ å¯†å­˜å‚¨
- `database_name`: MySQL çš„é»˜è®¤æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

---

### 2. sync_tasks - ä»»åŠ¡ä¸»è¡¨

**ç”¨é€”**: å­˜å‚¨åŒæ­¥ä»»åŠ¡çš„åŸºæœ¬ä¿¡æ¯å’Œé…ç½®

```sql
CREATE TABLE sync_tasks (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    source_id TEXT NOT NULL,         -- å…³è” data_sources.id
    target_id TEXT NOT NULL,         -- å…³è” data_sources.id
    source_type TEXT NOT NULL,       -- 'mysql' æˆ– 'elasticsearch'
    target_type TEXT NOT NULL,       -- 'mysql' æˆ– 'elasticsearch'
    config TEXT NOT NULL,            -- JSON æ ¼å¼çš„ä»»åŠ¡é…ç½®
    status TEXT NOT NULL,            -- 'idle', 'running', 'paused', 'completed', 'failed'
    sync_mode TEXT NOT NULL DEFAULT 'auto',  -- åŒæ­¥æ¨¡å¼ï¼ˆç›®å‰ä»…æ”¯æŒ 'auto'ï¼‰
    created_at INTEGER NOT NULL,     -- æ¯«ç§’æ—¶é—´æˆ³
    updated_at INTEGER NOT NULL,     -- æ¯«ç§’æ—¶é—´æˆ³
    FOREIGN KEY (source_id) REFERENCES data_sources(id) ON DELETE CASCADE,
    FOREIGN KEY (target_id) REFERENCES data_sources(id) ON DELETE CASCADE
);

CREATE INDEX idx_sync_tasks_status ON sync_tasks(status);
CREATE INDEX idx_sync_tasks_source_id ON sync_tasks(source_id);
CREATE INDEX idx_sync_tasks_target_id ON sync_tasks(target_id);
```

**å­—æ®µè¯´æ˜**:
- `config`: JSON æ ¼å¼ï¼ŒåŒ…å« mysqlConfigã€esConfigã€syncConfig
- `sync_mode`: åŒæ­¥æ¨¡å¼ï¼Œç›®å‰ä»…æ”¯æŒ 'auto'ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰
- `status`: ä»»åŠ¡çŠ¶æ€

**config JSON ç»“æ„**:
```json
{
  "mysqlConfig": {
    "databases": [
      {
        "database": "db1",
        "tables": ["table1", "table2"]
      }
    ]
  },
  "esConfig": {
    "selectedIndices": ["index1", "index2"]
  },
  "syncConfig": {
    "batchSize": 2500,
    "threadCount": 4,
    "errorStrategy": "skip",
    "tableExistsStrategy": "drop"
  }
}
```

---

### 3. task_unit_configs - ä»»åŠ¡å•å…ƒé…ç½®è¡¨ â­

**ç”¨é€”**: å­˜å‚¨ä»»åŠ¡è¦åŒæ­¥çš„è¡¨/ç´¢å¼•åˆ—è¡¨ï¼ˆä»ä»»åŠ¡é…ç½®ä¸­æå–ï¼‰

```sql
CREATE TABLE task_unit_configs (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    unit_name TEXT NOT NULL,         -- è¡¨åæˆ–ç´¢å¼•å
    unit_type TEXT NOT NULL,         -- 'table' æˆ– 'index'
    created_at INTEGER NOT NULL,     -- æ¯«ç§’æ—¶é—´æˆ³
    FOREIGN KEY (task_id) REFERENCES sync_tasks(id) ON DELETE CASCADE,
    UNIQUE(task_id, unit_name)       -- åŒä¸€ä»»åŠ¡ä¸­å•å…ƒåç§°å”¯ä¸€
);

CREATE INDEX idx_task_unit_configs_task_id ON task_unit_configs(task_id);
CREATE INDEX idx_task_unit_configs_unit_type ON task_unit_configs(unit_type);
```

**å­—æ®µè¯´æ˜**:
- `unit_name`: è¡¨åï¼ˆå¦‚ "db1.table1"ï¼‰æˆ–ç´¢å¼•åï¼ˆå¦‚ "index-a"ï¼‰
- `unit_type`: å•å…ƒç±»å‹ï¼ˆtable/indexï¼‰
- `UNIQUE(task_id, unit_name)`: ç¡®ä¿åŒä¸€ä»»åŠ¡ä¸­å•å…ƒåç§°å”¯ä¸€

**æ•°æ®æ¥æº**:
- MySQL: ä» `config.mysqlConfig.databases[].tables` æå–
- ES: ä» `config.esConfig.selectedIndices` æå–

---

### 4. task_unit_runtimes - ä»»åŠ¡å•å…ƒè¿è¡Œè®°å½•è¡¨ â­

**ç”¨é€”**: å­˜å‚¨ä»»åŠ¡å•å…ƒçš„æ‰§è¡ŒçŠ¶æ€å’Œè¿›åº¦ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰

```sql
CREATE TABLE task_unit_runtimes (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    unit_name TEXT NOT NULL,         -- è¡¨åæˆ–ç´¢å¼•å
    status TEXT NOT NULL,            -- 'pending', 'running', 'completed', 'failed', 'paused'
    total_records INTEGER DEFAULT 0,
    processed_records INTEGER DEFAULT 0,
    error_message TEXT,              -- é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶ï¼‰
    started_at INTEGER,              -- å¼€å§‹æ—¶é—´ï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰
    updated_at INTEGER NOT NULL,     -- æ›´æ–°æ—¶é—´ï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰
    last_processed_batch INTEGER,    -- æœ€åå¤„ç†çš„æ‰¹æ¬¡å·ï¼ˆé¢„ç•™ï¼‰
    FOREIGN KEY (task_id) REFERENCES sync_tasks(id) ON DELETE CASCADE,
    UNIQUE(task_id, unit_name)       -- åŒä¸€ä»»åŠ¡ä¸­å•å…ƒåç§°å”¯ä¸€
);

CREATE INDEX idx_task_unit_runtimes_task_id ON task_unit_runtimes(task_id);
CREATE INDEX idx_task_unit_runtimes_status ON task_unit_runtimes(status);
CREATE INDEX idx_task_unit_runtimes_task_status ON task_unit_runtimes(task_id, status);
```

**å­—æ®µè¯´æ˜**:
- `unit_name`: ä¸ task_unit_configs.unit_name å¯¹åº”
- `status`: æ‰§è¡ŒçŠ¶æ€
- `total_records`: æ€»è®°å½•æ•°ï¼ˆåŒæ­¥å¼€å§‹æ—¶è·å–ï¼‰
- `processed_records`: å·²å¤„ç†è®°å½•æ•°ï¼ˆå®æ—¶æ›´æ–°ï¼‰
- `last_processed_batch`: æœ€åå¤„ç†çš„æ‰¹æ¬¡å·ï¼ˆé¢„ç•™ï¼Œç”¨äºæœªæ¥çš„è®°å½•çº§æ–­ç‚¹ç»­ä¼ ï¼‰

**çŠ¶æ€æµè½¬**:
```
pending â†’ running â†’ completed
                 â†˜ failed
                 â†˜ paused
```

---

## ğŸ”— è¡¨å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   data_sources      â”‚
â”‚  (æ•°æ®æºè¡¨)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘ â†‘
         â”‚ â”‚ (source_id, target_id)
         â”‚ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   sync_tasks        â”‚
â”‚  (ä»»åŠ¡ä¸»è¡¨)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (task_id)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task_unit_configs   â”‚
â”‚ (ä»»åŠ¡å•å…ƒé…ç½®è¡¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (task_id + unit_name)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task_unit_runtimes  â”‚
â”‚ (ä»»åŠ¡å•å…ƒè¿è¡Œè®°å½•è¡¨) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³ç³»è¯´æ˜**:
- `data_sources` â† `sync_tasks`: 1:Nï¼ˆä¸€ä¸ªæ•°æ®æºå¯ä»¥è¢«å¤šä¸ªä»»åŠ¡ä½¿ç”¨ï¼‰
- `sync_tasks` â†’ `task_unit_configs`: 1:Nï¼ˆä¸€ä¸ªä»»åŠ¡åŒ…å«å¤šä¸ªå•å…ƒé…ç½®ï¼‰
- `task_unit_configs` â†’ `task_unit_runtimes`: 1:1ï¼ˆä¸€ä¸ªé…ç½®å¯¹åº”ä¸€ä¸ªè¿è¡Œè®°å½•ï¼‰

---

## ğŸ”„ ä¸‰è¡¨ç»“æ„å·¥ä½œæµç¨‹

### 1. ä»»åŠ¡åˆ›å»º

```
ç”¨æˆ·åˆ›å»ºä»»åŠ¡
   â†“
ä¿å­˜åˆ° sync_tasks è¡¨
   â†“
ä» config æå–å•å…ƒåˆ—è¡¨
   â†“
ä¿å­˜åˆ° task_unit_configs è¡¨
```

### 2. ä»»åŠ¡å¯åŠ¨ï¼ˆé¦–æ¬¡ï¼‰

```
ç”¨æˆ·å¯åŠ¨ä»»åŠ¡
   â†“
TaskLoader::init_task_units
   â†“
ä» task_unit_configs è¯»å–å•å…ƒåˆ—è¡¨
   â†“
ä¸ºæ¯ä¸ªå•å…ƒåˆ›å»ºè¿è¡Œè®°å½•
   â†“
ä¿å­˜åˆ° task_unit_runtimes è¡¨ï¼ˆstatus = pendingï¼‰
```

### 3. ä»»åŠ¡æ‰§è¡Œ

```
TaskManager::execute_auto_mode
   â†“
ä» task_unit_runtimes åŠ è½½å•å…ƒ
   â†“
è¿‡æ»¤æœªå®Œæˆå•å…ƒï¼ˆstatus != completedï¼‰
   â†“
å¹¶å‘æ‰§è¡Œ
   â”œâ”€ æ›´æ–° status = running
   â”œâ”€ æ›´æ–° processed_records
   â””â”€ æ›´æ–° status = completed/failed
```

### 4. ä»»åŠ¡é‡å¯ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰

```
ç”¨æˆ·é‡å¯ä»»åŠ¡
   â†“
TaskLoader::init_task_units
   â†“
ä» task_unit_configs è¯»å–å•å…ƒåˆ—è¡¨
   â†“
åŠ è½½ç°æœ‰çš„ task_unit_runtimes
   â†“
å¯¹æ¯”é…ç½®å’Œè¿è¡Œè®°å½•
   â”œâ”€ å·²å®Œæˆ â†’ ä¿æŒ completed
   â”œâ”€ è¿è¡Œä¸­ â†’ é‡ç½®ä¸º pending
   â””â”€ å¤±è´¥ â†’ ä¿æŒ failed
   â†“
æ¸…ç†å­¤ç«‹çš„è¿è¡Œè®°å½•
```

---

## ğŸ“ æ•°æ®æ“ä½œç¤ºä¾‹

### åˆ›å»ºä»»åŠ¡

```rust
// 1. ä¿å­˜ä»»åŠ¡ä¸»è¡¨
let task = SyncTask {
    id: uuid::Uuid::new_v4().to_string(),
    name: "MySQL to ES Sync".to_string(),
    source_id: "source-123".to_string(),
    target_id: "target-456".to_string(),
    source_type: DataSourceType::Mysql,
    target_type: DataSourceType::Elasticsearch,
    config: serde_json::to_string(&config)?,
    status: TaskStatus::Idle,
    sync_mode: "auto".to_string(),
    created_at: now,
    updated_at: now,
};
storage.save_task(&task).await?;

// 2. æå–å¹¶ä¿å­˜å•å…ƒé…ç½®
let unit_configs = extract_unit_configs(&config);
for unit_config in unit_configs {
    storage.save_unit_config(&unit_config).await?;
}
```

### åˆå§‹åŒ–ä»»åŠ¡å•å…ƒ

```rust
// ä»é…ç½®è¡¨è¯»å–
let configs = storage.load_unit_configs(task_id).await?;

// åŠ è½½ç°æœ‰è¿è¡Œè®°å½•
let existing_runtimes = storage.load_unit_runtimes(task_id).await?;

// åˆ›å»ºæˆ–æ›´æ–°è¿è¡Œè®°å½•
for config in configs {
    if let Some(existing) = find_runtime(&existing_runtimes, &config.unit_name) {
        // å·²æœ‰è®°å½•ï¼Œæ ¹æ®çŠ¶æ€å¤„ç†
        if existing.status == TaskUnitStatus::Running {
            // é‡ç½®ä¸º pending
            storage.reset_runtime(task_id, &config.unit_name).await?;
        }
    } else {
        // åˆ›å»ºæ–°è®°å½•
        let runtime = TaskUnitRuntime {
            id: uuid::Uuid::new_v4().to_string(),
            task_id: task_id.to_string(),
            unit_name: config.unit_name.clone(),
            status: TaskUnitStatus::Pending,
            total_records: 0,
            processed_records: 0,
            error_message: None,
            started_at: None,
            updated_at: now,
            last_processed_batch: None,
        };
        storage.save_unit_runtime(&runtime).await?;
    }
}
```

### æ›´æ–°è¿›åº¦

```rust
// æ›´æ–°è¿è¡Œè®°å½•
storage.update_runtime_progress(
    task_id,
    unit_name,
    total_records,
    processed_records
).await?;
```

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### 1. é…ç½®ä¸è¿è¡Œåˆ†ç¦»
- `task_unit_configs`: å­˜å‚¨é…ç½®ï¼ˆä¸å˜ï¼‰
- `task_unit_runtimes`: å­˜å‚¨è¿è¡ŒçŠ¶æ€ï¼ˆå¯å˜ï¼‰
- æ”¯æŒé‡ç½®è¿è¡Œè®°å½•è€Œä¸å½±å“é…ç½®

### 2. æ–­ç‚¹ç»­ä¼ æ”¯æŒ
- è¿è¡Œè®°å½•æŒä¹…åŒ–åˆ°æ•°æ®åº“
- æ”¯æŒä»»åŠ¡æš‚åœã€æ¢å¤ã€é‡å¯
- å·²å®Œæˆå•å…ƒä¸é‡å¤æ‰§è¡Œ

### 3. æ•°æ®ä¸€è‡´æ€§
- å¤–é”®çº¦æŸä¿è¯å¼•ç”¨å®Œæ•´æ€§
- å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤æ•°æ®
- çº§è”åˆ é™¤è‡ªåŠ¨æ¸…ç†å…³è”æ•°æ®

### 4. æŸ¥è¯¢æ€§èƒ½
- åˆç†çš„ç´¢å¼•è®¾è®¡
- æ”¯æŒé«˜æ•ˆçš„çŠ¶æ€è¿‡æ»¤
- æ”¯æŒå¿«é€Ÿçš„å…³è”æŸ¥è¯¢

---

## ğŸ” å¸¸ç”¨æŸ¥è¯¢

### æŸ¥è¯¢ä»»åŠ¡çš„æ‰€æœ‰å•å…ƒ

```sql
SELECT 
    c.unit_name,
    c.unit_type,
    r.status,
    r.total_records,
    r.processed_records
FROM task_unit_configs c
LEFT JOIN task_unit_runtimes r ON c.task_id = r.task_id AND c.unit_name = r.unit_name
WHERE c.task_id = ?
ORDER BY c.unit_name;
```

### æŸ¥è¯¢æœªå®Œæˆçš„å•å…ƒ

```sql
SELECT * FROM task_unit_runtimes
WHERE task_id = ? AND status != 'completed'
ORDER BY unit_name;
```

### æŸ¥è¯¢å¤±è´¥çš„å•å…ƒ

```sql
SELECT * FROM task_unit_runtimes
WHERE task_id = ? AND status = 'failed'
ORDER BY unit_name;
```

### ç»Ÿè®¡ä»»åŠ¡è¿›åº¦

```sql
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,
    SUM(CASE WHEN status = 'running' THEN 1 ELSE 0 END) as running,
    SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
    SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending
FROM task_unit_runtimes
WHERE task_id = ?;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä»»åŠ¡ç®¡ç†å™¨](../features/ä»»åŠ¡ç®¡ç†å™¨.md) - TaskManager è¯¦ç»†è®¾è®¡
- [ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ ](../features/ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ .md) - è°ƒåº¦ç­–ç•¥å’Œæ–­ç‚¹ç»­ä¼ 
- [æ–­ç‚¹ç»­ä¼ å®ç°](../implementation/æ–­ç‚¹ç»­ä¼ å®ç°.md) - æ–­ç‚¹ç»­ä¼ å®ç°ç»†èŠ‚

---

**æ–‡æ¡£ç»´æŠ¤**: DataTrac å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-30
