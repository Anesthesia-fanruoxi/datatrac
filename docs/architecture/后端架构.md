# åç«¯æ¶æ„

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° DataTrac åç«¯çš„æ¶æ„è®¾è®¡ã€æ¨¡å—åˆ’åˆ†å’ŒæŠ€æœ¯å®ç°ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-30

---

## ğŸ¯ æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶
- **Tauri 2.x** - æ¡Œé¢åº”ç”¨æ¡†æ¶
- **Rust 1.70+** - ç³»ç»Ÿç¼–ç¨‹è¯­è¨€
- **Tokio** - å¼‚æ­¥è¿è¡Œæ—¶

### æ•°æ®åº“
- **SQLite (rusqlite/sqlx)** - å…ƒæ•°æ®å­˜å‚¨
- **MySQL (sqlx)** - MySQL æ•°æ®æºå®¢æˆ·ç«¯
- **Elasticsearch (elasticsearch-rs)** - ES æ•°æ®æºå®¢æˆ·ç«¯

### å·¥å…·åº“
- **serde** - åºåˆ—åŒ–/ååºåˆ—åŒ–
- **anyhow** - é”™è¯¯å¤„ç†
- **chrono** - æ—¥æœŸæ—¶é—´å¤„ç†
- **uuid** - UUID ç”Ÿæˆ
- **aes-gcm** - å¯†ç åŠ å¯†

---

## ğŸ“ ç›®å½•ç»“æ„

```
src-tauri/src/
â”œâ”€â”€ main.rs                     # åº”ç”¨å…¥å£
â”œâ”€â”€ lib.rs                      # åº“å…¥å£
â”œâ”€â”€ commands.rs                 # Tauri Commands (API å±‚)
â”œâ”€â”€ crypto.rs                   # åŠ å¯†å·¥å…·
â”œâ”€â”€ type_mapper.rs              # ç±»å‹æ˜ å°„å·¥å…·
â”œâ”€â”€ datasource.rs               # æ•°æ®æºç®¡ç†å™¨
â”œâ”€â”€ task_manager.rs             # ä»»åŠ¡ç®¡ç†å™¨
â”œâ”€â”€ progress.rs                 # è¿›åº¦ç›‘æ§å™¨
â”œâ”€â”€ progress_logger.rs          # è¿›åº¦æ—¥å¿—å™¨
â”œâ”€â”€ error_logger.rs             # é”™è¯¯æ—¥å¿—å™¨
â”œâ”€â”€ storage/                    # å­˜å‚¨å±‚
â”‚   â”œâ”€â”€ mod.rs                 # å­˜å‚¨æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ models.rs              # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ data_source_ops.rs     # æ•°æ®æºæ“ä½œ
â”‚   â”œâ”€â”€ sync_task_ops.rs       # åŒæ­¥ä»»åŠ¡æ“ä½œ
â”‚   â””â”€â”€ task_unit_new_ops.rs   # ä»»åŠ¡å•å…ƒæ“ä½œ (ä¸‰è¡¨ç»“æ„)
â””â”€â”€ sync_engine/                # åŒæ­¥å¼•æ“
    â”œâ”€â”€ mod.rs                 # å¼•æ“å…¥å£ (Pipeline å·¥å‚)
    â”œâ”€â”€ types.rs               # ç±»å‹å®šä¹‰
    â”œâ”€â”€ task_loader.rs         # ä»»åŠ¡åŠ è½½å™¨
    â”œâ”€â”€ state_manager.rs       # çŠ¶æ€ç®¡ç†å™¨
    â”œâ”€â”€ framework/             # æ•°æ®äº¤æ¢æ¡†æ¶ (æ ¸å¿ƒåº•åº§)
    â”‚   â”œâ”€â”€ mod.rs             # æ¡†æ¶å®šä¹‰ (Traits)
    â”‚   â”œâ”€â”€ reader.rs          # Reader æŠ½è±¡
    â”‚   â”œâ”€â”€ writer.rs          # Writer æŠ½è±¡
    â”‚   â”œâ”€â”€ transformer.rs     # Transformer æŠ½è±¡
    â”‚   â””â”€â”€ pipeline.rs        # Pipeline è°ƒåº¦å™¨
    â”œâ”€â”€ plugins/               # æ•°æ®æºæ’ä»¶å®ç°
    â”‚   â”œâ”€â”€ mysql/             # MySQL Reader/Writer
    â”‚   â”œâ”€â”€ elasticsearch/     # ES Reader/Writer
    â”‚   â””â”€â”€ mongo/             # Mongo Reader/Writer (æ‰©å±•ç¤ºä¾‹)
    â””â”€â”€ utils.rs               # å·¥å…·å‡½æ•°
```

---

## ğŸ—ï¸ åˆ†å±‚æ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  API å±‚ (Commands)                       â”‚
â”‚  - Tauri Commands                                       â”‚
â”‚  - å‚æ•°éªŒè¯                                              â”‚
â”‚  - é”™è¯¯è½¬æ¢                                              â”‚
â”‚  - åºåˆ—åŒ–/ååºåˆ—åŒ–                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æœåŠ¡å±‚ (Services)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ DataSource   â”‚ SyncEngine   â”‚ TaskManager          â”‚ â”‚
â”‚  â”‚ Manager      â”‚ (Pipeline)   â”‚ (Scheduler)          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ ä½¿ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ•°æ®äº¤æ¢æ¡†æ¶ (Exchange Framework)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SourceReader â”‚ Transformer  â”‚ TargetWriter         â”‚ â”‚
â”‚  â”‚ (Extract)    â”‚ (Transform)  â”‚ (Load)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ è®¿é—®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å­˜å‚¨å±‚ (Storage)                        â”‚
â”‚  - SQLite æ“ä½œ                                          â”‚
â”‚  - æ•°æ®æ¨¡å‹                                              â”‚
â”‚  - CRUD æ“ä½œ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ è¿æ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åº“ (SQLite + MySQL + ES)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—

### 1. API å±‚ (Commands)

**æ–‡ä»¶**: `commands.rs`

**èŒè´£**:
- æš´éœ² Tauri Commands ç»™å‰ç«¯
- å‚æ•°éªŒè¯å’Œç±»å‹è½¬æ¢
- é”™è¯¯å¤„ç†å’Œè½¬æ¢
- è°ƒç”¨æœåŠ¡å±‚

**ç¤ºä¾‹**:
```rust
#[tauri::command]
pub async fn list_data_sources(
    state: State<'_, AppState>,
) -> Result<Vec<DataSource>, String> {
    state.data_source_manager
        .list_data_sources()
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn start_sync_task(
    task_id: String,
    state: State<'_, AppState>,
) -> Result<(), String> {
    state.sync_engine
        .start_sync_by_id(&task_id)
        .await
        .map_err(|e| e.to_string())
}
```

**å‘½åè§„èŒƒ**:
- ä½¿ç”¨ snake_case å‘½åå‡½æ•°
- ä½¿ç”¨ `#[serde(rename_all = "camelCase")]` è½¬æ¢ä¸ºå‰ç«¯çš„ camelCase

---

### 2. æ•°æ®æºç®¡ç†å™¨ (DataSourceManager)

**æ–‡ä»¶**: `datasource.rs`

**èŒè´£**:
- ç®¡ç† MySQL å’Œ ES æ•°æ®æº
- åˆ›å»ºå’Œç¼“å­˜æ•°æ®åº“è¿æ¥
- æµ‹è¯•è¿æ¥
- å¯†ç åŠ å¯†/è§£å¯†

**æ ¸å¿ƒç»“æ„**:
```rust
pub struct DataSourceManager {
    storage: Arc<Storage>,
    mysql_pools: Arc<RwLock<HashMap<String, MySqlPool>>>,
    es_clients: Arc<RwLock<HashMap<String, Elasticsearch>>>,
    crypto: Arc<Crypto>,
}
```

**å…³é”®æ–¹æ³•**:
```rust
impl DataSourceManager {
    // åˆ›å»ºæ•°æ®æº
    pub async fn create_data_source(&self, data: CreateDataSourceRequest) -> Result<DataSource>;
    
    // è·å– MySQL è¿æ¥æ± 
    pub async fn get_mysql_pool(&self, id: &str) -> Result<MySqlPool>;
    
    // è·å– ES å®¢æˆ·ç«¯
    pub async fn get_es_client(&self, id: &str) -> Result<Elasticsearch>;
    
    // æµ‹è¯•è¿æ¥
    pub async fn test_connection(&self, id: &str) -> Result<()>;
}
```

---

### 3. åŒæ­¥å¼•æ“ (SyncEngine)

**æ–‡ä»¶**: `sync_engine/mod.rs`

**èŒè´£**:
- æ‰§è¡Œæ•°æ®åŒæ­¥ä»»åŠ¡
- ç®¡ç†ä»»åŠ¡çŠ¶æ€
- åè°ƒè¿›åº¦ç›‘æ§å’Œé”™è¯¯æ—¥å¿—
- å¤„ç†å¹¶å‘å’Œæ‰¹é‡æ“ä½œ

**æ ¸å¿ƒç»“æ„**:
```rust
pub struct SyncEngine {
    source_manager: Arc<DataSourceManager>,
    progress_monitor: Arc<ProgressMonitor>,
    error_logger: Arc<ErrorLogger>,
    task_manager: Arc<TaskManager>,
    state_manager: TaskStateManager,
    task_loader: TaskLoader,
}
```

**å…³é”®æ–¹æ³•**:
```rust
impl SyncEngine {
    // å¯åŠ¨åŒæ­¥ä»»åŠ¡
    pub async fn start_sync(&self, config: SyncTaskConfig) -> Result<()>;
    
    // æ ¹æ®ä»»åŠ¡ ID å¯åŠ¨åŒæ­¥
    pub async fn start_sync_by_id(&self, task_id: &str) -> Result<()>;
    
    // æš‚åœåŒæ­¥
    pub async fn pause_sync(&self, task_id: &str) -> Result<()>;
    
    // æ¢å¤åŒæ­¥
    pub async fn resume_sync(&self, task_id: &str) -> Result<()>;
}
```

**å­æ¨¡å—**:
- `task_loader.rs` - ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡é…ç½®
- `state_manager.rs` - ç®¡ç†ä»»åŠ¡è¿è¡ŒçŠ¶æ€
- `mysql_sync.rs` - MySQL é€šç”¨æ“ä½œ
- `es_sync.rs` - ES é€šç”¨æ“ä½œ
- `implementations/` - å››ç§åŒæ­¥æ–¹å‘çš„å…·ä½“å®ç°

---

### 4. ä»»åŠ¡ç®¡ç†å™¨ (TaskManager)

**æ–‡ä»¶**: `task_manager.rs`

**èŒè´£**:
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä»»åŠ¡å•å…ƒ (è¡¨/ç´¢å¼•)
- æ§åˆ¶å¹¶å‘æ‰§è¡Œ
- è·Ÿè¸ªä»»åŠ¡çŠ¶æ€
- ä¸æ•°æ®åº“åŒæ­¥ä»»åŠ¡å•å…ƒçŠ¶æ€

**æ ¸å¿ƒç»“æ„**:
```rust
pub struct TaskManager {
    task_units: Arc<RwLock<HashMap<String, Vec<TaskUnit>>>>,
    storage: Option<Arc<Storage>>,
}

pub struct TaskUnit {
    pub id: String,
    pub name: String,
    pub status: TaskUnitStatus,
    pub total_records: u64,
    pub processed_records: u64,
    pub percentage: f64,
    pub error_message: Option<String>,
}
```

**å…³é”®æ–¹æ³•**:
```rust
impl TaskManager {
    // ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡å•å…ƒ
    pub async fn load_task_units_from_db(&self, task_id: &str) -> Result<Vec<TaskUnit>>;
    
    // æ›´æ–°ä»»åŠ¡å•å…ƒçŠ¶æ€å¹¶åŒæ­¥åˆ°æ•°æ®åº“
    pub async fn update_unit_status_with_sync(
        &self,
        task_id: &str,
        unit_id: &str,
        status: TaskUnitStatus,
        progress_monitor: &Arc<ProgressMonitor>,
    ) -> Result<()>;
    
    // è‡ªåŠ¨æ¨¡å¼: æ‰§è¡Œæ‰€æœ‰æœªå®Œæˆçš„ä»»åŠ¡å•å…ƒ
    pub async fn execute_auto_mode<F, Fut>(
        &self,
        task_id: &str,
        concurrency: usize,
        progress_monitor: Arc<ProgressMonitor>,
        process_fn: F,
    ) -> Result<usize>;
}
```

---

### 5. è¿›åº¦ç›‘æ§å™¨ (ProgressMonitor)

**æ–‡ä»¶**: `progress.rs`

**èŒè´£**:
- èšåˆä»»åŠ¡å•å…ƒçŠ¶æ€
- è®¡ç®—æ€»ä½“è¿›åº¦
- æ¨é€è¿›åº¦åˆ°å‰ç«¯
- ç®¡ç†æ—¥å¿—

**æ ¸å¿ƒç»“æ„**:
```rust
pub struct ProgressMonitor {
    app_handle: AppHandle,
    task_progress: Arc<RwLock<HashMap<String, TaskProgress>>>,
    task_units: Arc<RwLock<HashMap<String, Vec<TaskUnit>>>>,
    logs: Arc<RwLock<HashMap<String, Vec<LogEntry>>>>,
}
```

**å…³é”®æ–¹æ³•**:
```rust
impl ProgressMonitor {
    // æ›´æ–°ä»»åŠ¡å•å…ƒåˆ—è¡¨
    pub fn update_task_units(&self, task_id: &str, units: Vec<TaskUnit>);
    
    // æ·»åŠ æ—¥å¿—
    pub fn add_log(&self, task_id: &str, level: LogLevel, category: LogCategory, message: String);
    
    // æ¨é€è¿›åº¦åˆ°å‰ç«¯
    fn emit_progress(&self, task_id: &str);
}
```

---

### 6. å­˜å‚¨å±‚ (Storage)

**æ–‡ä»¶**: `storage/mod.rs`

**èŒè´£**:
- SQLite æ•°æ®åº“æ“ä½œ
- æ•°æ®æ¨¡å‹å®šä¹‰
- CRUD æ“ä½œ

**æ ¸å¿ƒç»“æ„**:
```rust
pub struct Storage {
    pool: SqlitePool,
}
```

**æ•°æ®æ¨¡å‹**:
```rust
// æ•°æ®æº
pub struct DataSource {
    pub id: String,
    pub name: String,
    pub source_type: DataSourceType,
    pub host: String,
    pub port: u16,
    pub username: String,
    pub password: String,
    pub database: Option<String>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

// åŒæ­¥ä»»åŠ¡
pub struct SyncTask {
    pub id: String,
    pub name: String,
    pub source_id: String,
    pub target_id: String,
    pub source_type: DataSourceType,
    pub target_type: DataSourceType,
    pub config: String,
    pub status: TaskStatus,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

// ä»»åŠ¡å•å…ƒé…ç½®
pub struct TaskUnitConfig {
    pub id: String,
    pub task_id: String,
    pub unit_name: String,
    pub unit_type: TaskUnitType,
    pub search_pattern: Option<String>,
    pub created_at: i64,
    pub updated_at: i64,
}

// ä»»åŠ¡å•å…ƒè¿è¡Œè®°å½•
pub struct TaskUnitRuntime {
    pub id: String,
    pub task_id: String,
    pub unit_name: String,
    pub status: TaskUnitStatus,
    pub total_records: i64,
    pub processed_records: i64,
    pub error_message: Option<String>,
    pub started_at: Option<i64>,
    pub updated_at: i64,
    pub last_processed_batch: Option<i64>,
}
```

**å…³é”®æ–¹æ³•**:
```rust
impl Storage {
    // æ•°æ®æºæ“ä½œ
    pub async fn save_data_source(&self, ds: &DataSource) -> Result<()>;
    pub async fn load_data_source(&self, id: &str) -> Result<Option<DataSource>>;
    pub async fn load_data_sources(&self) -> Result<Vec<DataSource>>;
    pub async fn delete_data_source(&self, id: &str) -> Result<()>;
    
    // åŒæ­¥ä»»åŠ¡æ“ä½œ
    pub async fn save_task(&self, task: &SyncTask) -> Result<()>;
    pub async fn load_task(&self, id: &str) -> Result<Option<SyncTask>>;
    pub async fn load_tasks(&self) -> Result<Vec<SyncTask>>;
    pub async fn delete_task(&self, id: &str) -> Result<()>;
    
    // ä»»åŠ¡å•å…ƒæ“ä½œ (ä¸‰è¡¨ç»“æ„)
    pub async fn save_unit_configs(&self, task_id: &str, configs: Vec<TaskUnitConfig>) -> Result<()>;
    pub async fn load_unit_configs(&self, task_id: &str) -> Result<Vec<TaskUnitConfig>>;
    pub async fn init_unit_runtimes(&self, task_id: &str) -> Result<()>;
    pub async fn load_unit_runtimes(&self, task_id: &str) -> Result<Vec<TaskUnitRuntime>>;
    pub async fn update_runtime_status(&self, task_id: &str, unit_name: &str, status: TaskUnitStatus) -> Result<()>;
    pub async fn update_runtime_progress(&self, task_id: &str, unit_name: &str, total: i64, processed: i64) -> Result<()>;
}
```

---

## ğŸ”„ æ ¸å¿ƒå·¥ä½œæµç¨‹

### ä»»åŠ¡å¯åŠ¨æµç¨‹

```
1. å‰ç«¯è°ƒç”¨ start_sync_task(task_id)
   â†“
2. Commands å±‚æ¥æ”¶è¯·æ±‚
   â†“
3. SyncEngine.start_sync_by_id(task_id)
   â”œâ”€ æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º Running
   â”œâ”€ TaskLoader.load_and_parse_task(task_id)
   â”‚   â””â”€ ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡é…ç½®
   â”œâ”€ TaskLoader.init_task_units(task_id)
   â”‚   â”œâ”€ ä»é…ç½®è¡¨è¯»å–å•å…ƒåˆ—è¡¨
   â”‚   â”œâ”€ åˆ›å»º/æ›´æ–°è¿è¡Œè®°å½•è¡¨
   â”‚   â””â”€ æ”¯æŒæ–­ç‚¹ç»­ä¼ 
   â””â”€ SyncEngine.start_sync(config)
       â†“
4. æ ¹æ®åŒæ­¥æ–¹å‘è°ƒç”¨å¯¹åº”å®ç°
   â”œâ”€ sync_mysql_to_es
   â”œâ”€ sync_es_to_mysql
   â”œâ”€ sync_mysql_to_mysql
   â””â”€ sync_es_to_es
       â†“
5. TaskManager.execute_auto_mode()
   â”œâ”€ ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡å•å…ƒ
   â”œâ”€ è¿‡æ»¤å‡ºæœªå®Œæˆçš„å•å…ƒ
   â”œâ”€ ä½¿ç”¨ Semaphore æ§åˆ¶å¹¶å‘
   â””â”€ å¹¶å‘æ‰§è¡Œæ‰€æœ‰æœªå®Œæˆå•å…ƒ
       â†“
6. ä¸ºæ¯ä¸ªå•å…ƒæ‰§è¡ŒåŒæ­¥
   â”œâ”€ æ›´æ–°çŠ¶æ€ä¸º Running
   â”œâ”€ è¯»å–æºæ•°æ®
   â”œâ”€ è½¬æ¢æ•°æ®æ ¼å¼
   â”œâ”€ å†™å…¥ç›®æ ‡æ•°æ®æº
   â”œâ”€ æ›´æ–°è¿›åº¦åˆ°æ•°æ®åº“
   â”œâ”€ æ¨é€è¿›åº¦åˆ°å‰ç«¯
   â””â”€ æ ‡è®°å®Œæˆ/å¤±è´¥
       â†“
7. æ‰€æœ‰å•å…ƒå®Œæˆ
   â”œâ”€ æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º Completed/Failed
   â””â”€ æ¨é€æœ€ç»ˆçŠ¶æ€åˆ°å‰ç«¯
```

---

## ğŸ”§ å¹¶å‘æ§åˆ¶

### Tokio Semaphore

ä½¿ç”¨ Tokio çš„ Semaphore æ§åˆ¶å¹¶å‘æ•°:

```rust
pub async fn execute_auto_mode<F, Fut>(
    &self,
    task_id: &str,
    concurrency: usize,
    progress_monitor: Arc<ProgressMonitor>,
    process_fn: F,
) -> Result<usize>
where
    F: Fn(String, String) -> Fut + Send + Sync + 'static,
    Fut: std::future::Future<Output = Result<()>> + Send,
{
    // åˆ›å»ºä¿¡å·é‡
    let semaphore = Arc::new(Semaphore::new(concurrency));
    let mut tasks = Vec::new();
    
    for unit in pending_units {
        // è·å–è®¸å¯
        let permit = semaphore.clone().acquire_owned().await?;
        
        // å¯åŠ¨å¼‚æ­¥ä»»åŠ¡
        let task = tokio::spawn(async move {
            // æ‰§è¡ŒåŒæ­¥
            let result = process_fn(unit_id, unit_name).await;
            
            // é‡Šæ”¾è®¸å¯
            drop(permit);
        });
        
        tasks.push(task);
    }
    
    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    for task in tasks {
        let _ = task.await;
    }
    
    Ok(success_count)
}
```

---

## ğŸ“Š çŠ¶æ€ç®¡ç†

### ä»»åŠ¡çŠ¶æ€

```rust
pub enum TaskStatus {
    Idle,       // ç©ºé—²
    Running,    // è¿è¡Œä¸­
    Paused,     // å·²æš‚åœ
    Completed,  // å·²å®Œæˆ
    Failed,     // å¤±è´¥
}
```

### ä»»åŠ¡å•å…ƒçŠ¶æ€

```rust
pub enum TaskUnitStatus {
    Pending,    // ç­‰å¾…æ‰§è¡Œ
    Running,    // æ‰§è¡Œä¸­
    Completed,  // å·²å®Œæˆ
    Failed,     // å¤±è´¥
}
```

### çŠ¶æ€åŒæ­¥

**å†…å­˜ â†’ æ•°æ®åº“ â†’ å‰ç«¯**:

```rust
// 1. æ›´æ–°å†…å­˜çŠ¶æ€
task_manager.update_unit_status(task_id, unit_id, status);

// 2. åŒæ­¥åˆ°æ•°æ®åº“
storage.update_runtime_status(task_id, unit_name, status).await?;

// 3. æ¨é€åˆ°å‰ç«¯
let units = task_manager.get_task_units(task_id);
progress_monitor.update_task_units(task_id, units);
progress_monitor.emit_progress(task_id);
```

---

## ğŸ” å®‰å…¨æ€§

### å¯†ç åŠ å¯†

ä½¿ç”¨ AES-GCM åŠ å¯†æ•°æ®æºå¯†ç :

```rust
pub struct Crypto {
    key: [u8; 32],
}

impl Crypto {
    // åŠ å¯†
    pub fn encrypt(&self, plaintext: &str) -> Result<String>;
    
    // è§£å¯†
    pub fn decrypt(&self, ciphertext: &str) -> Result<String>;
}
```

**åŠ å¯†æµç¨‹**:
1. ç”Ÿæˆéšæœº nonce
2. ä½¿ç”¨ AES-GCM åŠ å¯†
3. æ‹¼æ¥ nonce + ciphertext
4. Base64 ç¼–ç 

---

## ğŸ“ é”™è¯¯å¤„ç†

### ç»Ÿä¸€é”™è¯¯ç±»å‹

ä½¿ç”¨ `anyhow::Result` ä½œä¸ºç»Ÿä¸€é”™è¯¯ç±»å‹:

```rust
use anyhow::{Result, Context};

pub async fn some_operation() -> Result<()> {
    let data = load_data()
        .await
        .context("åŠ è½½æ•°æ®å¤±è´¥")?;
    
    process_data(data)
        .await
        .context("å¤„ç†æ•°æ®å¤±è´¥")?;
    
    Ok(())
}
```

### é”™è¯¯è½¬æ¢

åœ¨ Commands å±‚å°†é”™è¯¯è½¬æ¢ä¸ºå­—ç¬¦ä¸²:

```rust
#[tauri::command]
pub async fn some_command(
    state: State<'_, AppState>,
) -> Result<Data, String> {
    state.service
        .do_something()
        .await
        .map_err(|e| e.to_string())
}
```

---

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•

```rust
#[cfg(test)]
mod tests {
    use super::*;
    
    #[tokio::test]
    async fn test_save_and_load_data_source() {
        let storage = Storage::new(":memory:").await.unwrap();
        let ds = create_test_data_source();
        
        storage.save_data_source(&ds).await.unwrap();
        let loaded = storage.load_data_source(&ds.id).await.unwrap();
        
        assert!(loaded.is_some());
        assert_eq!(loaded.unwrap().id, ds.id);
    }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‰ç«¯æ¶æ„](./å‰ç«¯æ¶æ„.md) - å‰ç«¯æ¶æ„è®¾è®¡
- [æŠ€æœ¯è§„èŒƒ](./æŠ€æœ¯è§„èŒƒ.md) - å‰åç«¯ç»Ÿä¸€è§„èŒƒ
- [APIæ¥å£è®¾è®¡](./APIæ¥å£è®¾è®¡.md) - API æ¥å£æ–‡æ¡£
- [æ•°æ®åº“è®¾è®¡](./æ•°æ®åº“è®¾è®¡.md) - æ•°æ®åº“è¡¨ç»“æ„
- [åŒæ­¥å¼•æ“](../features/åŒæ­¥å¼•æ“.md) - åŒæ­¥å¼•æ“è¯¦ç»†è®¾è®¡
- [ä»»åŠ¡ç®¡ç†å™¨](../features/ä»»åŠ¡ç®¡ç†å™¨.md) - ä»»åŠ¡ç®¡ç†å™¨è¯¦ç»†è®¾è®¡

---

**æ–‡æ¡£ç»´æŠ¤**: DataTrac å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-30
