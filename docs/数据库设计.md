# æ•°æ®åº“è®¾è®¡

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° DataTrace ç³»ç»Ÿçš„æ•°æ®åº“è®¾è®¡ï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ã€å…³ç³»å’Œç´¢å¼•ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2026-02-27  
**æ•°æ®åº“**: MySQL 8.0+

---

## ğŸ¯ æ¦‚è¿°

DataTrace ä½¿ç”¨ MySQL ä½œä¸ºå…ƒæ•°æ®å­˜å‚¨ï¼Œç®¡ç†æ•°æ®æºã€ä»»åŠ¡é…ç½®å’Œä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚

**æ ¸å¿ƒè¡¨**:
- `data_sources` - æ•°æ®æºè¡¨
- `sync_tasks` - ä»»åŠ¡ä¸»è¡¨
- `task_unit_configs` - ä»»åŠ¡å•å…ƒé…ç½®è¡¨
- `task_unit_runtimes` - ä»»åŠ¡å•å…ƒè¿è¡Œè®°å½•è¡¨

---

## ğŸ“Š è¡¨ç»“æ„è®¾è®¡

### 1. data_sources - æ•°æ®æºè¡¨

**ç”¨é€”**: å­˜å‚¨ MySQL å’Œ Elasticsearch æ•°æ®æºä¿¡æ¯

```sql
CREATE TABLE `data_sources` (
    `id` VARCHAR(36) PRIMARY KEY COMMENT 'UUIDä¸»é”®',
    `name` VARCHAR(100) NOT NULL COMMENT 'æ•°æ®æºåç§°',
    `type` VARCHAR(20) NOT NULL COMMENT 'ç±»å‹: mysql/elasticsearch',
    `host` VARCHAR(255) NOT NULL COMMENT 'ä¸»æœºåœ°å€',
    `port` INT NOT NULL COMMENT 'ç«¯å£',
    `username` VARCHAR(100) NOT NULL COMMENT 'ç”¨æˆ·å',
    `password` VARCHAR(255) NOT NULL COMMENT 'å¯†ç (AES-256-GCMåŠ å¯†)',
    `database_name` VARCHAR(100) DEFAULT NULL COMMENT 'MySQLæ•°æ®åº“å',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    INDEX `idx_type` (`type`),
    INDEX `idx_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ•°æ®æºè¡¨';
```

**å­—æ®µè¯´æ˜**:
- `id`: UUIDä¸»é”®
- `type`: æ•°æ®æºç±»å‹ï¼ˆmysql/elasticsearchï¼‰
- `password`: ä½¿ç”¨AES-256-GCMåŠ å¯†å­˜å‚¨
- `database_name`: MySQLçš„é»˜è®¤æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
- `created_at/updated_at`: è‡ªåŠ¨ç»´æŠ¤çš„æ—¶é—´æˆ³

---

### 2. sync_tasks - ä»»åŠ¡ä¸»è¡¨

**ç”¨é€”**: å­˜å‚¨åŒæ­¥ä»»åŠ¡çš„åŸºæœ¬ä¿¡æ¯å’Œé…ç½®

```sql
CREATE TABLE `sync_tasks` (
    `id` VARCHAR(36) PRIMARY KEY COMMENT 'UUIDä¸»é”®',
    `name` VARCHAR(100) NOT NULL COMMENT 'ä»»åŠ¡åç§°',
    `source_id` VARCHAR(36) NOT NULL COMMENT 'æºæ•°æ®æºID',
    `target_id` VARCHAR(36) NOT NULL COMMENT 'ç›®æ ‡æ•°æ®æºID',
    `source_type` VARCHAR(20) NOT NULL COMMENT 'æºç±»å‹: mysql/elasticsearch',
    `target_type` VARCHAR(20) NOT NULL COMMENT 'ç›®æ ‡ç±»å‹: mysql/elasticsearch',
    `config` TEXT NOT NULL COMMENT 'JSONæ ¼å¼çš„ä»»åŠ¡é…ç½®',
    `status` VARCHAR(20) NOT NULL DEFAULT 'idle' COMMENT 'çŠ¶æ€: idle/running/paused/completed/failed',
    `sync_mode` VARCHAR(20) NOT NULL DEFAULT 'auto' COMMENT 'åŒæ­¥æ¨¡å¼',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    FOREIGN KEY (`source_id`) REFERENCES `data_sources`(`id`) ON DELETE CASCADE,
    FOREIGN KEY (`target_id`) REFERENCES `data_sources`(`id`) ON DELETE CASCADE,
    INDEX `idx_status` (`status`),
    INDEX `idx_source_id` (`source_id`),
    INDEX `idx_target_id` (`target_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åŒæ­¥ä»»åŠ¡è¡¨';
```

**å­—æ®µè¯´æ˜**:
- `config`: JSONæ ¼å¼ï¼ŒåŒ…å«mysqlConfigã€esConfigã€syncConfig
- `sync_mode`: åŒæ­¥æ¨¡å¼ï¼Œç›®å‰ä»…æ”¯æŒ'auto'ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰
- `status`: ä»»åŠ¡çŠ¶æ€

**config JSONç»“æ„**:
```json
{
  "mysqlConfig": {
    "databases": [
      {
        "database": "db1",
        "tables": ["table1", "table2"]
      }
    ]
  },
  "esConfig": {
    "selectedIndices": ["index1", "index2"]
  },
  "syncConfig": {
    "batchSize": 2500,
    "threadCount": 4,
    "errorStrategy": "skip",
    "tableExistsStrategy": "drop"
  }
}
```

---

### 3. task_unit_configs - ä»»åŠ¡å•å…ƒé…ç½®è¡¨ â­

**ç”¨é€”**: å­˜å‚¨ä»»åŠ¡è¦åŒæ­¥çš„è¡¨/ç´¢å¼•åˆ—è¡¨ï¼ˆä»ä»»åŠ¡é…ç½®ä¸­æå–ï¼‰

```sql
CREATE TABLE `task_unit_configs` (
    `id` VARCHAR(36) PRIMARY KEY COMMENT 'UUIDä¸»é”®',
    `task_id` VARCHAR(36) NOT NULL COMMENT 'ä»»åŠ¡ID',
    `unit_name` VARCHAR(200) NOT NULL COMMENT 'å•å…ƒåç§°(è¡¨åæˆ–ç´¢å¼•å)',
    `unit_type` VARCHAR(20) NOT NULL COMMENT 'ç±»å‹: table/index',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    FOREIGN KEY (`task_id`) REFERENCES `sync_tasks`(`id`) ON DELETE CASCADE,
    UNIQUE KEY `uk_task_unit` (`task_id`, `unit_name`),
    INDEX `idx_task_id` (`task_id`),
    INDEX `idx_unit_type` (`unit_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä»»åŠ¡å•å…ƒé…ç½®è¡¨';
```

**å­—æ®µè¯´æ˜**:
- `unit_name`: è¡¨åï¼ˆå¦‚"db1.table1"ï¼‰æˆ–ç´¢å¼•åï¼ˆå¦‚"index-a"ï¼‰
- `unit_type`: å•å…ƒç±»å‹ï¼ˆtable/indexï¼‰
- `UNIQUE(task_id, unit_name)`: ç¡®ä¿åŒä¸€ä»»åŠ¡ä¸­å•å…ƒåç§°å”¯ä¸€

**æ•°æ®æ¥æº**:
- MySQL: ä»`config.mysqlConfig.databases[].tables`æå–
- ES: ä»`config.esConfig.selectedIndices`æå–

---

### 4. task_unit_runtimes - ä»»åŠ¡å•å…ƒè¿è¡Œè®°å½•è¡¨ â­

**ç”¨é€”**: å­˜å‚¨ä»»åŠ¡å•å…ƒçš„æ‰§è¡ŒçŠ¶æ€å’Œè¿›åº¦ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰

```sql
CREATE TABLE `task_unit_runtimes` (
    `id` VARCHAR(36) PRIMARY KEY COMMENT 'UUIDä¸»é”®',
    `task_id` VARCHAR(36) NOT NULL COMMENT 'ä»»åŠ¡ID',
    `unit_name` VARCHAR(200) NOT NULL COMMENT 'å•å…ƒåç§°(è¡¨åæˆ–ç´¢å¼•å)',
    `status` VARCHAR(20) NOT NULL COMMENT 'çŠ¶æ€: pending/running/completed/failed/paused',
    `total_records` BIGINT DEFAULT 0 COMMENT 'æ€»è®°å½•æ•°',
    `processed_records` BIGINT DEFAULT 0 COMMENT 'å·²å¤„ç†è®°å½•æ•°',
    `error_message` TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    `started_at` DATETIME DEFAULT NULL COMMENT 'å¼€å§‹æ—¶é—´',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    `last_processed_batch` INT DEFAULT NULL COMMENT 'æœ€åå¤„ç†æ‰¹æ¬¡å·(é¢„ç•™)',
    FOREIGN KEY (`task_id`) REFERENCES `sync_tasks`(`id`) ON DELETE CASCADE,
    UNIQUE KEY `uk_task_unit` (`task_id`, `unit_name`),
    INDEX `idx_task_id` (`task_id`),
    INDEX `idx_status` (`status`),
    INDEX `idx_task_status` (`task_id`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä»»åŠ¡å•å…ƒè¿è¡Œè®°å½•è¡¨';
```

**å­—æ®µè¯´æ˜**:
- `unit_name`: ä¸task_unit_configs.unit_nameå¯¹åº”
- `status`: æ‰§è¡ŒçŠ¶æ€
- `total_records`: æ€»è®°å½•æ•°ï¼ˆåŒæ­¥å¼€å§‹æ—¶è·å–ï¼‰
- `processed_records`: å·²å¤„ç†è®°å½•æ•°ï¼ˆå®æ—¶æ›´æ–°ï¼‰
- `last_processed_batch`: æœ€åå¤„ç†çš„æ‰¹æ¬¡å·ï¼ˆé¢„ç•™ï¼Œç”¨äºæœªæ¥çš„è®°å½•çº§æ–­ç‚¹ç»­ä¼ ï¼‰

**çŠ¶æ€æµè½¬**:
```
pending â†’ running â†’ completed
                 â†˜ failed
                 â†˜ paused
```

---

## ğŸ”— è¡¨å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   data_sources      â”‚
â”‚  (æ•°æ®æºè¡¨)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘ â†‘
         â”‚ â”‚ (source_id, target_id)
         â”‚ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   sync_tasks        â”‚
â”‚  (ä»»åŠ¡ä¸»è¡¨)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (task_id)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task_unit_configs   â”‚
â”‚ (ä»»åŠ¡å•å…ƒé…ç½®è¡¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (task_id + unit_name)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task_unit_runtimes  â”‚
â”‚ (ä»»åŠ¡å•å…ƒè¿è¡Œè®°å½•è¡¨) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³ç³»è¯´æ˜**:
- `data_sources` â† `sync_tasks`: 1:Nï¼ˆä¸€ä¸ªæ•°æ®æºå¯ä»¥è¢«å¤šä¸ªä»»åŠ¡ä½¿ç”¨ï¼‰
- `sync_tasks` â†’ `task_unit_configs`: 1:Nï¼ˆä¸€ä¸ªä»»åŠ¡åŒ…å«å¤šä¸ªå•å…ƒé…ç½®ï¼‰
- `task_unit_configs` â†’ `task_unit_runtimes`: 1:1ï¼ˆä¸€ä¸ªé…ç½®å¯¹åº”ä¸€ä¸ªè¿è¡Œè®°å½•ï¼‰

---

## ğŸ”„ ä¸‰è¡¨ç»“æ„å·¥ä½œæµç¨‹

### 1. ä»»åŠ¡åˆ›å»º

```
ç”¨æˆ·åˆ›å»ºä»»åŠ¡
   â†“
ä¿å­˜åˆ° sync_tasks è¡¨
   â†“
ä» config æå–å•å…ƒåˆ—è¡¨
   â†“
ä¿å­˜åˆ° task_unit_configs è¡¨
```

### 2. ä»»åŠ¡å¯åŠ¨ï¼ˆé¦–æ¬¡ï¼‰

```
ç”¨æˆ·å¯åŠ¨ä»»åŠ¡
   â†“
TaskLoader::init_task_units
   â†“
ä» task_unit_configs è¯»å–å•å…ƒåˆ—è¡¨
   â†“
ä¸ºæ¯ä¸ªå•å…ƒåˆ›å»ºè¿è¡Œè®°å½•
   â†“
ä¿å­˜åˆ° task_unit_runtimes è¡¨ï¼ˆstatus = pendingï¼‰
```

### 3. ä»»åŠ¡æ‰§è¡Œ

```
TaskManager::execute_auto_mode
   â†“
ä» task_unit_runtimes åŠ è½½å•å…ƒ
   â†“
è¿‡æ»¤æœªå®Œæˆå•å…ƒï¼ˆstatus != completedï¼‰
   â†“
å¹¶å‘æ‰§è¡Œ
   â”œâ”€ æ›´æ–° status = running
   â”œâ”€ æ›´æ–° processed_records
   â””â”€ æ›´æ–° status = completed/failed
```

### 4. ä»»åŠ¡é‡å¯ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰

```
ç”¨æˆ·é‡å¯ä»»åŠ¡
   â†“
TaskLoader::init_task_units
   â†“
ä» task_unit_configs è¯»å–å•å…ƒåˆ—è¡¨
   â†“
åŠ è½½ç°æœ‰çš„ task_unit_runtimes
   â†“
å¯¹æ¯”é…ç½®å’Œè¿è¡Œè®°å½•
   â”œâ”€ å·²å®Œæˆ â†’ ä¿æŒ completed
   â”œâ”€ è¿è¡Œä¸­ â†’ é‡ç½®ä¸º pending
   â””â”€ å¤±è´¥ â†’ ä¿æŒ failed
   â†“
æ¸…ç†å­¤ç«‹çš„è¿è¡Œè®°å½•
```

---

## ğŸ“ æ•°æ®æ“ä½œç¤ºä¾‹

### åˆ›å»ºä»»åŠ¡

```go
// 1. ä¿å­˜ä»»åŠ¡ä¸»è¡¨
task := &SyncTask{
    ID:         uuid.New().String(),
    Name:       "MySQL to ES Sync",
    SourceID:   "source-123",
    TargetID:   "target-456",
    SourceType: "mysql",
    TargetType: "elasticsearch",
    Config:     configJSON,
    Status:     "idle",
    SyncMode:   "auto",
}
db.Create(task)

// 2. æå–å¹¶ä¿å­˜å•å…ƒé…ç½®
unitConfigs := extractUnitConfigs(config)
for _, unitConfig := range unitConfigs {
    db.Create(&unitConfig)
}
```

### åˆå§‹åŒ–ä»»åŠ¡å•å…ƒ

```go
// ä»é…ç½®è¡¨è¯»å–
var configs []TaskUnitConfig
db.Where("task_id = ?", taskID).Find(&configs)

// åŠ è½½ç°æœ‰è¿è¡Œè®°å½•
var existingRuntimes []TaskUnitRuntime
db.Where("task_id = ?", taskID).Find(&existingRuntimes)

// åˆ›å»ºæˆ–æ›´æ–°è¿è¡Œè®°å½•
for _, config := range configs {
    var runtime TaskUnitRuntime
    result := db.Where("task_id = ? AND unit_name = ?", taskID, config.UnitName).First(&runtime)
    
    if result.Error != nil {
        // åˆ›å»ºæ–°è®°å½•
        runtime = TaskUnitRuntime{
            ID:               uuid.New().String(),
            TaskID:           taskID,
            UnitName:         config.UnitName,
            Status:           "pending",
            TotalRecords:     0,
            ProcessedRecords: 0,
        }
        db.Create(&runtime)
    } else if runtime.Status == "running" {
        // é‡ç½®ä¸ºpending
        db.Model(&runtime).Update("status", "pending")
    }
}
```

### æ›´æ–°è¿›åº¦

```go
// æ›´æ–°è¿è¡Œè®°å½•
db.Model(&TaskUnitRuntime{}).
    Where("task_id = ? AND unit_name = ?", taskID, unitName).
    Updates(map[string]interface{}{
        "total_records":     totalRecords,
        "processed_records": processedRecords,
    })
```

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### 1. é…ç½®ä¸è¿è¡Œåˆ†ç¦»
- `task_unit_configs`: å­˜å‚¨é…ç½®ï¼ˆä¸å˜ï¼‰
- `task_unit_runtimes`: å­˜å‚¨è¿è¡ŒçŠ¶æ€ï¼ˆå¯å˜ï¼‰
- æ”¯æŒé‡ç½®è¿è¡Œè®°å½•è€Œä¸å½±å“é…ç½®

### 2. æ–­ç‚¹ç»­ä¼ æ”¯æŒ
- è¿è¡Œè®°å½•æŒä¹…åŒ–åˆ°æ•°æ®åº“
- æ”¯æŒä»»åŠ¡æš‚åœã€æ¢å¤ã€é‡å¯
- å·²å®Œæˆå•å…ƒä¸é‡å¤æ‰§è¡Œ

### 3. æ•°æ®ä¸€è‡´æ€§
- å¤–é”®çº¦æŸä¿è¯å¼•ç”¨å®Œæ•´æ€§
- å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤æ•°æ®
- çº§è”åˆ é™¤è‡ªåŠ¨æ¸…ç†å…³è”æ•°æ®

### 4. æŸ¥è¯¢æ€§èƒ½
- åˆç†çš„ç´¢å¼•è®¾è®¡
- æ”¯æŒé«˜æ•ˆçš„çŠ¶æ€è¿‡æ»¤
- æ”¯æŒå¿«é€Ÿçš„å…³è”æŸ¥è¯¢

---

## ğŸ” å¸¸ç”¨æŸ¥è¯¢

### æŸ¥è¯¢ä»»åŠ¡çš„æ‰€æœ‰å•å…ƒ

```sql
SELECT 
    c.unit_name,
    c.unit_type,
    r.status,
    r.total_records,
    r.processed_records
FROM task_unit_configs c
LEFT JOIN task_unit_runtimes r 
    ON c.task_id = r.task_id AND c.unit_name = r.unit_name
WHERE c.task_id = ?
ORDER BY c.unit_name;
```

### æŸ¥è¯¢æœªå®Œæˆçš„å•å…ƒ

```sql
SELECT * FROM task_unit_runtimes
WHERE task_id = ? AND status != 'completed'
ORDER BY unit_name;
```

### æŸ¥è¯¢å¤±è´¥çš„å•å…ƒ

```sql
SELECT * FROM task_unit_runtimes
WHERE task_id = ? AND status = 'failed'
ORDER BY unit_name;
```

### ç»Ÿè®¡ä»»åŠ¡è¿›åº¦

```sql
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,
    SUM(CASE WHEN status = 'running' THEN 1 ELSE 0 END) as running,
    SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
    SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending
FROM task_unit_runtimes
WHERE task_id = ?;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿè®¾è®¡æ–‡æ¡£](./requirements.md) - å®Œæ•´çš„ç³»ç»Ÿè®¾è®¡
- [APIæ¥å£è®¾è®¡](../docs/03-APIæ¥å£è®¾è®¡.md) - APIæ¥å£è§„èŒƒ
- [ç®¡é“è®¾è®¡](../docs/04-ç®¡é“è®¾è®¡.md) - Pipelineæ ¸å¿ƒè®¾è®¡

---

**æ–‡æ¡£ç»´æŠ¤**: DataTraceå¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-02-27
