# DataTrace 系统设计概览

## 📋 文档说明

本文档是 DataTrace 数据同步系统的设计概览，提供系统的整体架构和功能模块的简要说明。详细设计请参考各子文档。

**文档版本**: v2.0  
**最后更新**: 2026-02-27  
**技术栈**: Go + Gin + MySQL  
**状态**: 设计阶段

---

## 🎯 系统简介

DataTrace 是一个基于 Go + Gin 的 Web 数据同步工具，支持 MySQL 和 Elasticsearch 之间的双向数据同步。

**核心特性**:
- ✅ 支持 4 种同步方向（MySQL↔ES, MySQL↔MySQL, ES↔ES）
- ✅ 可视化任务配置向导（Web界面）
- ✅ 实时任务监控和进度展示（SSE推送）
- ✅ 断点续传（以表/索引为单位）
- ✅ 并发控制和任务调度（goroutine池）
- ✅ 分类日志系统
- ✅ 数据源加密存储（AES-256-GCM）

---

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    前端层 (Go HTML Template + Bootstrap)     │
│  ┌──────────────┬──────────────┬──────────────────────────┐ │
│  │  Templates   │  Static      │  JavaScript              │ │
│  │  HTML模板     │  CSS/JS/图片  │  交互逻辑                 │ │
│  └──────────────┴──────────────┴──────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                    ↕ HTTP + SSE (Server-Sent Events)
┌─────────────────────────────────────────────────────────────┐
│                    后端层 (Go + Gin)                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  API层 (Gin Handlers)                                 │  │
│  │  ├─ DataSource API (数据源管理)                       │  │
│  │  ├─ Task API (任务管理)                               │  │
│  │  └─ Monitor API (监控和SSE推送)                       │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Service层 (业务逻辑)                                  │  │
│  │  ├─ DataSourceService                                 │  │
│  │  ├─ TaskService                                        │  │
│  │  └─ SyncService                                        │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  核心底座 (Pipeline Core)                              │  │
│  │  ├─ Source (Reader接口: MySQL/ES)                     │  │
│  │  ├─ Transformer (数据转换)                            │  │
│  │  ├─ Sink (Writer接口: MySQL/ES)                       │  │
│  │  ├─ TaskManager (调度器 & 并发控制)                   │  │
│  │  └─ ProgressMonitor (监控 & SSE推送)                  │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  数据层 (GORM + MySQL)                                 │  │
│  │  ├─ Models (数据模型)                                  │  │
│  │  └─ Database (连接池)                                  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

**详细架构设计**:
- [系统设计文档](./requirements.md) ⭐ 已更新
- [数据库设计](./数据库设计.md) ⭐ 已更新
- [任务管理器](./features/任务管理器.md) ⭐ 已更新

---

## 🎨 核心功能模块

### 1. Pipeline 管道框架 ⭐ 核心底座
采用 Source-Transformer-Sink 三段式设计，实现"一套代码支持所有组合"。

**组件说明**:
- **Source (数据源)**: 负责数据读取（MySQL, ES等）
- **Transformer (转换器)**: 负责数据转换和映射
- **Sink (数据写入)**: 负责数据写入
- **统一数据格式**: 使用 `map[string]interface{}` 作为中间格式

**详细设计**: [系统设计文档](./requirements.md) - 管道设计章节

### 2. 任务管理器 (TaskManager) ⭐ 核心
统一调度中心，负责任务单元的并发执行和状态管理。

**核心功能**:
- 任务单元管理（表/索引级别）
- 并发控制（goroutine + channel）
- 状态同步（内存 + 数据库 + SSE）
- 断点续传支持

**详细设计**: [任务管理器](./features/任务管理器.md) ⭐ 已更新

### 3. 同步引擎 (SyncEngine)
作为"工厂"根据任务配置动态组装 Pipeline，不直接编写同步逻辑。

**工作流程**:
1. 根据任务配置识别同步方向
2. 创建对应的 Source 和 Sink
3. 配置 Transformer 转换规则
4. 组装成完整的 Pipeline
5. 交给 TaskManager 执行

### 4. 数据源管理
管理 MySQL 和 Elasticsearch 的连接配置。

**功能**:
- 数据源 CRUD
- 连接测试
- 密码加密存储（AES-256-GCM）

### 5. 任务配置
可视化的任务配置向导（4步向导）。

**配置步骤**:
1. 选择源和目标数据源
2. 选择要同步的表/索引
3. 配置同步参数（批次大小、并发数、错误策略）
4. 确认并保存

### 6. 任务监控
实时展示任务执行进度、任务单元状态、日志信息。

**监控方式**:
- SSE 实时推送进度
- 总体进度条
- 单元级进度表格
- 分类日志展示（实时日志、错误日志）

### 7. 日志系统
提供分类日志，满足不同场景的查看需求。

**日志类型**:
- **实时日志**: 所有详细信息
- **错误日志**: 错误和警告信息
- **系统日志**: 系统级别的操作记录

---

## 🗄️ 数据库设计

### 核心表结构

**1. data_sources - 数据源表**
- 存储 MySQL 和 ES 的连接信息
- 密码加密存储

**2. sync_tasks - 任务主表**
- 存储任务基本信息和配置（JSON格式）
- 支持多种同步模式

**3. task_unit_configs - 任务单元配置表**
- 存储要同步的表/索引列表
- 从任务配置中提取

**4. task_unit_runtimes - 任务单元运行记录表**
- 存储任务单元的执行状态和进度
- 支持断点续传

**详细设计**: [数据库设计](./数据库设计.md) ⭐ 已更新

---

## 🔄 核心工作流程

### 任务执行流程

```
1. 用户启动任务
   ↓
2. TaskService 加载任务配置
   ↓
3. TaskService 初始化任务单元
   - 从配置表读取单元列表
   - 创建/更新运行记录表
   - 支持断点续传（已完成的保持状态）
   ↓
4. TaskManager 加载任务单元
   - 从运行记录表加载
   - 过滤出未完成的单元
   ↓
5. TaskManager 自动模式执行
   - 使用 channel 控制并发
   - 并发执行所有未完成单元
   - 实时更新状态到数据库
   ↓
6. SyncEngine 执行同步
   - Source 读取源数据
   - Transformer 转换数据格式
   - Sink 写入目标数据源
   - 更新进度
   ↓
7. ProgressMonitor 推送进度
   - 聚合任务单元状态
   - 计算总体进度
   - 通过 SSE 推送到前端
   ↓
8. 任务完成/失败
```

---

## 📊 技术栈

### 后端
- **语言**: Go 1.21+
- **Web框架**: Gin
- **ORM**: GORM
- **配置管理**: Viper
- **日志**: Zap
- **任务调度**: robfig/cron
- **协程池**: ants
- **数据库**: MySQL 5.7+
- **MySQL客户端**: go-sql-driver/mysql
- **ES客户端**: olivere/elastic

### 前端
- **模板引擎**: Go HTML Template
- **UI框架**: Bootstrap 5
- **JavaScript**: 原生 JS + Fetch API
- **实时通信**: Server-Sent Events (SSE)

### 数据库
- **配置存储**: MySQL
- **数据源**: MySQL, Elasticsearch

---

## 📝 命名规范

### Go 代码规范

**结构体和接口**:
```go
// 大驼峰命名（导出）
type TaskManager struct {
    taskUnits sync.Map
}

// 小驼峰命名（私有）
type taskUnit struct {
    id   string
    name string
}
```

**数据库字段**:
```sql
-- 使用 snake_case
CREATE TABLE task_unit_runtimes (
    id VARCHAR(36) PRIMARY KEY,
    task_id VARCHAR(36) NOT NULL,
    unit_name VARCHAR(200) NOT NULL
);
```

**JSON 序列化**:
```go
type TaskUnit struct {
    ID   string `json:"id"`      // JSON 使用小驼峰
    Name string `json:"name"`
}
```

---

## 🚀 开发状态

### 已完成 ✅
- [x] 系统设计文档
- [x] 数据库设计文档
- [x] 任务管理器设计文档

### 进行中 🚧
- [ ] 基础框架搭建
- [ ] 数据源管理实现
- [ ] 任务配置实现
- [ ] Pipeline 核心实现
- [ ] 任务执行和监控

### 待规划 📋
- [ ] MySQL→MySQL 同步实现
- [ ] MySQL→ES 同步实现
- [ ] ES→MySQL 同步实现
- [ ] ES→ES 同步实现
- [ ] 性能优化和监控
- [ ] 数据校验功能

---

## 📚 相关文档

### 核心设计文档 ⭐
- [系统设计文档](./requirements.md) - 完整的系统设计
- [数据库设计](./数据库设计.md) - 数据库表结构
- [任务管理器](./features/任务管理器.md) - 任务调度核心

### 其他文档
- [README](./README.md) - 文档导航

---

## 📞 联系方式

如有问题或建议，请联系开发团队。

**文档维护**: DataTrace 开发团队  
**最后更新**: 2026-02-27
