# 后端同步引擎重构记录

## 重构时间
2025-01-27

## 重构原因
为了与前端的组件结构保持一致，将后端的同步逻辑按照数据源类型进行分类组织，提高代码的可维护性和可扩展性。

## 重构前的结构

```
src-tauri/src/sync_engine/
├── mod.rs                      # 主模块（包含所有同步逻辑）
├── types.rs                    # 类型定义
├── mysql_sync.rs               # MySQL 通用操作
└── es_sync.rs                  # ES 通用操作
```

**问题：**
- 所有同步逻辑都在 `mod.rs` 中，文件过大
- 代码中引用了不存在的模块（`mysql_to_es_impl`、`es_to_mysql_impl`）
- 不同同步类型的逻辑混在一起，难以维护

## 重构后的结构

```
src-tauri/src/sync_engine/
├── mod.rs                      # 主模块（协调和调度）
├── types.rs                    # 类型定义
├── mysql_sync.rs               # MySQL 通用操作
├── es_sync.rs                  # ES 通用操作
└── implementations/            # 各种同步类型的实现
    ├── mod.rs                  # 实现模块入口
    ├── mysql_to_mysql.rs       # MySQL → MySQL 同步实现
    ├── mysql_to_es.rs          # MySQL → ES 同步实现
    ├── es_to_mysql.rs          # ES → MySQL 同步实现
    └── es_to_es.rs             # ES → ES 同步实现
```

## 新增文件列表

### 1. implementations/mod.rs
**作用：** 实现模块的入口，声明所有同步类型的子模块

```rust
pub mod mysql_to_mysql;
pub mod mysql_to_es;
pub mod es_to_mysql;
pub mod es_to_es;
```

### 2. implementations/mysql_to_mysql.rs
**功能：**
- MySQL → MySQL 同步实现
- 支持数据库名称转换
- 支持表结构自动创建
- 批量数据传输

**状态：** 待实现（框架已创建）

### 3. implementations/mysql_to_es.rs
**功能：**
- MySQL → Elasticsearch 同步实现
- 自动类型映射（MySQL → ES）
- 支持批量索引
- 数据转换和清洗

**状态：** 待实现（框架已创建）

### 4. implementations/es_to_mysql.rs
**功能：**
- Elasticsearch → MySQL 同步实现
- 自动类型映射（ES → MySQL）
- 支持索引模式匹配
- 批量数据写入

**状态：** 待实现（框架已创建）

### 5. implementations/es_to_es.rs
**功能：**
- Elasticsearch → Elasticsearch 同步实现
- 支持索引名称转换
- 支持多个搜索条件组
- 批量重索引

**状态：** 待实现（框架已创建）

## 修改的文件

### src-tauri/src/sync_engine/mod.rs

**修改内容：**

1. **模块声明**
   ```rust
   // 修改前
   mod mysql_to_es_impl;
   mod es_to_mysql_impl;
   
   // 修改后
   mod implementations;
   ```

2. **同步方法调用**
   ```rust
   // 修改前
   mysql_to_es_impl::sync_mysql_to_es_impl(self, config).await
   
   // 修改后
   implementations::mysql_to_es::sync_mysql_to_es(self, config).await
   ```

3. **删除重复方法**
   - 删除了文件末尾重复的 `sync_*_impl` 方法定义

## 重构效果

### ✅ 优点

1. **结构清晰**
   - 每种同步类型独立文件
   - 职责划分明确
   - 与前端结构对应

2. **易于维护**
   - 修改某种同步类型不影响其他类型
   - 代码文件大小合理（每个文件 < 300 行）
   - 便于定位和修复问题

3. **易于扩展**
   - 添加新的同步类型只需创建新文件
   - 不需要修改主模块代码
   - 遵循开闭原则

4. **代码复用**
   - 通用操作在 `mysql_sync.rs` 和 `es_sync.rs` 中
   - 特定逻辑在各自的实现文件中
   - 避免代码重复

### 📊 文件对比

| 项目 | 重构前 | 重构后 |
|------|--------|--------|
| 文件数量 | 4个 | 9个 |
| 主模块大小 | 约400行 | 约350行 |
| 代码组织 | 混合 | 分类 |
| 可维护性 | 中 | 高 |

## 与前端结构对应

### 前端组件结构
```
src/components/SyncTaskWizard/TaskTypes/
├── MySQLToMySQL/
├── MySQLToES/
├── ESToMySQL/
└── ESToES/
```

### 后端实现结构
```
src-tauri/src/sync_engine/implementations/
├── mysql_to_mysql.rs
├── mysql_to_es.rs
├── es_to_mysql.rs
└── es_to_es.rs
```

**对应关系：**
- 前端：`MySQLToMySQL/` ↔ 后端：`mysql_to_mysql.rs`
- 前端：`MySQLToES/` ↔ 后端：`mysql_to_es.rs`
- 前端：`ESToMySQL/` ↔ 后端：`es_to_mysql.rs`
- 前端：`ESToES/` ↔ 后端：`es_to_es.rs`

## 编译验证

✅ **编译通过**
- 无错误
- 只有未使用变量的警告（已修复）
- 所有模块正确导入

## 下一步工作

1. **实现具体的同步逻辑**
   - 在各个实现文件中填充实际的同步代码
   - 实现数据读取、转换、写入逻辑
   - 添加错误处理和进度更新

2. **添加单元测试**
   - 为每种同步类型编写测试
   - 测试边界情况和错误处理

3. **性能优化**
   - 优化批量操作
   - 实现并发控制
   - 添加缓存机制

4. **文档完善**
   - 为每个实现文件添加详细注释
   - 编写使用示例
   - 更新 API 文档

## 总结

本次重构成功地将后端同步引擎按照数据源类型进行了分类组织，与前端结构保持一致。重构后的代码结构更加清晰，易于维护和扩展。虽然目前各个实现文件中的具体逻辑还待实现，但框架已经搭建完成，为后续开发奠定了良好的基础。


---

## 日志分类系统完善

### 完善时间
2025-01-28

### 完善内容

#### 1. 日志分类系统设计

实现了基于后端标签的日志分类系统,将同步任务的日志分为 4 个类别:

- **实时日志 (Realtime)**: 显示所有详细的同步过程信息
- **明细日志 (Summary)**: 显示批次级别的摘要信息
- **校验日志 (Verify)**: 显示数据校验结果
- **错误日志 (Error)**: 显示错误和警告信息

#### 2. 后端实现

**日志分类枚举** (`src-tauri/src/progress_logger.rs`):
```rust
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
#[serde(rename_all = "lowercase")]
pub enum LogCategory {
    Realtime,  // 实时日志
    Summary,   // 明细日志
    Verify,    // 校验日志
    Error,     // 错误日志
}
```

**日志条目结构**:
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct LogEntry {
    pub timestamp: String,
    pub level: LogLevel,
    pub category: LogCategory,  // 日志分类标签
    pub message: String,
}
```

**统一日志接口** (`src-tauri/src/progress.rs`):
```rust
pub fn add_log(&self, task_id: &str, level: LogLevel, category: LogCategory, message: String) {
    self.logger.add_log(task_id, level, category, message);
}
```

#### 3. ES→ES 实现中的日志分类

在 `src-tauri/src/sync_engine/implementations/es_to_es.rs` 中实现了完整的日志分类:

**实时日志**:
- 批次读取信息: "第 N 批：读取到 X 条记录"
- 批次写入信息: "第 N 批：开始写入 X 条记录到目标索引"
- 实时进度信息: "已同步 X / Y 条记录 (Z%)"

**明细日志**:
- 批次开始: "批次 N/M 开始处理，本批 X 条记录"
- 批次完成: "批次 N 完成，已同步: X 条，剩余: Y 批次"

**校验日志**:
- 单个索引完成: "索引 X 同步完成，共同步 Y 条记录"
- 数据校验结果: "✓ 索引 X 数据校验通过：源 Y 条 = 目标 Z 条"
- 总体统计: "✓ 所有索引同步完成：成功 X/Y 个索引"

**错误日志**:
- bulk 写入失败: "第 N 批：bulk 写入部分失败"

#### 4. 前端实现

在 `src/views/TaskMonitor.vue` 中实现了基于 `category` 字段的日志过滤:

```typescript
// 实时日志：显示所有日志
const allLogs = ref<any[]>([])

// 明细日志：根据 category 字段过滤
const detailLogs = computed(() => {
  return allLogs.value.filter(log => log.category === 'summary')
})

// 校验日志：根据 category 字段过滤
const verifyLogs = computed(() => {
  return allLogs.value.filter(log => log.category === 'verify')
})
```

#### 5. 设计原则

1. **后端打标签**: 日志分类在后端完成,通过 `category` 字段标识
2. **前端过滤**: 前端根据 `category` 字段过滤,不通过消息内容判断
3. **统一接口**: 所有同步实现使用统一的 `add_log` 方法
4. **清晰分类**: 每条日志只属于一个分类,避免重复
5. **用户友好**: 不同用户场景可以选择查看不同级别的日志

#### 6. 控制台日志优化

- 移除了后端控制台的详细日志输出 (`log::info!`)
- 只保留错误日志 (`log::error!`)
- 所有日志通过事件推送到前端显示

### 完善效果

✅ **优点**:
1. 日志分类清晰,用户可以根据需要查看不同级别的日志
2. 后端打标签的方式更加可靠,避免前端通过消息内容判断的不确定性
3. 统一的日志接口便于维护和扩展
4. 控制台不再输出大量日志,提高性能

### 相关文档

详细的日志分类系统说明请参考: [日志分类系统说明.md](./日志分类系统说明.md)

### 待完善

以下同步实现还需要添加日志分类支持:
- [ ] MySQL → MySQL
- [ ] MySQL → ES
- [ ] ES → MySQL

实现时需要参考 ES→ES 的实现方式,在关键节点添加对应分类的日志。
