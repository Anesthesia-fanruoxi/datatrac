# 日志分类系统说明

## 概述

日志分类系统通过后端打标签的方式,将同步任务的日志分为 4 个类别,前端根据标签进行过滤显示。

## 日志分类

### 1. 实时日志 (Realtime)
- **用途**: 显示所有详细的同步过程信息
- **内容**: 
  - 批次读取信息 (第 N 批：读取到 X 条记录)
  - 批次写入信息 (第 N 批：开始写入 X 条记录到目标索引)
  - 实时进度信息 (已同步 X / Y 条记录 (Z%))
  - 所有操作的详细日志
- **适用场景**: 开发调试、详细监控同步过程

### 2. 明细日志 (Summary)
- **用途**: 显示批次级别的摘要信息
- **内容**:
  - 批次开始 (批次 N/M 开始处理，本批 X 条记录)
  - 批次完成 (批次 N 完成，已同步: X 条，剩余: Y 批次)
  - 关键节点的摘要信息
- **适用场景**: 了解同步进度的关键节点,不需要看所有细节

### 3. 校验日志 (Verify)
- **用途**: 显示数据校验结果
- **内容**:
  - 单个索引/表同步完成的记录数统计
  - 源和目标数据量对比 (✓ 通过 / ⚠ 失败)
  - 所有索引/表同步完成的总体统计
- **适用场景**: 验证数据同步的正确性和完整性

### 4. 错误日志 (Error)
- **用途**: 显示错误和警告信息
- **内容**:
  - 同步过程中的错误信息
  - bulk 写入部分失败的警告
  - 其他异常情况
- **适用场景**: 排查同步失败的原因

## 技术实现

### 后端实现

#### 1. 日志分类枚举 (`src-tauri/src/progress_logger.rs`)

```rust
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
#[serde(rename_all = "lowercase")]
pub enum LogCategory {
    Realtime,  // 实时日志
    Summary,   // 明细日志
    Verify,    // 校验日志
    Error,     // 错误日志
}
```

#### 2. 日志条目结构

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct LogEntry {
    pub timestamp: String,
    pub level: LogLevel,
    pub category: LogCategory,  // 日志分类标签
    pub message: String,
}
```

#### 3. 添加日志方法

```rust
// ProgressMonitor 提供统一的日志接口
pub fn add_log(&self, task_id: &str, level: LogLevel, category: LogCategory, message: String) {
    self.logger.add_log(task_id, level, category, message);
}
```

### 前端实现

#### 1. 日志过滤 (`src/views/TaskMonitor.vue`)

```typescript
// 实时日志：显示所有日志
const allLogs = ref<any[]>([])

// 明细日志：根据 category 字段过滤
const detailLogs = computed(() => {
  return allLogs.value.filter(log => log.category === 'summary')
})

// 校验日志：根据 category 字段过滤
const verifyLogs = computed(() => {
  return allLogs.value.filter(log => log.category === 'verify')
})

// 错误日志：单独管理
const errorLogs = taskMonitorStore.errors
```

#### 2. 标签页显示

- **实时日志**: 显示 `allLogs` (所有日志)
- **明细日志**: 显示 `detailLogs` (category === 'summary')
- **校验日志**: 显示 `verifyLogs` (category === 'verify')
- **错误日志**: 显示 `errorLogs` (单独的错误管理系统)

## 使用示例

### ES→ES 同步实现

```rust
// 1. 实时日志 - 记录详细操作
progress_monitor.add_log(
    &config.task_id,
    LogLevel::Info,
    LogCategory::Realtime,
    format!("第 {} 批：读取到 {} 条记录", batch_count, hits.len())
);

// 2. 明细日志 - 记录批次摘要
progress_monitor.add_log(
    &config.task_id,
    LogLevel::Info,
    LogCategory::Summary,
    format!("批次 {} 完成，已同步: {} 条，剩余: {} 批次", batch_count, total_count, remaining_batches)
);

// 3. 校验日志 - 记录数据校验结果
progress_monitor.add_log(
    &config.task_id,
    LogLevel::Info,
    LogCategory::Verify,
    format!("✓ 索引 {} 数据校验通过：源 {} 条 = 目标 {} 条", source_index, total_count, target_count)
);

// 4. 错误日志 - 记录错误信息
progress_monitor.add_log(
    &config.task_id,
    LogLevel::Warn,
    LogCategory::Error,
    format!("第 {} 批：bulk 写入部分失败", batch_count)
);
```

## 设计原则

1. **后端打标签**: 日志分类在后端完成,通过 `category` 字段标识
2. **前端过滤**: 前端根据 `category` 字段过滤,不通过消息内容判断
3. **统一接口**: 所有同步实现使用统一的 `add_log` 方法
4. **清晰分类**: 每条日志只属于一个分类,避免重复
5. **用户友好**: 不同用户场景可以选择查看不同级别的日志

## 待实现

以下同步实现还需要添加日志分类支持:
- [ ] MySQL → MySQL
- [ ] MySQL → ES
- [ ] ES → MySQL

实现时需要参考 ES→ES 的实现方式,在关键节点添加对应分类的日志。
