# 任务创建流程说明文档

## 概述

本文档详细说明了数据同步工具中任务创建和配置的完整流程，包括涉及的文件、关键代码和逻辑流程。

## 核心设计理念

**创建任务**和**配置任务**是两个独立的阶段：
- **创建任务**：只定义任务名称和数据源类型（源类型 + 目标类型），保存后关闭对话框
- **配置任务**：通过编辑按钮进入，完成数据源选择、表/索引选择、同步参数配置等详细配置

## 涉及的核心文件

### 1. 视图层
- **src/views/SyncTaskConfig.vue** - 任务列表页面，包含创建和编辑入口

### 2. 组件层
- **src/components/SyncTaskWizard/index.vue** - 任务向导主组件，控制整个流程
- **src/components/SyncTaskWizard/Step1SelectDataSourceType.vue** - 前置配置组件（任务名称 + 数据源类型选择）
- **src/components/SyncTaskWizard/DataSourceTypeSelector.vue** - 数据源类型选择对话框
- **src/components/SyncTaskWizard/TaskHeader.vue** - 任务头部组件（显示任务名称和类型）
- **src/components/SyncTaskWizard/shared/DataSourceSelector.vue** - 具体数据源选择组件

### 3. 数据层
- **src/stores/syncTask.ts** - 任务数据管理 Store

### 4. 类型定义
- **src/types/index.ts** - TypeScript 类型定义

## 完整流程详解

### 一、新建任务流程

#### 1. 用户点击"创建任务"按钮

**文件：** `src/views/SyncTaskConfig.vue`

**函数：** `handleAdd()`

```typescript
function handleAdd() {
  isEdit.value = false
  formData.value = {
    name: '',
    sourceId: '',
    targetId: '',
    sourceType: 'mysql',
    targetType: 'mysql',
    // ... 其他默认配置
  }
  showModal.value = true
}
```

**作用：**
- 设置编辑模式标志 `isEdit = false`
- 重置表单数据 `formData`
- 打开向导对话框

---

#### 2. 向导对话框打开（新建模式）

**文件：** `src/components/SyncTaskWizard/index.vue`

**监听器：** `watch(() => props.modelValue)`

```typescript
watch(() => props.modelValue, (newValue) => {
  if (newValue && props.isEdit) {
    // 编辑模式逻辑...
  } else if (newValue && !props.isEdit) {
    // 新建模式：重置到前置配置
    taskType.value = ''
    sourceTypeSelected.value = ''
    targetTypeSelected.value = ''
    currentStep.value = 1
  }
})
```

**作用：**
- 检测到对话框打开且为新建模式
- 重置所有状态变量
- `taskType` 为空，触发显示前置配置界面

**模板逻辑：**
```vue
<!-- 前置配置：任务名称和数据源类型（不算步骤） -->
<template v-if="!taskType">
  <Step1SelectDataSourceType
    v-model:task-name="formData.name"
    v-model:source-type="sourceTypeSelected"
    v-model:target-type="targetTypeSelected"
  />
</template>
```

---

#### 3. 前置配置阶段

**文件：** `src/components/SyncTaskWizard/Step1SelectDataSourceType.vue`

**界面元素：**
1. **任务名称输入框**
   - 双向绑定到 `formData.name`
   
2. **源数据源类型按钮**（左侧）
   - 点击打开 `DataSourceTypeSelector` 对话框
   - 选择后更新 `sourceTypeSelected`
   
3. **箭头图标**（中间）
   - 视觉指示：源 → 目标
   
4. **目标数据源类型按钮**（右侧）
   - 点击打开 `DataSourceTypeSelector` 对话框
   - 选择后更新 `targetTypeSelected`

**布局：**
```
┌─────────────────────────────────────────────────┐
│ 任务名称: [___________________________]         │
│                                                 │
│ [源数据源类型按钮]  →  [目标数据源类型按钮]      │
│                                                 │
│ ✓ 任务类型：MySQL → Elasticsearch 数据同步      │
└─────────────────────────────────────────────────┘
```

**关键点：**
- 用户选择类型后，`sourceTypeSelected` 和 `targetTypeSelected` 被更新
- **不会自动设置 `taskType`**，所以界面保持在前置配置阶段
- 只有当名称和两个类型都填写后，"创建任务"按钮才可用

---

#### 4. 点击"创建任务"按钮

**文件：** `src/components/SyncTaskWizard/index.vue`

**函数：** `handleStartConfig()`

```typescript
function handleStartConfig() {
  // 前置配置完成，创建任务记录（只保存名称和类型）
  // 调用后端API创建任务，然后关闭对话框
  emit('create', {
    name: props.formData.name,
    sourceType: sourceTypeFromTask.value,
    targetType: targetTypeFromTask.value
  })
  // 不进入步骤1，而是关闭对话框
  // 用户需要在任务列表中点击"编辑"按钮才能进入配置步骤
}
```

**按钮启用条件：** `canStartConfig`

```typescript
const canStartConfig = computed(() => {
  return !!(props.formData.name && 
            props.formData.name.trim() && 
            sourceTypeSelected.value && 
            targetTypeSelected.value)
})
```

**作用：**
- 触发 `create` 事件，传递任务基本信息
- **不进入配置步骤**，等待父组件处理

---

#### 5. 父组件处理创建事件

**文件：** `src/views/SyncTaskConfig.vue`

**函数：** `handleCreate()`

```typescript
async function handleCreate(data: { 
  name: string; 
  sourceType: any; 
  targetType: any 
}) {
  try {
    // 前置配置完成，创建任务记录（只保存名称和类型）
    await syncTaskStore.createTask({
      name: data.name,
      sourceId: '', // 暂时为空，后续步骤中填写
      targetId: '', // 暂时为空，后续步骤中填写
      sourceType: data.sourceType,
      targetType: data.targetType,
      mysqlConfig: { databases: [] },
      esConfig: { indices: [] },
      syncConfig: {
        threadCount: 4,
        batchSize: 1000,
        errorStrategy: 'skip',
        tableExistsStrategy: 'drop'
      },
      status: 'idle'
    })
    
    showSuccess('任务创建成功，请在列表中点击"编辑"按钮进行配置')
    
    // 关闭对话框
    showModal.value = false
    
    // 刷新任务列表
    await loadTasks()
  } catch (error) {
    handleApiError(error, '创建任务失败')
  }
}
```

**作用：**
1. 调用 Store 的 `createTask()` 方法
2. 创建任务记录，只保存名称和类型
3. `sourceId` 和 `targetId` 暂时为空字符串
4. 显示成功提示
5. **关闭对话框**
6. 刷新任务列表

**数据库中的任务记录：**
```json
{
  "id": "uuid-xxx",
  "name": "用户输入的任务名称",
  "sourceType": "mysql",
  "targetType": "elasticsearch",
  "sourceId": "",  // 空
  "targetId": "",  // 空
  "config": "{...}", // 默认配置
  "status": "idle",
  "createdAt": 1234567890,
  "updatedAt": 1234567890
}
```

---

#### 6. 用户在列表中看到新任务

**界面显示：**
- 任务列表刷新，显示新创建的任务
- 任务状态为"空闲"
- 可以点击"编辑"按钮进行配置

---

### 二、编辑任务流程（配置步骤）

#### 7. 用户点击"编辑"按钮

**文件：** `src/views/SyncTaskConfig.vue`

**函数：** `handleEdit()`

```typescript
function handleEdit(row: SyncTask) {
  isEdit.value = true
  formData.value = { ...row }
  showModal.value = true
}
```

**作用：**
- 设置编辑模式标志 `isEdit = true`
- 复制任务数据到 `formData`（包含 id、sourceType、targetType 等）
- 打开向导对话框

---

#### 8. 向导对话框打开（编辑模式）

**文件：** `src/components/SyncTaskWizard/index.vue`

**监听器：** `watch(() => props.modelValue)`

```typescript
watch(() => props.modelValue, (newValue) => {
  if (newValue && props.isEdit) {
    // 编辑模式：从 formData 恢复任务类型，直接进入步骤1
    const { sourceType, targetType } = props.formData
    if (sourceType && targetType) {
      taskType.value = `${sourceType}-${targetType}` as SyncTaskType
      sourceTypeSelected.value = sourceType
      targetTypeSelected.value = targetType
      currentStep.value = 1 // 直接进入步骤1
    }
  } else if (newValue && !props.isEdit) {
    // 新建模式逻辑...
  }
})
```

**作用：**
- 检测到对话框打开且为编辑模式
- 从 `formData` 中恢复 `sourceType` 和 `targetType`
- 设置 `taskType`（例如：'mysql-elasticsearch'）
- 设置 `currentStep = 1`
- **因为 `taskType` 不为空，显示配置步骤界面**

**模板逻辑：**
```vue
<!-- 步骤条和内容（选择类型后显示） -->
<template v-else>
  <!-- 任务头部：显示任务名称和类型 -->
  <TaskHeader
    :task-name="formData.name || ''"
    :source-type="sourceTypeFromTask"
    :target-type="targetTypeFromTask"
    @update:task-name="handleTaskNameUpdate"
  />

  <!-- 步骤条 -->
  <n-steps :current="currentStep" style="margin-bottom: 24px">
    <n-step title="选择数据源" />
    <!-- 根据任务类型显示不同的步骤 -->
  </n-steps>

  <!-- 步骤内容 -->
  <div :style="contentStyle">
    <!-- 动态加载步骤组件 -->
  </div>
</template>
```

---

#### 9. 任务头部显示

**文件：** `src/components/SyncTaskWizard/TaskHeader.vue`

**界面元素：**
1. **任务名称**
   - 默认显示文本
   - 点击铅笔图标可编辑
   - 编辑后自动保存到 `formData.name`
   
2. **数据源类型图标**
   - 源类型图标（MySQL/ES）
   - 箭头
   - 目标类型图标（MySQL/ES）
   - **不可编辑**

**布局：**
```
┌─────────────────────────────────────────────────┐
│ 我的同步任务 ✏️  │  [MySQL图标] → [ES图标]      │
└─────────────────────────────────────────────────┘
```

---

#### 10. 配置步骤详解

##### 步骤1：选择数据源

**组件：** `DataSourceSelector.vue`

**功能：**
- 选择具体的源数据源（从数据源列表中选择）
- 选择具体的目标数据源（从数据源列表中选择）
- 更新 `formData.sourceId` 和 `formData.targetId`

**下一步条件：**
```typescript
if (currentStep.value === 1) {
  return !!(props.formData.sourceId && props.formData.targetId)
}
```

---

##### 步骤2：选择表/索引

**根据任务类型动态加载不同组件：**

| 任务类型 | 组件 | 功能 |
|---------|------|------|
| MySQL → MySQL | `MySQLToMySQL/Step2SelectTables.vue` | 选择表 + 数据库名称转换 |
| MySQL → ES | `MySQLToES/Step2SelectTables.vue` | 选择表 |
| ES → MySQL | `ESToMySQL/Step2SelectIndices.vue` | 输入索引模式，匹配索引 |
| ES → ES | `ESToES/Step2FilterIndices.vue` | 创建搜索条件组 |

**下一步条件：**
- MySQL 任务：至少选择一个表
- ES 任务：至少匹配到一个索引

---

##### 步骤3：同步配置

**组件：** 根据任务类型不同

- **ES → ES**：继续选择索引（`ESToES/Step3SelectIndices.vue`）
- **其他类型**：同步参数配置（`Step3SyncConfig.vue`）

**配置项：**
- 线程数（1-32）
- 批量大小
- 错误处理策略（跳过/暂停）
- 表存在策略（删除/清空/备份）

---

##### 步骤4：确认配置

**组件：** 根据任务类型不同

**功能：**
- 显示任务配置预览
- 显示选择的表/索引列表
- 确认所有配置无误

---

##### 步骤5：最终确认（仅 ES → ES）

**组件：** `ESToES/Step5Confirm.vue`

**功能：**
- ES → ES 任务的最终确认步骤

---

#### 11. 点击"保存"按钮

**文件：** `src/components/SyncTaskWizard/index.vue`

**函数：** `handleSubmit()`

```typescript
function handleSubmit() {
  const submitData: Partial<SyncTask> = {
    ...props.formData,
    sourceType: sourceTypeFromTask.value,
    targetType: targetTypeFromTask.value
  }
  
  // 根据任务类型构建配置
  if (taskType.value === 'elasticsearch-elasticsearch') {
    submitData.esConfig = {
      searchGroups: esSearchGroups.value,
      selectedIndices: esSelectedIndices.value,
      indexNameTransform: esIndexNameTransform.value
    }
  } else if (taskType.value.startsWith('mysql-')) {
    // 构建 MySQL 配置
    const databaseMap = new Map<string, string[]>()
    selectedTables.value.forEach(item => {
      const [database, table] = item.split('.')
      if (!databaseMap.has(database)) {
        databaseMap.set(database, [])
      }
      databaseMap.get(database)!.push(table)
    })
    
    submitData.mysqlConfig = {
      databases: Array.from(databaseMap.entries()).map(([database, tables]) => ({
        database,
        tables
      }))
    }
    
    if (taskType.value === 'mysql-mysql' && dbNameTransform.value.enabled) {
      submitData.syncConfig = {
        ...submitData.syncConfig!,
        dbNameTransform: dbNameTransform.value
      }
    }
  } else if (taskType.value === 'elasticsearch-mysql') {
    submitData.esConfig = {
      indices: [{
        pattern: indexPattern.value,
        matchedIndices: matchedIndices.value
      }]
    }
  }
  
  emit('submit', submitData)
  handleCancel()
}
```

**作用：**
1. 收集所有配置数据
2. 根据任务类型构建不同的配置对象
3. 触发 `submit` 事件
4. 关闭对话框并重置状态

---

#### 12. 父组件处理提交事件

**文件：** `src/views/SyncTaskConfig.vue`

**函数：** `handleSubmit()`

```typescript
async function handleSubmit(data: Partial<SyncTask>) {
  try {
    if (!data.id) {
      handleApiError(new Error('任务 ID 不存在'), '保存任务失败')
      return
    }
    
    // 更新任务配置
    await syncTaskStore.updateTask(data.id, data as SyncTask)
    const taskId = data.id
    
    showSuccess('任务配置保存成功，正在跳转到任务监控...')
    
    showModal.value = false
    await loadTasks()
    
    // 跳转到任务监控页面
    setTimeout(() => {
      router.push({
        path: '/task-monitor',
        query: { taskId }
      })
    }, 500)
  } catch (error) {
    handleApiError(error, '保存任务失败')
  }
}
```

**作用：**
1. 检查任务 ID 是否存在
2. 调用 Store 的 `updateTask()` 方法更新任务
3. 显示成功提示
4. 关闭对话框
5. 刷新任务列表
6. **跳转到任务监控页面**

---

## 关键状态变量说明

### SyncTaskWizard/index.vue

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `taskType` | `SyncTaskType \| ''` | 任务类型，空字符串表示前置配置阶段 |
| `sourceTypeSelected` | `DataSourceType \| ''` | 用户选择的源数据源类型 |
| `targetTypeSelected` | `DataSourceType \| ''` | 用户选择的目标数据源类型 |
| `currentStep` | `number` | 当前步骤（1-5） |
| `selectedTables` | `string[]` | MySQL 任务选择的表列表 |
| `dbNameTransform` | `DbNameTransform` | 数据库名称转换配置 |
| `indexPattern` | `string` | ES 索引匹配模式 |
| `matchedIndices` | `string[]` | 匹配到的索引列表 |
| `esSearchGroups` | `ESSearchGroup[]` | ES 搜索条件组 |
| `esSelectedIndices` | `string[]` | ES 最终选择的索引 |
| `esIndexNameTransform` | `IndexNameTransform` | 索引名称转换配置 |

### SyncTaskConfig.vue

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `showModal` | `boolean` | 是否显示向导对话框 |
| `isEdit` | `boolean` | 是否为编辑模式 |
| `formData` | `Partial<SyncTask>` | 任务表单数据 |

---

## 模板条件渲染逻辑

### SyncTaskWizard/index.vue

```vue
<!-- 前置配置：taskType 为空时显示 -->
<template v-if="!taskType">
  <Step1SelectDataSourceType ... />
</template>

<!-- 配置步骤：taskType 不为空时显示 -->
<template v-else>
  <TaskHeader ... />
  <n-steps ... />
  <div>
    <!-- 步骤1：选择数据源 -->
    <DataSourceSelector v-if="currentStep === 1" ... />
    
    <!-- 步骤2+：动态组件 -->
    <component v-else-if="currentStepComponent" ... />
  </div>
</template>
```

### 按钮显示逻辑

```vue
<!-- 前置配置阶段的按钮 -->
<n-button 
  v-if="!taskType" 
  type="primary" 
  @click="handleStartConfig"
  :disabled="!canStartConfig"
>
  创建任务
</n-button>

<!-- 步骤阶段的按钮 -->
<template v-else>
  <n-button v-if="currentStep > 1" @click="prevStep">上一步</n-button>
  <n-button v-if="currentStep < maxSteps" type="primary" @click="nextStep">
    下一步
  </n-button>
  <n-button v-if="currentStep === maxSteps" type="primary" @click="handleSubmit">
    保存
  </n-button>
</template>
```

---

## 数据流转图

```
用户操作                    组件                        Store                    后端
   │                        │                           │                        │
   ├─ 点击"创建任务"         │                           │                        │
   │                        │                           │                        │
   ├─ 输入任务名称           │                           │                        │
   ├─ 选择源类型             │                           │                        │
   ├─ 选择目标类型           │                           │                        │
   │                        │                           │                        │
   ├─ 点击"创建任务"按钮     │                           │                        │
   │                        ├─ emit('create')           │                        │
   │                        │                           │                        │
   │                        │                           ├─ createTask()          │
   │                        │                           │                        │
   │                        │                           ├─ invoke('create_task') ├─→ 保存到数据库
   │                        │                           │                        │
   │                        ├─ 关闭对话框               │                        │
   │                        ├─ 刷新列表                 │                        │
   │                        │                           │                        │
   ├─ 点击"编辑"按钮         │                           │                        │
   │                        ├─ 打开对话框（编辑模式）    │                        │
   │                        ├─ 显示配置步骤             │                        │
   │                        │                           │                        │
   ├─ 步骤1：选择数据源      │                           │                        │
   ├─ 步骤2：选择表/索引     │                           │                        │
   ├─ 步骤3：同步配置        │                           │                        │
   ├─ 步骤4：确认配置        │                           │                        │
   │                        │                           │                        │
   ├─ 点击"保存"按钮         │                           │                        │
   │                        ├─ emit('submit')           │                        │
   │                        │                           │                        │
   │                        │                           ├─ updateTask()          │
   │                        │                           │                        │
   │                        │                           ├─ invoke('update_task') ├─→ 更新数据库
   │                        │                           │                        │
   │                        ├─ 关闭对话框               │                        │
   │                        ├─ 跳转到任务监控           │                        │
```

---

## 任务类型与步骤映射

| 任务类型 | 步骤1 | 步骤2 | 步骤3 | 步骤4 | 步骤5 |
|---------|-------|-------|-------|-------|-------|
| MySQL → MySQL | 选择数据源 | 选择表 + 数据库名转换 | 同步配置 | 确认配置 | - |
| MySQL → ES | 选择数据源 | 选择表 | 同步配置 | 确认配置 | - |
| ES → MySQL | 选择数据源 | 输入索引模式 | 同步配置 | 确认配置 | - |
| ES → ES | 选择数据源 | 筛选索引 | 选择索引 | 同步配置 | 确认配置 |

---

## 重要注意事项

### 1. taskType 的作用
- `taskType` 为空：显示前置配置界面
- `taskType` 不为空：显示配置步骤界面
- **新建模式不会自动设置 `taskType`**，只在编辑模式时设置

### 2. 创建和配置的分离
- 创建任务只保存名称和类型，不进入配置步骤
- 配置任务必须通过编辑按钮进入
- 这样设计的好处：
  - 用户可以先批量创建多个任务框架
  - 再逐个配置详细参数
  - 避免一次性配置过于复杂

### 3. 任务名称的修改
- 在配置步骤中，任务名称可以通过铅笔图标修改
- 修改后的名称会在最终保存时一起更新
- 数据源类型创建后不可修改

### 4. 数据验证
- 每个步骤都有对应的验证条件（`canGoNext`）
- 只有满足条件才能进入下一步
- 最后一步才能保存任务

### 5. 错误处理
- 所有 API 调用都有 try-catch 错误处理
- 使用统一的错误提示函数 `handleApiError()`
- 创建/更新失败时不会关闭对话框，用户可以修改后重试

---

## 总结

当前的任务创建流程设计清晰、逻辑合理：

✅ **创建和配置完全分离**
- 创建：只定义任务框架（名称 + 类型）
- 配置：完成详细参数设置

✅ **用户体验良好**
- 前置配置界面简洁明了
- 配置步骤循序渐进
- 任务头部清晰显示任务信息

✅ **代码结构清晰**
- 组件职责明确
- 状态管理规范
- 数据流转清晰

✅ **扩展性强**
- 支持多种任务类型
- 易于添加新的数据源类型
- 步骤组件可独立开发

---

## 版本历史

- **v1.0** (2025-01-27) - 初始版本，完整记录任务创建流程
