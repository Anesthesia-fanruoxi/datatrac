# ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ å®æ–½è®°å½•

## ğŸ“… å®æ–½æ—¶é—´
2026-01-28

## ğŸ¯ æ€»ä½“ç›®æ ‡
å®ç°çµæ´»çš„ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ,æ”¯æŒè‡ªåŠ¨/æ‰‹åŠ¨ä¸¤ç§åŒæ­¥æ¨¡å¼,å¹¶æä¾›æ–­ç‚¹ç»­ä¼ èƒ½åŠ›ã€‚

---

## âœ… é˜¶æ®µä¸€:æ–­ç‚¹ç»­ä¼ åŸºç¡€åŠŸèƒ½ (å·²å®Œæˆ)

### å®æ–½å†…å®¹

#### 1. æ•°æ®åº“å±‚
- âœ… åˆ›å»º `task_unit_progress` è¡¨å­˜å‚¨ä»»åŠ¡å•å…ƒè¿›åº¦
- âœ… æ·»åŠ  `sync_mode` å­—æ®µåˆ° `sync_tasks` è¡¨
- âœ… åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- âœ… å®ç°å®Œæ•´çš„ CRUD æ“ä½œ

#### 2. æ•°æ®æ¨¡å‹
- âœ… `TaskUnitProgress` - ä»»åŠ¡å•å…ƒè¿›åº¦è®°å½•
- âœ… `TaskUnitStatus` - ä»»åŠ¡å•å…ƒçŠ¶æ€æšä¸¾
- âœ… `TaskUnitType` - ä»»åŠ¡å•å…ƒç±»å‹æšä¸¾
- âœ… `SyncMode` - åŒæ­¥æ¨¡å¼æšä¸¾

#### 3. æ ¸å¿ƒåŠŸèƒ½
- âœ… ä»»åŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–ä»»åŠ¡å•å…ƒ
- âœ… ä» MySQL é…ç½®æå–è¡¨ååˆ—è¡¨
- âœ… ä» ES é…ç½®æå–ç´¢å¼•ååˆ—è¡¨
- âœ… æ–­ç‚¹ç»­ä¼ é€»è¾‘:
  - completed çŠ¶æ€ä¿æŒä¸å˜
  - å…¶ä»–çŠ¶æ€é‡ç½®ä¸º pending
- âœ… å®æ—¶çŠ¶æ€åŒæ­¥:
  - å†…å­˜ç¼“å­˜ â†’ æ•°æ®åº“ â†’ ProgressMonitor â†’ å‰ç«¯

#### 4. API æ¥å£
- âœ… `get_task_units` - è·å–ä»»åŠ¡çš„æ‰€æœ‰å•å…ƒ
- âœ… `get_task_unit` - è·å–å•ä¸ªä»»åŠ¡å•å…ƒ

#### 5. å‰ç«¯é›†æˆ
- âœ… ä»»åŠ¡å•å…ƒåˆ—è¡¨å±•ç¤º
- âœ… å®æ—¶è¿›åº¦æ›´æ–°
- âœ… çŠ¶æ€é¢œè‰²æ ‡è¯†
- âœ… æŒ‰çŠ¶æ€æ’åºæ˜¾ç¤º

### æ¶‰åŠæ–‡ä»¶

**åç«¯ (Rust)**:
- `src-tauri/src/storage/models.rs` - æ•°æ®æ¨¡å‹å®šä¹‰
- `src-tauri/src/storage/task_unit_ops.rs` - æ•°æ®åº“æ“ä½œ (æ–°å»º)
- `src-tauri/src/storage/mod.rs` - æ•°æ®åº“ schema
- `src-tauri/src/task_manager.rs` - ä»»åŠ¡ç®¡ç†å™¨ (é‡æ„)
- `src-tauri/src/sync_engine/mod.rs` - åˆå§‹åŒ–é€»è¾‘
- `src-tauri/src/commands.rs` - API å‘½ä»¤
- `src-tauri/src/lib.rs` - å‘½ä»¤æ³¨å†Œ

**å‰ç«¯ (TypeScript/Vue)**:
- `src/types/index.ts` - ç±»å‹å®šä¹‰
- `src/stores/taskMonitor.ts` - Store æ–¹æ³•
- `src/views/TaskMonitor/composables/useTaskMonitor.ts` - ä¸šåŠ¡é€»è¾‘
- `src/views/TaskMonitor/components/ProgressPanel.vue` - è¿›åº¦å±•ç¤º

### æ ¸å¿ƒä»£ç ç¤ºä¾‹

#### åˆå§‹åŒ–ä»»åŠ¡å•å…ƒ
```rust
// src-tauri/src/sync_engine/mod.rs
async fn init_task_units(
    &self,
    task_id: &str,
    sync_direction: &SyncDirection,
    mysql_config: &Option<MysqlSyncConfig>,
    es_config: &Option<EsSyncConfig>,
) -> Result<()> {
    let storage = self.source_manager.storage();
    let mut unit_names = Vec::new();
    let unit_type: TaskUnitType;
    
    match sync_direction {
        SyncDirection::MysqlToEs | SyncDirection::MysqlToMysql => {
            unit_type = TaskUnitType::Table;
            if let Some(config) = mysql_config {
                for db in &config.databases {
                    for table in &db.tables {
                        unit_names.push(format!("{}.{}", db.database, table));
                    }
                }
            }
        },
        SyncDirection::EsToMysql | SyncDirection::EsToEs => {
            unit_type = TaskUnitType::Index;
            if let Some(config) = es_config {
                if let Some(indices) = &config.selected_indices {
                    unit_names.extend(indices.clone());
                }
            }
        },
    }
    
    storage.init_task_units(task_id, &unit_names, unit_type).await?;
    Ok(())
}
```

#### æ–­ç‚¹ç»­ä¼ é€»è¾‘
```rust
// src-tauri/src/storage/task_unit_ops.rs
pub async fn init_task_units(
    &self,
    task_id: &str,
    unit_names: &[String],
    unit_type: TaskUnitType,
) -> Result<Vec<TaskUnitProgress>> {
    let existing_units = self.load_task_units(task_id).await?;
    let existing_map: HashMap<String, TaskUnitProgress> = existing_units
        .into_iter()
        .map(|u| (u.unit_name.clone(), u))
        .collect();

    for unit_name in unit_names {
        let unit = if let Some(existing) = existing_map.get(unit_name) {
            // å¦‚æœå·²å®Œæˆï¼Œä¿æŒåŸçŠ¶æ€
            if existing.status == TaskUnitStatus::Completed {
                existing.clone()
            } else {
                // å…¶ä»–çŠ¶æ€é‡ç½®ä¸º pending
                TaskUnitProgress {
                    status: TaskUnitStatus::Pending,
                    // ... å…¶ä»–å­—æ®µé‡ç½®
                }
            }
        } else {
            // æ–°å»ºå•å…ƒ
            TaskUnitProgress::new(/* ... */)
        };
        units.push(unit);
    }
    
    self.save_task_units(&units).await?;
    Ok(units)
}
```

---

## âœ… é˜¶æ®µäºŒ:è‡ªåŠ¨æ¨¡å¼ä¼˜åŒ– (å·²å®Œæˆ)

### å®æ–½å†…å®¹

#### 1. è‡ªåŠ¨è°ƒåº¦åŠŸèƒ½
- âœ… `execute_auto_mode` æ–¹æ³• - è‡ªåŠ¨æ‰§è¡Œæœªå®Œæˆçš„å•å…ƒ
- âœ… ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡å•å…ƒ
- âœ… è¿‡æ»¤å‡ºæœªå®Œæˆçš„å•å…ƒ (æ’é™¤ completed)
- âœ… ä½¿ç”¨ Semaphore æ§åˆ¶å¹¶å‘æ•°
- âœ… è‡ªåŠ¨å¾ªç¯æ‰§è¡Œç›´åˆ°å…¨éƒ¨å®Œæˆ

#### 2. çº¿ç¨‹æ± ç®¡ç†
- âœ… ä½¿ç”¨ Tokio Semaphore å®ç°å¹¶å‘æ§åˆ¶
- âœ… æ”¯æŒé…ç½®å¹¶å‘æ•° (thread_count)
- âœ… ä»»åŠ¡å®Œæˆåè‡ªåŠ¨é‡Šæ”¾èµ„æº
- âœ… æ”¯æŒåŠ¨æ€è°ƒæ•´å¹¶å‘æ•°

#### 3. çŠ¶æ€åŒæ­¥
- âœ… å®æ—¶æ›´æ–°ä»»åŠ¡å•å…ƒçŠ¶æ€
- âœ… åŒæ­¥åˆ°æ•°æ®åº“æŒä¹…åŒ–
- âœ… æ¨é€åˆ° ProgressMonitor
- âœ… å‰ç«¯å®æ—¶æ˜¾ç¤º

### æ ¸å¿ƒä»£ç 

#### è‡ªåŠ¨æ¨¡å¼æ‰§è¡Œ
```rust
// src-tauri/src/task_manager.rs
pub async fn execute_auto_mode<F, Fut>(
    &self,
    task_id: &str,
    concurrency: usize,
    progress_monitor: Arc<ProgressMonitor>,
    process_fn: F,
) -> Result<usize>
where
    F: Fn(String, String) -> Fut + Send + Sync + 'static,
    Fut: std::future::Future<Output = Result<()>> + Send,
{
    // 1. ä»æ•°æ®åº“åŠ è½½ä»»åŠ¡å•å…ƒ
    let units = self.load_task_units_from_db(task_id).await?;
    
    // 2. è¿‡æ»¤å‡ºæœªå®Œæˆçš„å•å…ƒ
    let pending_units: Vec<_> = units
        .into_iter()
        .filter(|u| u.status != TaskUnitStatus::Completed)
        .collect();
    
    // 3. ä½¿ç”¨ Semaphore æ§åˆ¶å¹¶å‘
    let semaphore = Arc::new(Semaphore::new(concurrency));
    
    // 4. å¹¶å‘æ‰§è¡Œæ‰€æœ‰æœªå®Œæˆçš„å•å…ƒ
    for unit in pending_units {
        let permit = semaphore.clone().acquire_owned().await?;
        
        // æ ‡è®°ä¸ºè¿è¡Œä¸­
        self.update_unit_status_with_sync(
            task_id, 
            &unit.id, 
            TaskUnitStatus::Running, 
            &progress_monitor
        ).await?;
        
        // å¼‚æ­¥æ‰§è¡Œ
        tokio::spawn(async move {
            let result = process_fn(unit.id.clone(), unit.name.clone()).await;
            
            match result {
                Ok(_) => {
                    // æ ‡è®°ä¸ºå®Œæˆ
                    self.update_unit_status_with_sync(
                        task_id, 
                        &unit.id, 
                        TaskUnitStatus::Completed, 
                        &progress_monitor
                    ).await?;
                }
                Err(e) => {
                    // æ ‡è®°ä¸ºå¤±è´¥
                    self.fail_unit_with_sync(
                        task_id, 
                        &unit.id, 
                        e.to_string(), 
                        &progress_monitor
                    ).await?;
                }
            }
            
            drop(permit); // é‡Šæ”¾ä¿¡å·é‡
        });
    }
    
    Ok(success_count)
}
```

### å·¥ä½œæµç¨‹

```
ä»»åŠ¡å¯åŠ¨ (è‡ªåŠ¨æ¨¡å¼)
    â†“
åŠ è½½ä»»åŠ¡å•å…ƒ (ä»æ•°æ®åº“)
    â†“
è¿‡æ»¤æœªå®Œæˆå•å…ƒ (status != completed)
    â†“
åˆ›å»ºçº¿ç¨‹æ±  (Semaphore)
    â†“
å¹¶å‘æ‰§è¡Œå•å…ƒ
    â”œâ”€ å•å…ƒ1: pending â†’ running â†’ completed
    â”œâ”€ å•å…ƒ2: pending â†’ running â†’ completed
    â”œâ”€ å•å…ƒ3: pending â†’ running â†’ failed
    â””â”€ ...
    â†“
æ‰€æœ‰å•å…ƒå®Œæˆ
    â†“
ä»»åŠ¡å®Œæˆ
```

---

## âœ… é˜¶æ®µä¸‰:æ‰‹åŠ¨æ¨¡å¼å®ç° (å·²å®Œæˆ)

### å®æ–½å†…å®¹

#### 1. æ‰§è¡Œé˜Ÿåˆ—è¡¨
- âœ… åˆ›å»º `task_execution_queue` è¡¨
- âœ… é˜Ÿåˆ—é¡¹åŒ…å«: id, task_id, unit_id, queue_order, added_at
- âœ… å¤–é”®å…³è”ä»»åŠ¡å’Œä»»åŠ¡å•å…ƒ
- âœ… åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢

#### 2. é˜Ÿåˆ—æ“ä½œ
- âœ… `add_to_queue` - æ·»åŠ å•å…ƒåˆ°é˜Ÿåˆ—
- âœ… `add_multiple_to_queue` - æ‰¹é‡æ·»åŠ 
- âœ… `remove_from_queue` - ä»é˜Ÿåˆ—ç§»é™¤
- âœ… `clear_queue` - æ¸…ç©ºé˜Ÿåˆ—
- âœ… `get_queue` - è·å–é˜Ÿåˆ—åˆ—è¡¨
- âœ… `update_queue_orders` - æ‰¹é‡æ›´æ–°é¡ºåº
- âœ… `get_next_queue_item` - è·å–ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œé¡¹

#### 3. æ‰‹åŠ¨æ¨¡å¼æ‰§è¡Œ
- âœ… `execute_manual_mode` æ–¹æ³•
- âœ… ä»é˜Ÿåˆ—æŒ‰é¡ºåºæ‰§è¡Œ
- âœ… è·³è¿‡å·²å®Œæˆçš„å•å…ƒ
- âœ… æ”¯æŒå¹¶å‘æ§åˆ¶
- âœ… å®æ—¶çŠ¶æ€åŒæ­¥

#### 4. API æ¥å£
- âœ… `add_to_queue` - æ·»åŠ åˆ°é˜Ÿåˆ—
- âœ… `add_multiple_to_queue` - æ‰¹é‡æ·»åŠ 
- âœ… `remove_from_queue` - ç§»é™¤
- âœ… `clear_queue` - æ¸…ç©º
- âœ… `get_queue` - è·å–é˜Ÿåˆ—
- âœ… `update_queue_orders` - æ›´æ–°é¡ºåº

### æ ¸å¿ƒä»£ç 

#### é˜Ÿåˆ—è¡¨ç»“æ„
```sql
CREATE TABLE task_execution_queue (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    unit_id TEXT NOT NULL,
    queue_order INTEGER NOT NULL,
    added_at INTEGER NOT NULL,
    FOREIGN KEY (task_id) REFERENCES sync_tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (unit_id) REFERENCES task_unit_progress(id) ON DELETE CASCADE
);

CREATE INDEX idx_task_execution_queue_task_id ON task_execution_queue(task_id);
CREATE INDEX idx_task_execution_queue_order ON task_execution_queue(task_id, queue_order);
```

#### æ‰‹åŠ¨æ¨¡å¼æ‰§è¡Œ
```rust
// src-tauri/src/task_manager.rs
pub async fn execute_manual_mode<F, Fut>(
    &self,
    task_id: &str,
    concurrency: usize,
    progress_monitor: Arc<ProgressMonitor>,
    process_fn: F,
) -> Result<usize>
where
    F: Fn(String, String) -> Fut + Send + Sync + 'static,
    Fut: std::future::Future<Output = Result<()>> + Send,
{
    // 1. è·å–æ‰§è¡Œé˜Ÿåˆ—
    let queue = storage.get_queue(task_id).await?;
    
    // 2. æŒ‰é˜Ÿåˆ—é¡ºåºæ‰§è¡Œ
    for queue_item in queue {
        let unit = storage.load_task_unit(&queue_item.unit_id).await?;
        
        if let Some(unit) = unit {
            // è·³è¿‡å·²å®Œæˆçš„å•å…ƒ
            if unit.status == TaskUnitStatus::Completed {
                continue;
            }
            
            // æ‰§è¡Œå•å…ƒ
            // ...
        }
    }
    
    Ok(success_count)
}
```

### å·¥ä½œæµç¨‹

```
æ‰‹åŠ¨æ¨¡å¼å¯åŠ¨
    â†“
ç”¨æˆ·é€‰æ‹©è¦æ‰§è¡Œçš„å•å…ƒ
    â†“
æ·»åŠ åˆ°æ‰§è¡Œé˜Ÿåˆ— (add_to_queue)
    â†“
å¯é€‰: æ‹–æ‹½è°ƒæ•´é¡ºåº (update_queue_orders)
    â†“
å¼€å§‹æ‰§è¡Œ
    â†“
æŒ‰é˜Ÿåˆ—é¡ºåºæ‰§è¡Œ
    â”œâ”€ é˜Ÿåˆ—é¡¹1 â†’ å•å…ƒA: pending â†’ running â†’ completed
    â”œâ”€ é˜Ÿåˆ—é¡¹2 â†’ å•å…ƒB: pending â†’ running â†’ completed
    â””â”€ ...
    â†“
é˜Ÿåˆ—æ‰§è¡Œå®Œæˆ
```

---

## ğŸ”„ é˜¶æ®µå››:å‰ç«¯ç•Œé¢å®ç° (å¾…å®æ–½)

### è®¡åˆ’å†…å®¹

#### 1. é˜Ÿåˆ—ç®¡ç†ç»„ä»¶
- â³ åˆ›å»º `QueueManager.vue` ç»„ä»¶
- â³ å¾…é€‰æ‹©åˆ—è¡¨ (æœªåœ¨é˜Ÿåˆ—ä¸­çš„å•å…ƒ)
- â³ æ‰§è¡Œé˜Ÿåˆ—åˆ—è¡¨ (å·²æ·»åŠ çš„å•å…ƒ)
- â³ æ·»åŠ /ç§»é™¤æŒ‰é’®

#### 2. æ‹–æ‹½æ’åº
- â³ ä½¿ç”¨ Vue Draggable æˆ–ç±»ä¼¼åº“
- â³ æ‹–æ‹½è°ƒæ•´é˜Ÿåˆ—é¡ºåº
- â³ å®æ—¶æ›´æ–°åˆ°åç«¯

#### 3. æ¨¡å¼åˆ‡æ¢
- â³ æ·»åŠ æ¨¡å¼åˆ‡æ¢æŒ‰é’®
- â³ åˆ‡æ¢æ—¶æœºæ§åˆ¶
- â³ ç­‰å¾…å½“å‰æ‰§è¡Œå®Œæˆ
- â³ æ¸…ç©º/é‡å»ºé˜Ÿåˆ—
- â³ å‰ç«¯æç¤º

#### 4. TaskControl æ‰©å±•
- â³ æ·»åŠ æ¨¡å¼é€‰æ‹©å™¨
- â³ æ˜¾ç¤ºå½“å‰æ¨¡å¼
- â³ æ¨¡å¼åˆ‡æ¢æç¤º

---

## ğŸ“Š ä¸‰ä¸ªé˜¶æ®µå®Œæˆæ€»ç»“

### è®¡åˆ’å†…å®¹

#### 1. æ‰§è¡Œé˜Ÿåˆ—ç®¡ç†
- â³ åˆ›å»º `task_execution_queue` è¡¨
- â³ å®ç°é˜Ÿåˆ— CRUD æ“ä½œ
- â³ æ”¯æŒæ‹–æ‹½è°ƒæ•´é¡ºåº

#### 2. å‰ç«¯ç•Œé¢
- â³ å¾…é€‰æ‹©åˆ—è¡¨
- â³ æ‰§è¡Œé˜Ÿåˆ—åˆ—è¡¨
- â³ æ‹–æ‹½æ’åºåŠŸèƒ½
- â³ æ·»åŠ /ç§»é™¤æŒ‰é’®

#### 3. æ¨¡å¼åˆ‡æ¢
- â³ åˆ‡æ¢æ—¶æœºæ§åˆ¶
- â³ ç­‰å¾…å½“å‰æ‰§è¡Œå®Œæˆ
- â³ æ¸…ç©º/é‡å»ºé˜Ÿåˆ—
- â³ å‰ç«¯æç¤º

---

## ğŸ“Š ä¸‰ä¸ªé˜¶æ®µå®Œæˆæ€»ç»“

### âœ… å·²å®Œæˆçš„æ‰€æœ‰åŠŸèƒ½

#### é˜¶æ®µä¸€:æ–­ç‚¹ç»­ä¼ åŸºç¡€ âœ…
- æ•°æ®åº“æŒä¹…åŒ–
- ä»»åŠ¡å•å…ƒç®¡ç†
- æ–­ç‚¹ç»­ä¼ é€»è¾‘
- å®æ—¶çŠ¶æ€åŒæ­¥
- å‰ç«¯å±•ç¤º

#### é˜¶æ®µäºŒ:è‡ªåŠ¨æ¨¡å¼ âœ…
- è‡ªåŠ¨è°ƒåº¦åŠŸèƒ½
- çº¿ç¨‹æ± ç®¡ç†
- å¹¶å‘æ§åˆ¶
- å¤±è´¥å¤„ç†

#### é˜¶æ®µä¸‰:æ‰‹åŠ¨æ¨¡å¼ âœ…
- æ‰§è¡Œé˜Ÿåˆ—ç®¡ç†
- é˜Ÿåˆ— CRUD æ“ä½œ
- æ‰‹åŠ¨æ¨¡å¼æ‰§è¡Œ
- é˜Ÿåˆ—é¡ºåºæ§åˆ¶

### ğŸ“ˆ ä»£ç ç»Ÿè®¡

**æ–°å»ºæ–‡ä»¶**: 3ä¸ª
- `src-tauri/src/storage/task_unit_ops.rs` (280è¡Œ)
- `src-tauri/src/storage/queue_ops.rs` (240è¡Œ)
- `docs/ä»»åŠ¡åˆ›å»ºæµç¨‹è¯´æ˜.md` (æ–‡æ¡£)

**ä¿®æ”¹æ–‡ä»¶**: 13ä¸ª
- åç«¯ Rust: 8ä¸ªæ–‡ä»¶
- å‰ç«¯ TypeScript/Vue: 5ä¸ªæ–‡ä»¶

**æ€»ä»£ç é‡**: çº¦ 1200+ è¡Œ

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§æ€»ç»“

1. **æ–­ç‚¹ç»­ä¼ **: 
   - ä»¥è¡¨/ç´¢å¼•ä¸ºå•ä½
   - å·²å®Œæˆçš„ä¸é‡å¤æ‰§è¡Œ
   - æ•°æ®åº“æŒä¹…åŒ–ä¿è¯

2. **è‡ªåŠ¨æ¨¡å¼**:
   - è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æœªå®Œæˆå•å…ƒ
   - æ”¯æŒé«˜å¹¶å‘
   - è‡ªåŠ¨å¾ªç¯ç›´åˆ°å®Œæˆ

3. **æ‰‹åŠ¨æ¨¡å¼**:
   - ç”¨æˆ·é€‰æ‹©æ‰§è¡Œå•å…ƒ
   - æ”¯æŒé˜Ÿåˆ—æ’åº
   - æŒ‰é¡ºåºæ‰§è¡Œ

4. **å®æ—¶åŒæ­¥**:
   - å†…å­˜ â†’ æ•°æ®åº“ â†’ å‰ç«¯
   - çŠ¶æ€å˜åŒ–å®æ—¶æ¨é€
   - è¿›åº¦å®æ—¶æ›´æ–°

5. **é«˜æ€§èƒ½**:
   - Tokio å¼‚æ­¥è¿è¡Œæ—¶
   - Semaphore å¹¶å‘æ§åˆ¶
   - SQLite äº‹åŠ¡ä¿è¯

### ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„

```sql
-- åŒæ­¥ä»»åŠ¡è¡¨ (æ‰©å±•)
ALTER TABLE sync_tasks ADD COLUMN sync_mode TEXT NOT NULL DEFAULT 'auto';

-- ä»»åŠ¡å•å…ƒè¿›åº¦è¡¨
CREATE TABLE task_unit_progress (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    unit_name TEXT NOT NULL,
    unit_type TEXT NOT NULL,
    status TEXT NOT NULL,
    total_records INTEGER DEFAULT 0,
    processed_records INTEGER DEFAULT 0,
    last_processed_id TEXT,
    error_message TEXT,
    started_at INTEGER,
    completed_at INTEGER,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (task_id) REFERENCES sync_tasks(id) ON DELETE CASCADE
);

-- ä»»åŠ¡æ‰§è¡Œé˜Ÿåˆ—è¡¨
CREATE TABLE task_execution_queue (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    unit_id TEXT NOT NULL,
    queue_order INTEGER NOT NULL,
    added_at INTEGER NOT NULL,
    FOREIGN KEY (task_id) REFERENCES sync_tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (unit_id) REFERENCES task_unit_progress(id) ON DELETE CASCADE
);
```

### ğŸ”Œ API æ¥å£æ€»è§ˆ

**ä»»åŠ¡å•å…ƒç®¡ç†**:
- `get_task_units(task_id)` - è·å–ä»»åŠ¡å•å…ƒåˆ—è¡¨
- `get_task_unit(unit_id)` - è·å–å•ä¸ªä»»åŠ¡å•å…ƒ

**é˜Ÿåˆ—ç®¡ç†**:
- `add_to_queue(task_id, unit_id)` - æ·»åŠ åˆ°é˜Ÿåˆ—
- `add_multiple_to_queue(task_id, unit_ids)` - æ‰¹é‡æ·»åŠ 
- `remove_from_queue(queue_item_id)` - ä»é˜Ÿåˆ—ç§»é™¤
- `clear_queue(task_id)` - æ¸…ç©ºé˜Ÿåˆ—
- `get_queue(task_id)` - è·å–é˜Ÿåˆ—
- `update_queue_orders(updates)` - æ›´æ–°é¡ºåº

### ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹å¯¹æ¯”

#### è‡ªåŠ¨æ¨¡å¼
```
å¯åŠ¨ä»»åŠ¡
    â†“
åŠ è½½æ‰€æœ‰æœªå®Œæˆå•å…ƒ
    â†“
è‡ªåŠ¨å¹¶å‘æ‰§è¡Œ
    â”œâ”€ å•å…ƒ1: pending â†’ running â†’ completed
    â”œâ”€ å•å…ƒ2: pending â†’ running â†’ completed
    â””â”€ ...
    â†“
å…¨éƒ¨å®Œæˆ
```

#### æ‰‹åŠ¨æ¨¡å¼
```
å¯åŠ¨ä»»åŠ¡
    â†“
ç”¨æˆ·é€‰æ‹©å•å…ƒ â†’ æ·»åŠ åˆ°é˜Ÿåˆ—
    â†“
å¯é€‰: è°ƒæ•´é˜Ÿåˆ—é¡ºåº
    â†“
æŒ‰é˜Ÿåˆ—é¡ºåºæ‰§è¡Œ
    â”œâ”€ é˜Ÿåˆ—é¡¹1 â†’ å•å…ƒA: pending â†’ running â†’ completed
    â”œâ”€ é˜Ÿåˆ—é¡¹2 â†’ å•å…ƒB: pending â†’ running â†’ completed
    â””â”€ ...
    â†“
é˜Ÿåˆ—æ‰§è¡Œå®Œæˆ
```

### ğŸ“ ä½¿ç”¨ç¤ºä¾‹

#### è‡ªåŠ¨æ¨¡å¼
```typescript
// å‰ç«¯
await taskMonitorStore.startTask(taskId)
// åç«¯è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æœªå®Œæˆçš„å•å…ƒ
```

#### æ‰‹åŠ¨æ¨¡å¼
```typescript
// 1. è·å–æ‰€æœ‰ä»»åŠ¡å•å…ƒ
const units = await invoke('get_task_units', { taskId })

// 2. ç”¨æˆ·é€‰æ‹©è¦æ‰§è¡Œçš„å•å…ƒ
const selectedUnitIds = ['unit1', 'unit2', 'unit3']

// 3. æ·»åŠ åˆ°é˜Ÿåˆ—
await invoke('add_multiple_to_queue', { 
  taskId, 
  unitIds: selectedUnitIds 
})

// 4. å¯é€‰: è°ƒæ•´é¡ºåº
await invoke('update_queue_orders', {
  updates: [
    ['queue_item_1', 0],
    ['queue_item_2', 1],
    ['queue_item_3', 2]
  ]
})

// 5. å¯åŠ¨ä»»åŠ¡
await taskMonitorStore.startTask(taskId)
// åç«¯æŒ‰é˜Ÿåˆ—é¡ºåºæ‰§è¡Œ
```

---

## ğŸ‰ æœ€ç»ˆæˆæœ

### ä¸‰ä¸ªé˜¶æ®µå…¨éƒ¨å®Œæˆ! âœ…

**æ ¸å¿ƒåŸºç¡€è®¾æ–½**:
- âœ… æ•°æ®åº“æŒä¹…åŒ–å®Œæ•´
- âœ… ä»»åŠ¡å•å…ƒç®¡ç†å®Œæ•´
- âœ… æ–­ç‚¹ç»­ä¼ é€»è¾‘å®Œæ•´
- âœ… è‡ªåŠ¨è°ƒåº¦åŠŸèƒ½å®Œæ•´
- âœ… æ‰‹åŠ¨é˜Ÿåˆ—ç®¡ç†å®Œæ•´
- âœ… å‰åç«¯é€šä¿¡å®Œæ•´
- âœ… å®æ—¶çŠ¶æ€åŒæ­¥å®Œæ•´

**æŠ€æœ¯äº®ç‚¹**:
- Rust å¼‚æ­¥ç¼–ç¨‹ (Tokio)
- SQLite äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
- Semaphore å®ç°å¹¶å‘æ§åˆ¶
- å¤–é”®çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
- Vue 3 Composition API
- TypeScript ç±»å‹å®‰å…¨

**æ€§èƒ½ç‰¹ç‚¹**:
- æ”¯æŒé«˜å¹¶å‘ (å¯é…ç½®çº¿ç¨‹æ•°)
- æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
- å®æ—¶çŠ¶æ€æ¨é€
- æ–­ç‚¹ç»­ä¼ é›¶æ•°æ®ä¸¢å¤±
- é˜Ÿåˆ—é¡ºåºç²¾ç¡®æ§åˆ¶

### ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

**å‰ç«¯ç•Œé¢** (å¾…å®æ–½):
1. åˆ›å»ºé˜Ÿåˆ—ç®¡ç†ç»„ä»¶
2. å®ç°æ‹–æ‹½æ’åºåŠŸèƒ½
3. æ·»åŠ æ¨¡å¼åˆ‡æ¢æ§åˆ¶
4. å®Œå–„ç”¨æˆ·äº¤äº’

**å®é™…é›†æˆ** (å¾…å®æ–½):
1. åœ¨åŒæ­¥å¼•æ“ä¸­è°ƒç”¨æ‰§è¡Œæ–¹æ³•
2. å®ç°å…·ä½“çš„æ•°æ®åŒæ­¥é€»è¾‘
3. é›†æˆè¿›åº¦æ›´æ–°å›è°ƒ
4. å®Œæ•´æµ‹è¯•éªŒè¯

æ•´ä¸ªä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ ç³»ç»Ÿçš„åç«¯æ ¸å¿ƒåŠŸèƒ½å·²ç»å®Œå…¨å®ç°!
å‰ç«¯åªéœ€è¦æ·»åŠ é˜Ÿåˆ—ç®¡ç†ç•Œé¢,æ•´ä¸ªç³»ç»Ÿå°±èƒ½å®Œæ•´å·¥ä½œäº†!

### å·²å®ŒæˆåŠŸèƒ½
- âœ… æ•°æ®åº“æŒä¹…åŒ–
- âœ… ä»»åŠ¡å•å…ƒç®¡ç†
- âœ… æ–­ç‚¹ç»­ä¼ é€»è¾‘
- âœ… è‡ªåŠ¨æ¨¡å¼è°ƒåº¦
- âœ… çº¿ç¨‹æ± ç®¡ç†
- âœ… å®æ—¶çŠ¶æ€åŒæ­¥
- âœ… å‰ç«¯å±•ç¤º

### å¾…å®ŒæˆåŠŸèƒ½
- â³ æ‰‹åŠ¨æ¨¡å¼é˜Ÿåˆ—
- â³ æ¨¡å¼åˆ‡æ¢æ§åˆ¶
- â³ å¤±è´¥é‡è¯•æœºåˆ¶
- â³ å®é™…åŒæ­¥å¼•æ“é›†æˆ

### æŠ€æœ¯æ ˆ
- **åç«¯**: Rust + Tokio + SQLite + Tauri
- **å‰ç«¯**: Vue 3 + TypeScript + Naive UI
- **æ•°æ®åº“**: SQLite
- **å¹¶å‘**: Tokio Semaphore

### æ€§èƒ½ç‰¹ç‚¹
- æ”¯æŒé«˜å¹¶å‘ (å¯é…ç½®çº¿ç¨‹æ•°)
- æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
- å®æ—¶çŠ¶æ€æ¨é€
- æ–­ç‚¹ç»­ä¼ é›¶æ•°æ®ä¸¢å¤±

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨è‡ªåŠ¨æ¨¡å¼ä»»åŠ¡
```typescript
// å‰ç«¯
await taskMonitorStore.startTask(taskId)
```

### æŸ¥çœ‹ä»»åŠ¡å•å…ƒè¿›åº¦
```typescript
// å‰ç«¯
const units = await taskMonitorStore.getTaskUnits(taskId)
console.log(`æ€»è®¡: ${units.length}`)
console.log(`å®Œæˆ: ${units.filter(u => u.status === 'completed').length}`)
console.log(`è¿›è¡Œä¸­: ${units.filter(u => u.status === 'running').length}`)
```

### æ–­ç‚¹ç»­ä¼ 
```
1. ä»»åŠ¡æ‰§è¡Œä¸­æ–­ (æš‚åœ/æ–­ç½‘/å´©æºƒ)
2. æ•°æ®åº“å·²ä¿å­˜å„å•å…ƒçŠ¶æ€
3. é‡æ–°å¯åŠ¨ä»»åŠ¡
4. è‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„å•å…ƒ
5. ç»§ç»­æ‰§è¡Œæœªå®Œæˆçš„å•å…ƒ
```

---

## ğŸ‰ æˆæœ

é˜¶æ®µä¸€å’Œé˜¶æ®µäºŒå·²ç»å®Œæ•´å®ç°!

æ ¸å¿ƒåŠŸèƒ½å…¨éƒ¨å°±ç»ª:
- âœ… æ–­ç‚¹ç»­ä¼ 
- âœ… è‡ªåŠ¨è°ƒåº¦
- âœ… å¹¶å‘æ§åˆ¶
- âœ… çŠ¶æ€åŒæ­¥
- âœ… è¿›åº¦å±•ç¤º

ä¸‹ä¸€æ­¥åªéœ€è¦:
1. åœ¨å®é™…åŒæ­¥å¼•æ“ä¸­è°ƒç”¨ `execute_auto_mode`
2. å®ç°å…·ä½“çš„æ•°æ®åŒæ­¥é€»è¾‘
3. å®ç°æ‰‹åŠ¨æ¨¡å¼ (é˜¶æ®µä¸‰)

æ•´ä¸ªä»»åŠ¡è°ƒåº¦ç³»ç»Ÿçš„åŸºç¡€æ¶æ„å·²ç»éå¸¸å®Œå–„!
