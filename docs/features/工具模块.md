# å·¥å…·æ¨¡å—

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° DataTrace ç³»ç»Ÿä¸­çš„å·¥å…·æ¨¡å—ï¼ŒåŒ…æ‹¬åŠ å¯†æœåŠ¡ã€ç±»å‹æ˜ å°„å™¨ç­‰è¾…åŠ©åŠŸèƒ½ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2026-02-27  
**æŠ€æœ¯æ ˆ**: Go + Gin  
**å®ç°çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

---

## ğŸ¯ æ¦‚è¿°

å·¥å…·æ¨¡å—æä¾›äº†ç³»ç»Ÿè¿è¡Œæ‰€éœ€çš„å„ç§è¾…åŠ©åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ•°æ®åŠ å¯†ã€ç±»å‹è½¬æ¢ã€æ—¥å¿—ç®¡ç†ç­‰ã€‚

---

## ğŸ” åŠ å¯†æœåŠ¡ (CryptoService)

### åŠŸèƒ½è¯´æ˜

åŠ å¯†æœåŠ¡è´Ÿè´£ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ•°æ®æºå¯†ç ï¼‰ï¼Œä½¿ç”¨ AES-256-GCM åŠ å¯†ç®—æ³•ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **åŠ å¯†ç®—æ³•**: AES-256-GCMï¼ˆé«˜å¼ºåº¦å¯¹ç§°åŠ å¯†ï¼‰
- **å¯†é’¥ç®¡ç†**: ä»é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡è¯»å–
- **Nonce**: æ¯æ¬¡åŠ å¯†ä½¿ç”¨éšæœº nonceï¼Œç¡®ä¿ç›¸åŒæ˜æ–‡äº§ç”Ÿä¸åŒå¯†æ–‡

### æ ¸å¿ƒæ–¹æ³•

```go
type CryptoService struct {
    key []byte
}

// åˆ›å»ºæ–°çš„åŠ å¯†æœåŠ¡å®ä¾‹
func NewCryptoService(key []byte) *CryptoService

// åŠ å¯†æ˜æ–‡å­—ç¬¦ä¸²
// è¿”å› Base64 ç¼–ç çš„å¯†æ–‡
func (c *CryptoService) Encrypt(plaintext string) (string, error)

// è§£å¯†å¯†æ–‡å­—ç¬¦ä¸²
// å‚æ•°ä¸º Base64 ç¼–ç çš„å¯†æ–‡
func (c *CryptoService) Decrypt(ciphertext string) (string, error)
```

### åŠ å¯†æµç¨‹

```
1. ç”Ÿæˆéšæœº nonce (12 å­—èŠ‚)
   â†“
2. ä½¿ç”¨ AES-256-GCM åŠ å¯†æ˜æ–‡
   â†“
3. å°† nonce å’Œå¯†æ–‡åˆ†åˆ«è¿›è¡Œ Base64 ç¼–ç 
   â†“
4. æ‹¼æ¥ä¸º "nonce:ciphertext" æ ¼å¼
   â†“
5. è¿”å›åŠ å¯†ç»“æœ
```

### è§£å¯†æµç¨‹

```
1. è§£æ "nonce:ciphertext" æ ¼å¼
   â†“
2. åˆ†åˆ«å¯¹ nonce å’Œå¯†æ–‡è¿›è¡Œ Base64 è§£ç 
   â†“
3. ä½¿ç”¨ AES-256-GCM è§£å¯†
   â†“
4. è¿”å›æ˜æ–‡
```

### å®‰å…¨ç‰¹æ€§

1. **å¯†é’¥å®‰å…¨**:
   - å¯†é’¥å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡
   - å¯†é’¥é•¿åº¦ 256 ä½ï¼Œç¬¦åˆé«˜å¼ºåº¦åŠ å¯†æ ‡å‡†

2. **éšæœºæ€§**:
   - æ¯æ¬¡åŠ å¯†ä½¿ç”¨éšæœº nonce
   - ç›¸åŒæ˜æ–‡äº§ç”Ÿä¸åŒå¯†æ–‡ï¼Œé˜²æ­¢æ¨¡å¼åˆ†æ

3. **å®Œæ•´æ€§**:
   - GCM æ¨¡å¼æä¾›è®¤è¯åŠ å¯†
   - è‡ªåŠ¨æ£€æµ‹å¯†æ–‡æ˜¯å¦è¢«ç¯¡æ”¹

### Go å®ç°è¦ç‚¹

- ä½¿ç”¨ `crypto/aes` åŒ…
- ä½¿ç”¨ `crypto/cipher` åŒ…çš„ GCM æ¨¡å¼
- ä½¿ç”¨ `crypto/rand` ç”Ÿæˆéšæœº nonce
- ä½¿ç”¨ `encoding/base64` è¿›è¡Œç¼–ç 

---

## ğŸ”„ ç±»å‹æ˜ å°„å™¨ (TypeMapper)

### åŠŸèƒ½è¯´æ˜

ç±»å‹æ˜ å°„å™¨è´Ÿè´£åœ¨ MySQL å’Œ Elasticsearch ä¹‹é—´è¿›è¡Œæ•°æ®ç±»å‹è½¬æ¢ã€‚

### æ ¸å¿ƒæ–¹æ³•

```go
type TypeMapper struct{}

// å°† MySQL æ•°æ®ç±»å‹æ˜ å°„åˆ° Elasticsearch ç±»å‹
func (tm *TypeMapper) MySQLToES(mysqlType string) string

// å°† Elasticsearch æ•°æ®ç±»å‹æ˜ å°„åˆ° MySQL ç±»å‹
func (tm *TypeMapper) ESToMySQL(esType string) string

// å°†ä¸»é”®å€¼æ˜ å°„ä¸ºå­—ç¬¦ä¸²ï¼ˆç”¨äº ES çš„ _id å­—æ®µï¼‰
func (tm *TypeMapper) MapPrimaryKey(pkValue interface{}) string
```

### MySQL â†’ Elasticsearch ç±»å‹æ˜ å°„

| MySQL ç±»å‹ | ES ç±»å‹ | è¯´æ˜ |
|-----------|---------|------|
| INT, BIGINT, SMALLINT, TINYINT, MEDIUMINT | long | æ•´æ•°ç±»å‹ |
| TINYINT(1) | boolean | å¸ƒå°”å€¼ï¼ˆç‰¹æ®Šå¤„ç†ï¼‰ |
| VARCHAR, CHAR, ENUM, SET | keyword | çŸ­å­—ç¬¦ä¸² |
| TEXT, MEDIUMTEXT, LONGTEXT | text | é•¿æ–‡æœ¬ |
| DATETIME, TIMESTAMP, DATE | date | æ—¥æœŸæ—¶é—´ |
| TIME, YEAR | keyword | æ—¶é—´ç±»å‹ |
| BOOLEAN, BOOL | boolean | å¸ƒå°”å€¼ |
| FLOAT, DOUBLE, DECIMAL | double | æµ®ç‚¹æ•° |
| JSON | object | JSON å¯¹è±¡ |
| BLOB, BINARY | binary | äºŒè¿›åˆ¶æ•°æ® |
| GEOMETRY, POINT ç­‰ | geo_shape | ç©ºé—´ç±»å‹ |
| å…¶ä»– | keyword | é»˜è®¤ç±»å‹ |

### Elasticsearch â†’ MySQL ç±»å‹æ˜ å°„

| ES ç±»å‹ | MySQL ç±»å‹ | è¯´æ˜ |
|---------|-----------|------|
| long, integer, short, byte | BIGINT | æ•´æ•°ç±»å‹ |
| text | TEXT | é•¿æ–‡æœ¬ |
| keyword | VARCHAR(255) | çŸ­å­—ç¬¦ä¸² |
| date | DATETIME | æ—¥æœŸæ—¶é—´ |
| boolean | BOOLEAN | å¸ƒå°”å€¼ |
| double, float | DOUBLE | æµ®ç‚¹æ•° |
| object, nested | JSON | JSON å¯¹è±¡ |
| binary | BLOB | äºŒè¿›åˆ¶æ•°æ® |
| å…¶ä»– | VARCHAR(255) | é»˜è®¤ç±»å‹ |

### ç‰¹æ®Šå¤„ç†

1. **TINYINT(1) â†’ boolean**:
   - MySQL ä¸­ TINYINT(1) é€šå¸¸ç”¨ä½œå¸ƒå°”å€¼
   - è‡ªåŠ¨è¯†åˆ«å¹¶æ˜ å°„ä¸º ES çš„ boolean ç±»å‹

2. **å¸¦æ‹¬å·çš„ç±»å‹**:
   - è‡ªåŠ¨æå–åŸºç¡€ç±»å‹: `VARCHAR(255)` â†’ `VARCHAR`
   - å¿½ç•¥é•¿åº¦å’Œç²¾åº¦å‚æ•°

3. **ä¸»é”®å€¼è½¬æ¢**:
   - å­—ç¬¦ä¸²: ç›´æ¥è¿”å›
   - æ•°å­—: è½¬æ¢ä¸ºå­—ç¬¦ä¸²
   - å¸ƒå°”å€¼: è½¬æ¢ä¸º "true" æˆ– "false"
   - null: è¿”å›ç©ºå­—ç¬¦ä¸²

---

## ğŸ“ è¿›åº¦æ—¥å¿—ç³»ç»Ÿ (TaskLogger)

### åŠŸèƒ½è¯´æ˜

è¿›åº¦æ—¥å¿—ç³»ç»Ÿè´Ÿè´£ç®¡ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ—¥å¿—ä¿¡æ¯ï¼Œæ”¯æŒå®æ—¶æ¨é€åˆ°å‰ç«¯ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **å†…å­˜ç¼“å­˜**: æ¯ä¸ªä»»åŠ¡ä¿ç•™æœ€è¿‘ 1000 æ¡æ—¥å¿—
- **å®æ—¶æ¨é€**: é€šè¿‡ SSE æ¨é€åˆ°å‰ç«¯
- **æ—¥å¿—åˆ†ç±»**: æ”¯æŒ 4 ç§æ—¥å¿—åˆ†ç±»
- **æ—¥å¿—çº§åˆ«**: æ”¯æŒ Info, Warn, Error ä¸‰ä¸ªçº§åˆ«

### æ•°æ®ç»“æ„

```go
// æ—¥å¿—æ¡ç›®
type LogEntry struct {
    Timestamp string `json:"timestamp"` // æ—¶é—´æˆ³
    Level     string `json:"level"`     // æ—¥å¿—çº§åˆ«
    Category  string `json:"category"`  // æ—¥å¿—åˆ†ç±»
    Message   string `json:"message"`   // æ—¥å¿—æ¶ˆæ¯
}
```

### æ ¸å¿ƒæ–¹æ³•

```go
type TaskLogger struct {
    taskLogs map[string][]LogEntry
    mu       sync.RWMutex
}

// åˆ›å»ºæ–°çš„ä»»åŠ¡æ—¥å¿—ç®¡ç†å™¨
func NewTaskLogger() *TaskLogger

// æ·»åŠ æ—¥å¿—
func (tl *TaskLogger) AddLog(taskID, level, category, message string)

// è·å–ä»»åŠ¡æ—¥å¿—ï¼ˆä»å†…å­˜è¯»å–æœ€è¿‘ 1000 æ¡ï¼‰
func (tl *TaskLogger) GetLogs(taskID string) []LogEntry

// æ¸…é™¤ä»»åŠ¡æ—¥å¿—ï¼ˆä»å†…å­˜ä¸­åˆ é™¤ï¼‰
func (tl *TaskLogger) ClearLogs(taskID string)
```

### æ—¥å¿—é™åˆ¶

- æ¯ä¸ªä»»åŠ¡æœ€å¤šä¿ç•™ **1000 æ¡**æ—¥å¿—
- è¶…è¿‡é™åˆ¶æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤æœ€æ—©çš„æ—¥å¿—
- é¿å…å†…å­˜å ç”¨è¿‡å¤§

---

## ğŸ”§ å“åº”å°è£…å·¥å…·

### åŠŸèƒ½è¯´æ˜

ç»Ÿä¸€å°è£… API å“åº”æ ¼å¼ï¼Œç®€åŒ–æ§åˆ¶å™¨ä»£ç ã€‚

### å“åº”ç»“æ„

```go
// æˆåŠŸå“åº”
type Response struct {
    Code    int         `json:"code"`
    Message string      `json:"message"`
    Data    interface{} `json:"data"`
}

// åˆ†é¡µå“åº”
type PageResponse struct {
    Code     int         `json:"code"`
    Message  string      `json:"message"`
    Data     interface{} `json:"data"`
    Total    int64       `json:"total"`
    Page     int         `json:"page"`
    PageSize int         `json:"page_size"`
}
```

### å·¥å…·æ–¹æ³•

```go
// æˆåŠŸå“åº”
func Success(c *gin.Context, data interface{})

// æˆåŠŸå“åº”ï¼ˆå¸¦æ¶ˆæ¯ï¼‰
func SuccessWithMessage(c *gin.Context, message string, data interface{})

// é”™è¯¯å“åº”
func Error(c *gin.Context, code int, message string)

// åˆ†é¡µå“åº”
func PageSuccess(c *gin.Context, data interface{}, total int64, page, pageSize int)
```

---

## ğŸ” éªŒè¯å·¥å…·

### åŠŸèƒ½è¯´æ˜

æä¾›å¸¸ç”¨çš„æ•°æ®éªŒè¯åŠŸèƒ½ã€‚

### éªŒè¯æ–¹æ³•

```go
// éªŒè¯å¿…å¡«å­—æ®µ
func ValidateRequired(value string, fieldName string) error

// éªŒè¯å­—ç¬¦ä¸²é•¿åº¦
func ValidateLength(value string, min, max int, fieldName string) error

// éªŒè¯ç«¯å£å·
func ValidatePort(port int) error

// éªŒè¯ UUID
func ValidateUUID(id string) error
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿè®¾è®¡æ–‡æ¡£](../requirements.md) - å®Œæ•´ç³»ç»Ÿè®¾è®¡
- [æ•°æ®æºç®¡ç†](./æ•°æ®æºç®¡ç†.md) - æ•°æ®æºç®¡ç†åŠŸèƒ½
- [æ—¥å¿—åˆ†ç±»ç³»ç»Ÿ](./æ—¥å¿—åˆ†ç±»ç³»ç»Ÿ.md) - æ—¥å¿—ç³»ç»Ÿè¯¦ç»†è®¾è®¡

---

**æ–‡æ¡£ç»´æŠ¤**: DataTrace å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-02-27
