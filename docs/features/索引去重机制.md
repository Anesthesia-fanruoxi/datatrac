# Elasticsearch ç´¢å¼•å»é‡æœºåˆ¶

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° DataTrace ç³»ç»Ÿé’ˆå¯¹ Elasticsearch ç´¢å¼•çš„å»é‡æœºåˆ¶ï¼Œé¿å…é‡å¤åŒæ­¥ç›¸åŒçš„ç´¢å¼•ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2026-02-27  
**æŠ€æœ¯æ ˆ**: Go + Gin + GORM  
**å®ç°çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

---

## ğŸ¯ é—®é¢˜åœºæ™¯

### åœºæ™¯ 1: è·¨ä»»åŠ¡çš„ç´¢å¼•é‡å¤

```
ç¬¬ä¸€æ¬¡åŒæ­¥ä»»åŠ¡:
- å…³é”®å­—: "user"
- åŒ¹é…åˆ°ç´¢å¼•: index-user-2024, index-user-2025
- åŒæ­¥å®Œæˆ âœ…

ç¬¬äºŒæ¬¡åŒæ­¥ä»»åŠ¡:
- å…³é”®å­—: "user-data"
- åŒ¹é…åˆ°ç´¢å¼•: index-user-2024, index-user-2025, index-user-data
- é—®é¢˜: index-user-2024 å’Œ index-user-2025 å·²ç»åŒæ­¥è¿‡äº† âŒ
- éœ€æ±‚: åªåŒæ­¥ index-user-dataï¼Œè·³è¿‡å·²åŒæ­¥çš„ç´¢å¼• âœ…
```

### åœºæ™¯ 2: å•æ¬¡ä»»åŠ¡å†…çš„ç´¢å¼•é‡å¤

```
ä¸€æ¬¡åŒæ­¥ä»»åŠ¡:
- å…³é”®å­—1: "user"  â†’ åŒ¹é…: index-user-2024, index-common
- å…³é”®å­—2: "common" â†’ åŒ¹é…: index-common, index-common-data
- å…³é”®å­—3: "data"  â†’ åŒ¹é…: index-common-data, index-data-2024

é—®é¢˜:
- index-common åœ¨å…³é”®å­—1å’Œ2ä¸­éƒ½å‡ºç°
- index-common-data åœ¨å…³é”®å­—2å’Œ3ä¸­éƒ½å‡ºç°

éœ€æ±‚:
1. å»é‡: æ¯ä¸ªç´¢å¼•åªåŒæ­¥ä¸€æ¬¡
2. æ ‡ç­¾: ä½¿ç”¨ç¬¬ä¸€æ¬¡å‡ºç°çš„å…³é”®å­—ä½œä¸ºæ ‡ç­¾
   - index-common â†’ æ ‡ç­¾: "user"
   - index-common-data â†’ æ ‡ç­¾: "common"
```

---

## ğŸ—ï¸ è§£å†³æ–¹æ¡ˆè®¾è®¡

### ä¸¤å±‚å»é‡æœºåˆ¶

**ç¬¬ä¸€å±‚: ä»»åŠ¡å†…å»é‡ï¼ˆå•æ¬¡æ‰§è¡Œï¼‰**
- æ—¶æœº: åˆ›å»ºä»»åŠ¡å•å…ƒæ—¶
- èŒƒå›´: å½“å‰ä»»åŠ¡çš„æ‰€æœ‰å…³é”®å­—
- ç­–ç•¥: ä½¿ç”¨ map å»é‡
- æ ‡ç­¾: è®°å½•ç¬¬ä¸€æ¬¡å‡ºç°çš„å…³é”®å­—

**ç¬¬äºŒå±‚: è·¨ä»»åŠ¡å»é‡ï¼ˆå†å²è®°å½•ï¼‰**
- æ—¶æœº: åˆ›å»ºä»»åŠ¡å•å…ƒæ—¶
- èŒƒå›´: æ‰€æœ‰å†å²ä»»åŠ¡
- ç­–ç•¥: æŸ¥è¯¢ synced_indices è¡¨
- é€‰é¡¹: æ”¯æŒå¼ºåˆ¶é‡æ–°åŒæ­¥

---

## ğŸ”§ æ•°æ®æ¨¡å‹è®¾è®¡

### 1. ä»»åŠ¡é…ç½®æ‰©å±•

```go
// ä»»åŠ¡é…ç½®
type TaskConfig struct {
    // åŸæœ‰å­—æ®µ
    Units      []string   `json:"units"`
    SyncConfig SyncConfig `json:"sync_config"`
    
    // æ–°å¢å­—æ®µ
    Keywords   []KeywordMapping `json:"keywords,omitempty"`   // å…³é”®å­—æ˜ å°„
    SkipSynced bool             `json:"skip_synced"`          // æ˜¯å¦è·³è¿‡å·²åŒæ­¥çš„ç´¢å¼•ï¼ˆé»˜è®¤ trueï¼‰
}

// å…³é”®å­—æ˜ å°„
type KeywordMapping struct {
    Keyword string   `json:"keyword"` // å…³é”®å­—
    Indices []string `json:"indices"` // åŒ¹é…åˆ°çš„ç´¢å¼•åˆ—è¡¨
}
```

**JSON ç¤ºä¾‹**ï¼š
```json
{
  "units": [
    "index-user-2024",
    "index-common",
    "index-common-data",
    "index-data-2024"
  ],
  "keywords": [
    {
      "keyword": "user",
      "indices": ["index-user-2024", "index-common"]
    },
    {
      "keyword": "common",
      "indices": ["index-common", "index-common-data"]
    },
    {
      "keyword": "data",
      "indices": ["index-common-data", "index-data-2024"]
    }
  ],
  "skipSynced": true,
  "syncConfig": {
    "threadCount": 4,
    "batchSize": 5000
  }
}
```

### 2. ä»»åŠ¡å•å…ƒæ‰©å±•

```go
// ä»»åŠ¡å•å…ƒé…ç½®
type TaskUnitConfig struct {
    ID        string    `gorm:"primaryKey;size:36" json:"id"`
    TaskID    string    `gorm:"size:36;not null" json:"task_id"`
    UnitName  string    `gorm:"size:200;not null" json:"unit_name"`
    UnitType  string    `gorm:"size:20;not null" json:"unit_type"`
    
    // æ–°å¢å­—æ®µ
    Keyword   string    `gorm:"size:100" json:"keyword"` // å…³è”çš„å…³é”®å­—ï¼ˆæ ‡ç­¾ï¼‰
    
    CreatedAt time.Time `json:"created_at"`
}
```

### 3. å·²åŒæ­¥ç´¢å¼•è¡¨

```sql
-- æ–°å¢è¡¨: è®°å½•å·²åŒæ­¥çš„ç´¢å¼•
CREATE TABLE `synced_indices` (
    `id` VARCHAR(36) PRIMARY KEY COMMENT 'UUIDä¸»é”®',
    `source_id` VARCHAR(36) NOT NULL COMMENT 'æ•°æ®æºID',
    `index_name` VARCHAR(200) NOT NULL COMMENT 'ç´¢å¼•åç§°',
    `first_synced_at` DATETIME NOT NULL COMMENT 'é¦–æ¬¡åŒæ­¥æ—¶é—´',
    `last_synced_at` DATETIME NOT NULL COMMENT 'æœ€ååŒæ­¥æ—¶é—´',
    `sync_count` INT DEFAULT 1 COMMENT 'åŒæ­¥æ¬¡æ•°',
    `last_task_id` VARCHAR(36) COMMENT 'æœ€ååŒæ­¥çš„ä»»åŠ¡ID',
    UNIQUE KEY `uk_source_index` (`source_id`, `index_name`),
    INDEX `idx_source_id` (`source_id`),
    INDEX `idx_index_name` (`index_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å·²åŒæ­¥ç´¢å¼•è¡¨';
```

---

## ğŸ”„ æ‰§è¡Œæµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
å‰ç«¯åˆ›å»ºä»»åŠ¡
   â”œâ”€ ç”¨æˆ·é€‰æ‹©å…³é”®å­—: ["user", "common", "data"]
   â”œâ”€ å‰ç«¯æŸ¥è¯¢ ESï¼Œè·å–æ¯ä¸ªå…³é”®å­—åŒ¹é…çš„ç´¢å¼•
   â””â”€ æ„å»º keywords æ˜ å°„
   â†“
åç«¯æ¥æ”¶ä»»åŠ¡é…ç½®
   â†“
TaskService.CreateTask()
   â†“
1. ä»»åŠ¡å†…å»é‡
   â”œâ”€ éå†æ‰€æœ‰ keywords
   â”œâ”€ ä½¿ç”¨ map[string]string è®°å½• (ç´¢å¼• â†’ å…³é”®å­—)
   â”œâ”€ å¦‚æœç´¢å¼•å·²å­˜åœ¨ï¼Œè·³è¿‡ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªå…³é”®å­—ï¼‰
   â””â”€ å¾—åˆ°å»é‡åçš„ç´¢å¼•åˆ—è¡¨
   â†“
2. è·¨ä»»åŠ¡å»é‡ï¼ˆå¦‚æœ skipSynced = trueï¼‰
   â”œâ”€ æŸ¥è¯¢ synced_indices è¡¨
   â”œâ”€ è¿‡æ»¤æ‰å·²åŒæ­¥çš„ç´¢å¼•
   â””â”€ å¾—åˆ°æœ€ç»ˆéœ€è¦åŒæ­¥çš„ç´¢å¼•åˆ—è¡¨
   â†“
3. åˆ›å»ºä»»åŠ¡å•å…ƒ
   â”œâ”€ ä¸ºæ¯ä¸ªç´¢å¼•åˆ›å»º TaskUnitConfig
   â”œâ”€ è®¾ç½® keyword å­—æ®µï¼ˆæ ‡ç­¾ï¼‰
   â””â”€ ä¿å­˜åˆ°æ•°æ®åº“ (GORM)
   â†“
4. æ‰§è¡ŒåŒæ­¥
   â”œâ”€ æ­£å¸¸æ‰§è¡ŒåŒæ­¥æµç¨‹
   â””â”€ æ¯ä¸ªå•å…ƒå®Œæˆåï¼Œè®°å½•åˆ° synced_indices
```

---

## ğŸ’» æ ¸å¿ƒå®ç°æ€è·¯

### 1. ä»»åŠ¡å†…å»é‡

**å®ç°è¦ç‚¹**:
- ä½¿ç”¨ `map[string]string` å­˜å‚¨ç´¢å¼•åˆ°å…³é”®å­—çš„æ˜ å°„
- éå†æ‰€æœ‰å…³é”®å­—æ˜ å°„ï¼Œåªä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•
- è¿”å›å»é‡åçš„ç´¢å¼•åˆ—è¡¨å’Œå¯¹åº”çš„å…³é”®å­—

### 2. è·¨ä»»åŠ¡å»é‡

**å®ç°è¦ç‚¹**:
- æŸ¥è¯¢ `synced_indices` è¡¨ï¼Œæ£€æŸ¥ç´¢å¼•æ˜¯å¦å·²åŒæ­¥
- å¦‚æœ `skipSynced` ä¸º trueï¼Œè¿‡æ»¤æ‰å·²åŒæ­¥çš„ç´¢å¼•
- å¦‚æœ `skipSynced` ä¸º falseï¼Œä¿ç•™æ‰€æœ‰ç´¢å¼•ï¼ˆå¼ºåˆ¶é‡æ–°åŒæ­¥ï¼‰

### 3. è®°å½•å·²åŒæ­¥ç´¢å¼•

**å®ç°è¦ç‚¹**:
- ä»»åŠ¡å•å…ƒå®Œæˆåï¼Œè°ƒç”¨è®°å½•æ–¹æ³•
- ä½¿ç”¨ `ON DUPLICATE KEY UPDATE` æˆ– GORM çš„ `Save` æ–¹æ³•
- æ›´æ–°åŒæ­¥æ¬¡æ•°å’Œæœ€ååŒæ­¥æ—¶é—´

---

## ğŸ“Š é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹ 1: å¯ç”¨è·¨ä»»åŠ¡å»é‡ï¼ˆé»˜è®¤ï¼‰

```json
{
  "units": [
    "index-user-2024",
    "index-common",
    "index-data-2024"
  ],
  "keywords": [
    {
      "keyword": "user",
      "indices": ["index-user-2024", "index-common"]
    },
    {
      "keyword": "data",
      "indices": ["index-common", "index-data-2024"]
    }
  ],
  "skipSynced": true,
  "syncConfig": {
    "threadCount": 3,
    "batchSize": 5000
  }
}
```

**æ‰§è¡Œç»“æœ**ï¼š
```
ä»»åŠ¡å†…å»é‡:
- index-user-2024 (keyword: "user")
- index-common (keyword: "user") â† ä¿ç•™ç¬¬ä¸€ä¸ªå…³é”®å­—
- index-data-2024 (keyword: "data")

è·¨ä»»åŠ¡å»é‡:
- æ£€æŸ¥ synced_indices è¡¨
- å‡è®¾ index-user-2024 å·²åŒæ­¥ï¼Œè·³è¿‡
- æœ€ç»ˆåŒæ­¥: index-common, index-data-2024
```

### ç¤ºä¾‹ 2: ç¦ç”¨è·¨ä»»åŠ¡å»é‡ï¼ˆå¼ºåˆ¶é‡æ–°åŒæ­¥ï¼‰

```json
{
  "units": ["index-user-2024"],
  "skipSynced": false,
  "syncConfig": {
    "threadCount": 1,
    "batchSize": 5000
  }
}
```

**æ‰§è¡Œç»“æœ**ï¼š
```
- ä¸æ£€æŸ¥ synced_indices è¡¨
- å¼ºåˆ¶é‡æ–°åŒæ­¥ index-user-2024
- æ›´æ–° synced_indices è¡¨çš„ sync_count
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å¤šå…³é”®å­—æœç´¢

```
ç”¨æˆ·æ“ä½œ:
1. è¾“å…¥å…³é”®å­—: "user", "common", "data"
2. å‰ç«¯æŸ¥è¯¢ ESï¼Œè·å–æ¯ä¸ªå…³é”®å­—çš„ç´¢å¼•åˆ—è¡¨
3. æäº¤ä»»åŠ¡é…ç½®

åç«¯å¤„ç†:
1. ä»»åŠ¡å†…å»é‡: æ¯ä¸ªç´¢å¼•åªä¿ç•™ä¸€æ¬¡
2. è·¨ä»»åŠ¡å»é‡: è·³è¿‡å·²åŒæ­¥çš„ç´¢å¼•
3. åˆ›å»ºä»»åŠ¡å•å…ƒï¼Œè®°å½•å…³é”®å­—æ ‡ç­¾
4. æ‰§è¡ŒåŒæ­¥
5. å®Œæˆåè®°å½•åˆ° synced_indices
```

### åœºæ™¯ 2: å®šæœŸåŒæ­¥

```
åœºæ™¯: æ¯å¤©åŒæ­¥æ–°å¢çš„ç´¢å¼•

ç¬¬ä¸€å¤©:
- å…³é”®å­—: "log-2024"
- åŒ¹é…: log-2024-01-01, log-2024-01-02
- åŒæ­¥å®Œæˆï¼Œè®°å½•åˆ° synced_indices

ç¬¬äºŒå¤©:
- å…³é”®å­—: "log-2024"
- åŒ¹é…: log-2024-01-01, log-2024-01-02, log-2024-01-03
- è·¨ä»»åŠ¡å»é‡: è·³è¿‡å‰ä¸¤ä¸ª
- åªåŒæ­¥: log-2024-01-03
```

### åœºæ™¯ 3: å¼ºåˆ¶é‡æ–°åŒæ­¥

```
åœºæ™¯: æ•°æ®æœ‰é—®é¢˜ï¼Œéœ€è¦é‡æ–°åŒæ­¥

æ“ä½œ:
- è®¾ç½® skipSynced = false
- æäº¤ä»»åŠ¡

ç»“æœ:
- ä¸æ£€æŸ¥ synced_indices
- å¼ºåˆ¶é‡æ–°åŒæ­¥æ‰€æœ‰ç´¢å¼•
- æ›´æ–° synced_indices çš„åŒæ­¥æ¬¡æ•°
```

---

## ğŸ” ç®¡ç†åŠŸèƒ½

### æŸ¥è¯¢å·²åŒæ­¥ç´¢å¼•

**API**: `GET /api/v1/datasources/:id/synced-indices`

**åŠŸèƒ½**: è·å–æŒ‡å®šæ•°æ®æºçš„å·²åŒæ­¥ç´¢å¼•åˆ—è¡¨

### æ¸…é™¤åŒæ­¥å†å²

**API**: `DELETE /api/v1/datasources/:id/synced-indices/:indexName`

**åŠŸèƒ½**: æ¸…é™¤æŒ‡å®šç´¢å¼•çš„åŒæ­¥å†å²

**API**: `DELETE /api/v1/datasources/:id/synced-indices`

**åŠŸèƒ½**: æ¸…é™¤æ•°æ®æºçš„æ‰€æœ‰åŒæ­¥å†å²

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ ](./ä»»åŠ¡è°ƒåº¦ä¸æ–­ç‚¹ç»­ä¼ .md) - ä»»åŠ¡è°ƒåº¦æœºåˆ¶
- [ç³»ç»Ÿè®¾è®¡æ–‡æ¡£](../requirements.md) - å®Œæ•´ç³»ç»Ÿè®¾è®¡
- [æ•°æ®åº“è®¾è®¡](../æ•°æ®åº“è®¾è®¡.md) - æ•°æ®åº“è¡¨ç»“æ„

---

**æ–‡æ¡£ç»´æŠ¤**: DataTrace å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-02-27
