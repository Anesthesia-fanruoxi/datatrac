# 日志分类系统

## 📋 文档说明

本文档详细描述 DataTrace 系统的日志分类系统设计，包括日志类型、打标签机制和前端过滤。

**文档版本**: v2.0  
**最后更新**: 2026-02-27  
**技术栈**: Go + Gin + SSE  
**实现状态**: 设计阶段

---

## 🎯 概述

日志分类系统将同步任务的日志分为 4 个类别，满足不同场景的查看需求。

**设计原则**:
- 后端打标签：日志分类在后端完成
- 前端过滤：前端根据 category 字段过滤
- 统一接口：所有同步实现使用统一的日志接口
- 清晰分类：每条日志只属于一个分类

---

## 📊 日志类型

### 1. 实时日志 (Realtime)

**用途**: 显示所有详细的同步过程信息

**内容**:
- 批次读取信息
- 批次写入信息
- 实时进度信息
- 详细操作步骤

**示例**:
```
[2026-02-27 15:30:01] 第 1 批：读取到 2500 条记录
[2026-02-27 15:30:02] 第 1 批：开始写入 2500 条记录到目标索引
[2026-02-27 15:30:03] 已同步 2500 / 10000 条记录 (25%)
[2026-02-27 15:30:04] 第 2 批：读取到 2500 条记录
```

**适用场景**:
- 开发调试
- 问题排查
- 详细监控

---

### 2. 明细日志 (Summary)

**用途**: 显示批次级别的摘要信息

**内容**:
- 批次开始信息
- 批次完成信息
- 批次统计数据

**示例**:
```
[2026-02-27 15:30:01] 批次 1/4 开始处理，本批 2500 条记录
[2026-02-27 15:30:03] 批次 1 完成，已同步: 2500 条，剩余: 3 批次
[2026-02-27 15:30:04] 批次 2/4 开始处理，本批 2500 条记录
[2026-02-27 15:30:06] 批次 2 完成，已同步: 5000 条，剩余: 2 批次
```

**适用场景**:
- 日常监控
- 进度跟踪
- 性能分析

---

### 3. 校验日志 (Verify)

**用途**: 显示数据校验结果

**内容**:
- 单个索引/表完成信息
- 数据校验结果
- 总体统计信息

**示例**:
```
[2026-02-27 15:30:10] 索引 index-a 同步完成，共同步 10000 条记录
[2026-02-27 15:30:11] ✓ 索引 index-a 数据校验通过：源 10000 条 = 目标 10000 条
[2026-02-27 15:35:20] ✓ 所有索引同步完成：成功 5/5 个索引
```

**适用场景**:
- 数据验证
- 质量检查
- 完成确认

---

### 4. 错误日志 (Error)

**用途**: 显示错误和警告信息

**内容**:
- 连接错误
- 写入失败
- 数据异常
- 警告信息

**示例**:
```
[2026-02-27 15:30:05] ⚠ 第 2 批：bulk 写入部分失败，失败 3 条
[2026-02-27 15:30:15] ✗ 索引 index-b 同步失败：连接超时
[2026-02-27 15:30:16] ⚠ 警告：目标索引已存在，将覆盖数据
```

**适用场景**:
- 错误排查
- 异常监控
- 问题定位

---

## 🏗️ 技术实现

### 后端数据结构

#### LogCategory 常量

```go
const (
    LogCategoryRealtime = "realtime"  // 实时日志
    LogCategorySummary  = "summary"   // 明细日志
    LogCategoryVerify   = "verify"    // 校验日志
    LogCategoryError    = "error"     // 错误日志
)
```

#### LogEntry 结构

```go
type LogEntry struct {
    Timestamp string `json:"timestamp"` // 时间戳
    Level     string `json:"level"`     // 日志级别 (info/warn/error)
    Category  string `json:"category"`  // 日志分类标签
    Message   string `json:"message"`   // 日志消息
}
```

### 统一日志接口

**ProgressMonitor 提供统一的日志接口**:

```go
// 添加日志
func (pm *ProgressMonitor) AddLog(taskID, level, category, message string) {
    log := LogEntry{
        Timestamp: time.Now().Format("2006-01-02 15:04:05"),
        Level:     level,
        Category:  category,
        Message:   message,
    }
    
    // 存储到内存
    pm.logs[taskID] = append(pm.logs[taskID], log)
    
    // 通过 SSE 推送到前端
    pm.pushLog(taskID, log)
}
```

### 使用示例

```go
// 实时日志
progressMonitor.AddLog(
    taskID,
    "info",
    LogCategoryRealtime,
    fmt.Sprintf("第 %d 批：读取到 %d 条记录", batchNum, len(records)),
)

// 明细日志
progressMonitor.AddLog(
    taskID,
    "info",
    LogCategorySummary,
    fmt.Sprintf("批次 %d/%d 开始处理，本批 %d 条记录", 
        batchNum, totalBatches, batchSize),
)

// 校验日志
progressMonitor.AddLog(
    taskID,
    "info",
    LogCategoryVerify,
    fmt.Sprintf("✓ 索引 %s 数据校验通过：源 %d 条 = 目标 %d 条", 
        indexName, sourceCount, targetCount),
)

// 错误日志
progressMonitor.AddLog(
    taskID,
    "error",
    LogCategoryError,
    fmt.Sprintf("✗ 索引 %s 同步失败：%s", indexName, err.Error()),
)
```

---

## 🎨 前端实现

### 日志过滤

```javascript
// 所有日志（实时日志）
const allLogs = ref([])

// 明细日志：根据 category 字段过滤
const summaryLogs = computed(() => {
  return allLogs.value.filter(log => log.category === 'summary')
})

// 校验日志：根据 category 字段过滤
const verifyLogs = computed(() => {
  return allLogs.value.filter(log => log.category === 'verify')
})

// 错误日志：根据 category 字段过滤
const errorLogs = computed(() => {
  return allLogs.value.filter(log => log.category === 'error')
})
```

### UI 展示

```html
<div class="tabs">
  <!-- 实时日志 -->
  <div class="tab-pane" id="realtime">
    <div class="log-list">
      <!-- 显示 allLogs -->
    </div>
  </div>
  
  <!-- 明细日志 -->
  <div class="tab-pane" id="summary">
    <div class="log-list">
      <!-- 显示 summaryLogs -->
    </div>
  </div>
  
  <!-- 校验日志 -->
  <div class="tab-pane" id="verify">
    <div class="log-list">
      <!-- 显示 verifyLogs -->
    </div>
  </div>
  
  <!-- 错误日志 -->
  <div class="tab-pane" id="error">
    <div class="log-list">
      <!-- 显示 errorLogs -->
    </div>
  </div>
</div>
```

---

## 📝 日志规范

### 批次处理

```go
// 批次开始（明细日志）
progressMonitor.AddLog(
    taskID,
    "info",
    LogCategorySummary,
    fmt.Sprintf("批次 %d/%d 开始处理，本批 %d 条记录", 
        batchNum, totalBatches, batchSize),
)

// 批次读取（实时日志）
progressMonitor.AddLog(
    taskID,
    "info",
    LogCategoryRealtime,
    fmt.Sprintf("第 %d 批：读取到 %d 条记录", batchNum, len(records)),
)

// 批次写入（实时日志）
progressMonitor.AddLog(
    taskID,
    "info",
    LogCategoryRealtime,
    fmt.Sprintf("第 %d 批：开始写入 %d 条记录到目标", batchNum, len(records)),
)

// 批次完成（明细日志）
progressMonitor.AddLog(
    taskID,
    "info",
    LogCategorySummary,
    fmt.Sprintf("批次 %d 完成，已同步: %d 条，剩余: %d 批次", 
        batchNum, processed, remainingBatches),
)
```

### 单元完成

```go
// 单元完成（校验日志）
progressMonitor.AddLog(
    taskID,
    "info",
    LogCategoryVerify,
    fmt.Sprintf("表 %s 同步完成，共同步 %d 条记录", tableName, totalSynced),
)

// 数据校验（校验日志）
progressMonitor.AddLog(
    taskID,
    "info",
    LogCategoryVerify,
    fmt.Sprintf("✓ 表 %s 数据校验通过：源 %d 条 = 目标 %d 条", 
        tableName, sourceCount, targetCount),
)
```

### 错误处理

```go
// 写入失败（错误日志）
progressMonitor.AddLog(
    taskID,
    "error",
    LogCategoryError,
    fmt.Sprintf("第 %d 批：写入失败，失败 %d 条", batchNum, failedCount),
)

// 单元失败（错误日志）
progressMonitor.AddLog(
    taskID,
    "error",
    LogCategoryError,
    fmt.Sprintf("✗ 表 %s 同步失败：%s", tableName, err.Error()),
)
```

---

## 🎯 设计优势

### 1. 后端打标签
- 分类逻辑在后端统一管理
- 避免前端通过消息内容判断
- 更加可靠和一致

### 2. 前端过滤
- 简单高效的过滤逻辑
- 支持多种查看模式
- 用户体验友好

### 3. 统一接口
- 所有同步实现使用相同接口
- 便于维护和扩展
- 代码风格一致

### 4. 清晰分类
- 每条日志只属于一个分类
- 避免重复和混乱
- 易于理解和使用

---

## 💡 最佳实践

### 1. 日志级别选择

| 分类 | 推荐级别 | 说明 |
|------|---------|------|
| Realtime | info | 正常信息 |
| Summary | info | 摘要信息 |
| Verify | info | 校验通过 |
| Error | error/warn | 错误和警告 |

### 2. 消息格式

- 使用清晰的描述性文字
- 包含关键数据（数量、百分比等）
- 使用符号增强可读性（✓、✗、⚠）
- 保持格式一致

### 3. 日志频率

- Realtime: 每批次
- Summary: 每批次
- Verify: 每个表/索引
- Error: 发生错误时

---

## 📚 相关文档

- [任务管理器](./任务管理器.md) - TaskManager 详细设计
- [系统设计文档](../requirements.md) - 完整系统设计

---

**文档维护**: DataTrace 开发团队  
**最后更新**: 2026-02-27
