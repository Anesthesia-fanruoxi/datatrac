# 数据源管理

## 📋 文档说明

本文档详细描述数据源管理的业务逻辑和功能设计。

**文档版本**: v2.0  
**最后更新**: 2026-02-27  
**技术栈**: Go + Gin + GORM  
**实现状态**: 设计阶段

---

## 🎯 概述

数据源管理模块负责 MySQL 和 Elasticsearch 数据源的增删改查、连接测试和密码加密存储。

**核心功能**:
- 创建数据源
- 编辑数据源
- 删除数据源
- 测试连接
- 查询数据库/表/索引

---

## 📊 数据模型

### DataSource 结构

```go
type DataSource struct {
    ID           string    `gorm:"primaryKey;size:36" json:"id"`
    Name         string    `gorm:"size:100;not null" json:"name"`
    Type         string    `gorm:"size:20;not null" json:"type"` // mysql/elasticsearch
    Host         string    `gorm:"size:255;not null" json:"host"`
    Port         int       `gorm:"not null" json:"port"`
    Username     string    `gorm:"size:100;not null" json:"username"`
    Password     string    `gorm:"size:255;not null" json:"password"` // 加密存储
    DatabaseName string    `gorm:"size:100" json:"database_name"`
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`
}
```

---

## 🔧 核心业务逻辑

### 1. 创建数据源

#### 业务流程

```
前端提交创建请求
   ↓
后端接收请求数据
   ↓
验证数据完整性
   ├─ 检查必填字段
   ├─ 验证端口范围
   └─ 验证名称唯一性
   ↓
生成 UUID
   ↓
加密密码（AES-256-GCM）
   ↓
构建 DataSource 对象
   ↓
保存到数据库 (GORM)
   ↓
返回创建的数据源（密码已解密）
```

#### 验证规则

- 名称不能为空，长度 2-50 字符
- 主机地址不能为空
- 端口号必须有效
- 用户名不能为空
- 密码不能为空
- MySQL 必须指定数据库名

---

### 2. 编辑数据源

#### 业务流程

```
前端提交编辑请求
   ↓
后端接收请求数据
   ↓
验证数据源是否存在
   ↓
验证数据完整性
   ↓
检查名称唯一性（排除自身）
   ↓
如果密码有变化，重新加密
   ↓
更新数据源对象
   ↓
保存到数据库 (GORM)
   ↓
返回更新后的数据源
```

---

### 3. 删除数据源

#### 业务流程

```
前端提交删除请求
   ↓
后端接收数据源 ID
   ↓
检查数据源是否被任务使用
   ├─ 被使用 → 返回错误
   └─ 未使用 → 继续
   ↓
从数据库删除 (GORM)
   ↓
返回成功
```

---

### 4. 测试连接

#### 业务流程

```
前端提交测试连接请求
   ↓
后端接收数据源 ID
   ↓
加载数据源信息
   ↓
解密密码
   ↓
根据类型创建连接
   ├─ MySQL: 创建 MySQL 连接
   └─ ES: 创建 ES 客户端
   ↓
执行测试查询
   ├─ MySQL: SELECT 1
   └─ ES: GET /
   ↓
返回测试结果
   ├─ 成功: 返回版本信息
   └─ 失败: 返回错误信息
```

#### MySQL 连接测试

**连接字符串格式**:
```
mysql://username:password@host:port/database
```

**测试查询**:
```sql
SELECT VERSION()
```

#### Elasticsearch 连接测试

**URL 格式**:
```
http://host:port
```

**测试请求**:
```
GET /
```

---

### 5. 查询数据库列表（MySQL）

#### 业务流程

```
前端提交查询请求
   ↓
后端接收数据源 ID
   ↓
创建 MySQL 连接
   ↓
执行查询: SHOW DATABASES
   ↓
过滤系统数据库
   ↓
返回数据库列表
```

#### 过滤规则

排除以下系统数据库:
- information_schema
- mysql
- performance_schema
- sys

---

### 6. 查询表列表（MySQL）

#### 业务流程

```
前端提交查询请求（数据源 ID + 数据库名）
   ↓
后端接收参数
   ↓
创建 MySQL 连接
   ↓
切换到指定数据库
   ↓
执行查询: SHOW TABLES
   ↓
返回表列表
```

---

### 7. 查询索引列表（ES）

#### 业务流程

```
前端提交查询请求
   ↓
后端接收数据源 ID
   ↓
创建 ES 客户端
   ↓
执行查询: GET /_cat/indices
   ↓
解析索引信息
   ↓
返回索引列表
```

#### 返回信息

```go
type IndexInfo struct {
    Name      string `json:"name"`       // 索引名称
    DocsCount int64  `json:"docs_count"` // 文档数量
    StoreSize string `json:"store_size"` // 存储大小
    Health    string `json:"health"`     // 健康状态
}
```

---

## 🔐 密码加密机制

### 加密算法
- **算法**: AES-256-GCM
- **密钥**: 从环境变量或配置文件读取
- **随机数**: 每次加密生成新的 nonce

### 加密流程

```
明文密码
   ↓
生成随机 nonce (12 字节)
   ↓
使用 AES-256-GCM 加密
   ↓
拼接 nonce + 密文
   ↓
Base64 编码
   ↓
存储到数据库
```

### 解密流程

```
从数据库读取密文
   ↓
Base64 解码
   ↓
分离 nonce 和密文
   ↓
使用 AES-256-GCM 解密
   ↓
返回明文密码
```

### Go 实现要点

- 使用 `crypto/aes` 和 `crypto/cipher` 包
- 使用 `crypto/rand` 生成随机 nonce
- 使用 `encoding/base64` 进行编码
- 密钥存储在配置文件或环境变量中

---

## 🎯 API 接口

### 数据源管理

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/v1/datasources | 创建数据源 |
| GET | /api/v1/datasources | 获取数据源列表 |
| GET | /api/v1/datasources/:id | 获取数据源详情 |
| PUT | /api/v1/datasources/:id | 更新数据源 |
| DELETE | /api/v1/datasources/:id | 删除数据源 |
| POST | /api/v1/datasources/:id/test | 测试连接 |

### 数据查询

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/datasources/:id/databases | 获取数据库列表 (MySQL) |
| GET | /api/v1/datasources/:id/tables | 获取表列表 (MySQL) |
| GET | /api/v1/datasources/:id/indices | 获取索引列表 (ES) |

---

## 📚 相关文档

- [数据库设计](../数据库设计.md) - 数据源表结构
- [系统设计文档](../requirements.md) - 完整系统设计
- [API接口设计](../architecture/API接口设计.md) - API接口规范

---

**文档维护**: DataTrace 开发团队  
**最后更新**: 2026-02-27
