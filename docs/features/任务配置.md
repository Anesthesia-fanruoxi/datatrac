# 任务配置

## 📋 文档说明

本文档详细描述任务配置向导的业务逻辑和功能设计。

**文档版本**: v2.0  
**最后更新**: 2026-02-27  
**技术栈**: Go + Gin + GORM  
**实现状态**: 设计阶段

---

## 🎯 概述

任务配置模块采用向导式界面，引导用户一步步完成同步任务的配置。

**核心功能**:
- 4 步向导式配置
- 支持 4 种同步方向
- 自动生成任务单元配置
- 配置验证和预览

---

## 🔄 配置流程

### 整体流程图

```
步骤 1: 选择数据源
   ↓
步骤 2: 选择表/索引
   ↓
步骤 3: 配置同步参数
   ↓
步骤 4: 确认并保存
   ↓
生成任务单元配置
   ↓
保存到数据库
```

---

## 📝 步骤详解

### 步骤 1: 选择数据源

#### 业务逻辑

**目的**: 选择源数据源和目标数据源

**可选组合**:
1. MySQL → Elasticsearch
2. Elasticsearch → MySQL
3. MySQL → MySQL
4. Elasticsearch → Elasticsearch

**验证规则**:
- 源数据源必选
- 目标数据源必选
- 源和目标不能是同一个数据源

**快速创建数据源**:
- 如果没有可用数据源，提供"快速创建"链接
- 打开数据源创建对话框
- 创建成功后自动选中新数据源

---

### 步骤 2: 选择表/索引

#### MySQL 表选择

**业务逻辑**:

```
加载数据库列表
   ↓
用户选择数据库
   ↓
加载该数据库的表列表
   ↓
用户选择表（支持多选）
   ↓
保存选择结果
```

**数据结构**:
```json
{
  "databases": [
    {
      "database": "db1",
      "tables": ["table1", "table2"]
    }
  ]
}
```

**UI 交互**:
- 左侧：数据库列表（可展开/折叠）
- 右侧：表列表（复选框多选）
- 支持搜索过滤
- 显示已选择数量

**验证规则**:
- 至少选择一个表

#### ES 索引选择

**业务逻辑**:

```
加载索引列表
   ↓
显示索引信息（名称、文档数、大小）
   ↓
用户筛选索引
   ├─ 按名称搜索
   ├─ 按前缀筛选
   └─ 按日期范围筛选
   ↓
用户选择索引（支持多选）
   ↓
保存选择结果
```

**数据结构**:
```json
{
  "selectedIndices": ["index1", "index2"]
}
```

**UI 交互**:
- 顶部：筛选区域
- 中部：索引列表（复选框多选）
- 底部：已选择数量和全选/取消全选按钮

**验证规则**:
- 至少选择一个索引

---

### 步骤 3: 配置同步参数

#### 配置项

1. **批次大小 (batchSize)**
   - 说明：每批次同步的记录数
   - 范围：100 - 10000
   - 默认值：2500
   - 影响：批次越大，速度越快，但内存占用越高

2. **并发数 (threadCount)**
   - 说明：并发执行的goroutine数
   - 范围：1 - 20
   - 默认值：4
   - 影响：并发越多，速度越快，但资源占用越高

3. **错误策略 (errorStrategy)**
   - 选项：
     - `skip`: 跳过错误，继续执行
     - `pause`: 遇到错误时暂停任务
   - 默认值：skip

4. **表存在策略 (tableExistsStrategy)** - 仅 MySQL 目标
   - 选项：
     - `drop`: 删除重建表
     - `truncate`: 清空表数据
     - `backup`: 备份后删除重建
   - 默认值：drop

**数据结构**:
```go
type SyncConfig struct {
    BatchSize           int    `json:"batch_size"`
    ThreadCount         int    `json:"thread_count"`
    ErrorStrategy       string `json:"error_strategy"`
    TableExistsStrategy string `json:"table_exists_strategy"`
}
```

**UI 交互**:
- 使用数字输入框（带范围限制）
- 使用单选按钮组
- 提供"恢复默认值"按钮
- 每个配置项提供说明文字

---

### 步骤 4: 确认并保存

#### 显示内容

1. 任务名称输入框
2. 数据源信息（只读）
3. 选择的表/索引列表（只读）
4. 同步参数（只读）

#### 验证规则

- 任务名称必填
- 任务名称 2-50 字符
- 任务名称不能重复

#### 保存逻辑

```
1. 验证任务名称
   ↓
2. 检查名称唯一性
   ↓
3. 构建任务配置
   ├─ 基本信息
   ├─ 数据源ID
   ├─ 配置JSON
   └─ 状态设置为 idle
   ↓
4. 保存任务 (GORM)
   ↓
5. 生成任务单元配置
   ↓
6. 显示成功提示
   ↓
7. 跳转到任务列表
```

---

## 🔧 任务单元配置生成

### 生成逻辑

**目的**: 从任务配置中提取要同步的表/索引列表，保存到 `task_unit_configs` 表

**流程**:

```
读取任务配置
   ↓
根据同步方向提取单元列表
   ├─ MySQL: databases[].tables
   └─ ES: selectedIndices
   ↓
为每个单元创建配置记录
   ├─ 生成 UUID
   ├─ 设置 unit_name
   ├─ 设置 unit_type (table/index)
   └─ 关联 task_id
   ↓
批量保存到数据库 (GORM)
```

### 单元名称格式

**MySQL 表**:
```
格式: database.table
示例: db1.users
```

**ES 索引**:
```
格式: index_name
示例: logs-2024-01
```

---

## 📊 配置数据结构

### 任务配置 JSON

```json
{
  "mysqlConfig": {
    "databases": [
      {
        "database": "db1",
        "tables": ["table1", "table2"]
      }
    ]
  },
  "esConfig": {
    "selectedIndices": ["index1", "index2"]
  },
  "syncConfig": {
    "batchSize": 2500,
    "threadCount": 4,
    "errorStrategy": "skip",
    "tableExistsStrategy": "drop"
  }
}
```

---

## 🔄 编辑任务

### 编辑流程

```
用户点击"编辑任务"
   ↓
加载任务配置
   ↓
解析配置 JSON
   ↓
填充表单数据
   ↓
进入向导（可跳转到任意步骤）
   ↓
用户修改配置
   ↓
保存更新
   ├─ 更新任务主表
   ├─ 删除旧的任务单元配置
   └─ 生成新的任务单元配置
```

### 注意事项

- 编辑任务时，如果任务正在运行，需要先停止
- 编辑后，任务单元配置会重新生成
- 已完成的运行记录会被清除

---

## 🎯 API 接口

### 任务管理

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/v1/tasks | 创建任务 |
| GET | /api/v1/tasks | 获取任务列表 |
| GET | /api/v1/tasks/:id | 获取任务详情 |
| PUT | /api/v1/tasks/:id | 更新任务 |
| DELETE | /api/v1/tasks/:id | 删除任务 |

---

## 📚 相关文档

- [数据库设计](../数据库设计.md) - 任务表和任务单元配置表
- [系统设计文档](../requirements.md) - 完整系统设计
- [数据源管理](./数据源管理.md) - 数据源查询接口

---

**文档维护**: DataTrace 开发团队  
**最后更新**: 2026-02-27
