# 同步引擎

## 📋 文档说明

本文档详细描述同步引擎的设计和四种同步方向的实现逻辑。

**文档版本**: v2.0  
**最后更新**: 2026-02-27  
**技术栈**: Go + Gin  
**实现状态**: 设计阶段

---

## 🎯 概述

同步引擎是 DataTrace 的核心模块，负责执行具体的数据同步逻辑。

**支持的同步方向**:
1. MySQL → Elasticsearch
2. Elasticsearch → MySQL
3. MySQL → MySQL
4. Elasticsearch → Elasticsearch

---

## 🏗️ 架构设计

### 模块结构

```
pipeline/
├── pipeline.go                 # 管道编排器
├── context.go                  # 管道上下文
├── source/                     # 数据源适配器
│   ├── interface.go           # Source接口定义
│   ├── mysql_source.go        # MySQL读取器
│   └── es_source.go           # ES读取器
├── transformer/                # 数据转换器
│   ├── interface.go           # Transformer接口定义
│   ├── json_transformer.go    # JSON转换核心
│   ├── field_mapper.go        # 字段映射
│   └── type_converter.go      # 类型转换
└── sink/                      # 数据写入器
    ├── interface.go           # Sink接口定义
    ├── mysql_sink.go          # MySQL写入器
    └── es_sink.go             # ES写入器

services/
├── sync_service.go            # 同步服务
└── task_service.go            # 任务服务
```

### SyncEngine 结构

```go
type SyncEngine struct {
    dataSourceService *DataSourceService
    taskManager       *TaskManager
    progressMonitor   *ProgressMonitor
    pipelineFactory   *PipelineFactory
}
```

---

## 🔄 同步流程 (基于管道)

### 通用流程

```
1. 启动同步任务 (StartSync)
   ↓
2. 加载配置 & 初始化单元 (TaskService)
   ↓
3. 组装管道 (PipelineFactory)
   ├─ 创建 Source (e.g., MySQLSource)
   ├─ 创建 Sink (e.g., ESSink)
   └─ 配置 Transformer
   ↓
4. 提交给 TaskManager 调度 (ExecuteAutoMode)
   ↓
5. 管道运行 (Pipeline.Execute)
   ├─ Source 读取批次数据
   ├─ Transformer 处理数据
   ├─ Sink 写入批次数据
   └─ ProgressMonitor 更新进度
   ↓
6. 任务完成
```

### 核心方法

```go
type SyncEngine interface {
    // 启动同步
    StartSync(taskID string) error
    
    // 暂停同步
    PauseSync(taskID string) error
    
    // 恢复同步
    ResumeSync(taskID string) error
    
    // 停止同步
    StopSync(taskID string) error
}
```

---

## 📊 四种同步方向

### 1. Elasticsearch → Elasticsearch

#### 1.1 概述
**用途**: 在不同 ES 集群之间同步索引数据

**特点**:
- 支持索引名称转换
- 支持多个搜索条件组
- 批量重索引
- 数据校验

#### 1.2 同步流程
```
1. 获取源和目标 ES 客户端
   ↓
2. TaskManager 自动模式执行
   ↓
3. 为每个索引执行同步
   ├─ 获取索引总文档数
   ├─ 计算批次数
   ├─ 循环处理每个批次
   │   ├─ 使用 scroll API 读取数据
   │   ├─ 转换文档格式
   │   ├─ 使用 bulk API 写入
   │   └─ 更新进度
   ├─ 数据校验（对比文档数）
   └─ 标记完成
   ↓
4. 所有索引完成
```

#### 1.3 关键技术点
**Scroll API**:
- 用于分页读取大量数据
- 保持搜索上下文 5 分钟
- 读取完成后清理 scroll

**Bulk API**:
- 批量写入文档
- 提高写入性能
- 处理部分失败情况

**数据校验**:
- 对比源和目标文档数
- 确保数据完整性

---

### 2. MySQL → MySQL

#### 2.1 概述
**用途**: 在不同 MySQL 数据库之间同步表数据

**特点**:
- 支持数据库名称转换
- 支持表结构自动创建
- 批量数据传输
- 支持多种表存在策略

#### 2.2 同步流程
```
1. 获取源和目标 MySQL 连接池
   ↓
2. TaskManager 自动模式执行
   ↓
3. 为每个表执行同步
   ├─ 处理数据库名称转换
   ├─ 获取表结构 (SHOW CREATE TABLE)
   ├─ 在目标创建表（根据策略）
   ├─ 获取表总行数 (COUNT)
   ├─ 计算批次数
   ├─ 循环处理每个批次
   │   ├─ 使用 LIMIT OFFSET 读取数据
   │   ├─ 转换数据格式
   │   ├─ 使用 INSERT 批量写入
   │   └─ 更新进度
   ├─ 数据校验（对比行数）
   └─ 标记完成
   ↓
4. 所有表完成
```

#### 2.3 关键技术点
**表结构复制**:
- 使用 `SHOW CREATE TABLE` 获取建表语句
- 在目标数据库执行建表

**表存在策略**:
- **Drop**: 删除重建
- **Truncate**: 清空数据
- **Backup**: 备份后重建

**数据库名称转换**:
- **Prefix模式**: 替换前缀 (old_db → new_db)
- **Suffix模式**: 替换后缀 (db_old → db_new)

**批量读写**:
- 使用 `LIMIT offset, batch_size` 分批读取
- 使用批量 INSERT 提高性能

---

### 3. MySQL → Elasticsearch

#### 3.1 概述
**用途**: 将 MySQL 表数据同步到 ES 索引

**特点**:
- 自动类型映射（MySQL → ES）
- 支持批量索引
- 数据转换和清洗

#### 3.2 同步流程
```
1. 获取源 MySQL 连接池和目标 ES 客户端
   ↓
2. TaskManager 自动模式执行
   ↓
3. 为每个表执行同步
   ├─ 获取表结构
   ├─ 生成 ES mapping
   ├─ 创建 ES 索引
   ├─ 获取表总行数
   ├─ 计算批次数
   ├─ 循环处理每个批次
   │   ├─ 读取 MySQL 数据
   │   ├─ 转换为 JSON 文档
   │   ├─ 使用 bulk API 写入 ES
   │   └─ 更新进度
   ├─ 数据校验
   └─ 标记完成
   ↓
4. 所有表完成
```

#### 3.3 类型映射

| MySQL 类型 | ES 类型 |
|-----------|---------|
| INT, BIGINT | long |
| FLOAT, DOUBLE | double |
| VARCHAR, TEXT | text + keyword |
| DATE | date |
| DATETIME, TIMESTAMP | date |
| BOOLEAN | boolean |

---

### 4. Elasticsearch → MySQL

#### 4.1 概述
**用途**: 将 ES 索引数据同步到 MySQL 表

**特点**:
- 自动类型映射（ES → MySQL）
- 支持索引模式匹配
- 批量数据写入

#### 4.2 同步流程
```
1. 获取源 ES 客户端和目标 MySQL 连接池
   ↓
2. TaskManager 自动模式执行
   ↓
3. 为每个索引执行同步
   ├─ 获取索引 mapping
   ├─ 生成 MySQL 表结构
   ├─ 创建 MySQL 表
   ├─ 获取索引总文档数
   ├─ 计算批次数
   ├─ 循环处理每个批次
   │   ├─ 使用 scroll API 读取 ES 数据
   │   ├─ 转换为 MySQL 行
   │   ├─ 批量 INSERT
   │   └─ 更新进度
   ├─ 数据校验
   └─ 标记完成
   ↓
4. 所有索引完成
```

#### 4.3 类型映射

| ES 类型 | MySQL 类型 |
|---------|-----------|
| long | BIGINT |
| integer | INT |
| double | DOUBLE |
| text, keyword | VARCHAR(255) |
| date | DATETIME |
| boolean | TINYINT(1) |

---

## 🔧 通用工具函数

### MySQL 工具
- `GetTableCount`: 获取表行数
- `GetTableSchema`: 获取表结构
- `FetchBatch`: 批量读取数据
- `InsertBatch`: 批量插入数据

### ES 工具
- `GetIndexCount`: 获取索引文档数
- `GetIndexMapping`: 获取索引 mapping
- `BulkIndex`: 批量索引文档
- `ExtractDocuments`: 提取文档

---

## 📚 相关文档

- [任务管理器](./任务管理器.md) - TaskManager 设计
- [系统设计文档](../requirements.md) - 完整系统设计
- [数据库设计](../数据库设计.md) - 数据库表结构

---

**文档维护**: DataTrace 开发团队  
**最后更新**: 2026-02-27
