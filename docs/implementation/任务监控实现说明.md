# 任务监控实现说明

## 概述

任务监控功能用于实时查看任务执行进度和日志，支持任务的启动、暂停、停止操作。使用SSE（Server-Sent Events）实现实时推送。

## 文件结构

### 后端文件

1. **services/task_progress_service.go** - 任务进度服务
   - 计算任务总体进度
   - 统计已完成表数和当前表进度
   - 计算同步速度和预计剩余时间

2. **services/task_log_service.go** - 任务日志服务
   - 从任务单元运行记录生成日志
   - 支持不同级别的日志（info/success/warning/error）
   - 支持日志数量限制

3. **services/task_control_service.go** - 任务控制服务
   - 启动任务：初始化任务单元运行记录
   - 暂停任务：更新任务和单元状态
   - 停止任务：清除运行记录

4. **services/task_sse_service.go** - SSE服务（新增）
   - 管理SSE客户端连接
   - 定时推送进度和日志数据
   - 自动清理断开的连接

5. **api/task_monitor_api.go** - 任务监控API
   - GET /api/v1/tasks/:id/progress - 获取任务进度
   - GET /api/v1/tasks/:id/logs - 获取任务日志

6. **api/task_control_api.go** - 任务控制API
   - POST /api/v1/tasks/:id/start - 启动任务
   - POST /api/v1/tasks/:id/pause - 暂停任务
   - POST /api/v1/tasks/:id/stop - 停止任务

7. **api/task_sse_api.go** - SSE API（新增）
   - GET /api/v1/tasks/:id/stream - SSE流式推送

### 前端文件

8. **templates/layout/base.html** - 主布局文件
   - 集成了任务监控界面（左侧任务列表+右侧进度日志）

9. **static/css/style.css** - 样式文件
   - 任务监控页面的完整样式

10. **static/js/task-manage.js** - 任务监控页面JavaScript
    - 使用EventSource连接SSE
    - 实时接收进度和日志更新
    - 任务控制操作

## API接口

### 1. 获取任务进度（普通接口）

```
GET /api/v1/tasks/:id/progress
```

用于非运行状态的任务，手动获取进度。

### 2. 获取任务日志（普通接口）

```
GET /api/v1/tasks/:id/logs?limit=50
```

用于非运行状态的任务，手动获取日志。

### 3. SSE流式推送（新增）

```
GET /api/v1/tasks/:id/stream
```

用于运行中的任务，实时推送进度和日志。

**事件类型：**
- `progress` - 进度更新事件
- `log` - 日志更新事件

**响应格式：**
```
event: progress
data: {"task_id":"xxx","overall_progress":45.5,...}

event: log
data: [{"time":"14:30:15","level":"info","message":"..."}]
```

### 4. 任务控制API

- `POST /api/v1/tasks/:id/start` - 启动任务
- `POST /api/v1/tasks/:id/pause` - 暂停任务
- `POST /api/v1/tasks/:id/stop` - 停止任务

## 数据流程

### 1. 任务未运行

- 用户选择任务
- 前端调用普通API获取一次进度和日志
- 不建立SSE连接

### 2. 启动任务

- 用户点击"启动"按钮
- 调用 `/api/v1/tasks/:id/start` 接口
- 后端更新任务状态为 `running`
- 前端建立SSE连接到 `/api/v1/tasks/:id/stream`
- 服务器每2秒推送进度和日志

### 3. 运行中

- SSE连接保持打开
- 服务器定时推送 `progress` 和 `log` 事件
- 前端接收事件并更新UI
- 自动重连机制处理网络中断

### 4. 暂停/停止任务

- 用户点击"暂停"或"停止"按钮
- 调用相应的控制API
- 前端关闭SSE连接
- 显示最终状态

## SSE实现细节

### 后端（Go）

1. **连接管理**
   - 使用map存储每个任务的客户端连接
   - 支持多个客户端同时监控同一任务
   - 自动清理断开的连接

2. **消息推送**
   - 使用goroutine异步推送
   - 每2秒推送一次进度和日志
   - 使用channel缓冲避免阻塞

3. **响应头设置**
   ```go
   Content-Type: text/event-stream
   Cache-Control: no-cache
   Connection: keep-alive
   ```

### 前端（JavaScript）

1. **EventSource API**
   ```javascript
   const eventSource = new EventSource(url);
   eventSource.addEventListener('progress', handler);
   eventSource.addEventListener('log', handler);
   ```

2. **自动重连**
   - EventSource内置自动重连机制
   - 连接断开后自动尝试重连
   - 无需手动处理

3. **连接管理**
   - 切换任务时关闭旧连接
   - 任务停止时关闭连接
   - 页面切换时清理连接

## 优势对比

### SSE vs 轮询

| 特性 | SSE | 轮询 |
|------|-----|------|
| 实时性 | 高（服务器推送） | 低（固定间隔） |
| 资源消耗 | 低（单连接） | 高（频繁请求） |
| 服务器负载 | 低 | 高 |
| 实现复杂度 | 中 | 低 |
| 自动重连 | 内置 | 需手动实现 |

### 使用场景

- **SSE** - 任务运行中，需要实时更新
- **普通API** - 任务未运行，按需查询

## 注意事项

1. **实际同步逻辑未实现**
   - 当前只实现了状态管理和数据推送框架
   - 实际的数据同步逻辑需要在后续实现
   - 需要在同步过程中更新 `task_unit_runtimes` 表

2. **连接数限制**
   - 浏览器对同一域名的SSE连接有数量限制（通常6个）
   - 建议同时监控的任务不超过5个

3. **内存管理**
   - 服务器需要为每个连接维护goroutine
   - 及时清理断开的连接避免内存泄漏

4. **错误处理**
   - SSE连接错误会自动重连
   - 需要在服务端处理任务不存在等异常情况

## 测试步骤

1. 启动服务
2. 访问任务监控页面
3. 选择一个已配置的任务
4. 点击"启动"按钮
5. 观察浏览器控制台，应该看到：
   - "启动SSE连接"
   - "SSE连接已建立"
   - "收到进度更新"
   - "收到日志更新"
6. 测试"暂停"和"停止"功能
7. 观察SSE连接是否正确关闭

## 后续工作

1. 实现实际的数据同步引擎
2. 在同步过程中更新 `task_unit_runtimes` 表
3. 优化推送频率（根据实际情况调整）
4. 添加更详细的错误处理和重试机制
5. 实现断点续传功能
6. 考虑使用WebSocket替代SSE（如需双向通信）
